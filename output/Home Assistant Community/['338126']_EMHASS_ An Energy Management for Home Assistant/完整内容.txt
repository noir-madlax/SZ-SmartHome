============================================================
帖子标题: EMHASS: An Energy Management for Home Assistant
帖子ID: ['338126']
作者: davidusb
发帖时间: 2021-09-12T22:06:42.549Z
帖子链接: https://community.home-assistant.io/t/emhass-an-energy-management-for-home-assistant/338126
浏览数: 0
回复数: 0
爬取时间: 2025-08-15T11:23:03.087100
============================================================

【楼主帖子内容】
------------------------------
Dear community! I have created a new project called EMHASS , written in Python, to implement an optimized energy management for a household and with easy integration to Home Assistant. The main contribution of this project is that the energy management strategy is… well… optimized! I’ve done this using a real mathematical optimization technique called Linear Programming. The main use case for this project will be for someone who has installed some PV solar panels in his house and is already using Home Assistant to control (on/off) some crucial power consumption in his home. For example the water heater, the pool pump, a dispatchable dishwasher, and so on. We can also imagine that he has installed an optional battery like a PowerWall, in order to maximize the PV self-consumption. With Home Assistant he also has sensors that can measure the power produced by the PV plant, the global power consumption of the house and hopefully the power consumed by the controllable loads. Home Assistant has just released the Energy Dashboard where we can visualize all these variables in some really good looking graphics. See: https://www.home-assistant.io/blog/2021/08/04/home-energy-management/ . Now the questions are, how can we be certain of the good and optimal management of these devices? If we define a fixed schedule for our deferrable loads, is this the best solution? When we can indicate or force a charge or discharge on the battery? When should I optimally start my water heater? This is a well known academic problem for an Energy Management System. The first and most basic approach could be to define some basic rules or heuristics, this is the so called rule-based approach. The rules could be some fixed schedules for the deferrable loads, or some threshold based triggering of the battery charge/discharge, and so on. The rule-based approach has the advantage of being simple to implement and robust. However, the main disadvantage is that optimality is not guaranteed. The goal of this work is to provide an easy to implement framework where anyone using Home Assistant can apply the best and optimal set of instructions to control the energy flow in a household. When I was designing and testing this package in my own house I estimated a daily gain between 5% and 8% when using the optimized approach versus a rule-based one. In my house I have a 5 kWp PV installation with a contractual grid supply of 9 kVA. I have a grid contract with two tariffs for power consumption for the grid (peak and non-peak hours) and one tariff for the excess PV energy injected to the grid. I have no battery installed, but I suppose that the margin of gain would be even bigger with a battery, adding flexibility to the energy management. Of course the disadvantage is the initial capital cost of the battery stack. In my case the gain comes from the fact that the EMS is helping me to decide when to turn on my water heater and the pool pump. If we have a good clear sky day the results of the optimization will normally be to turn them on during the day where solar production is present. But if the day is going to be really clouded, then is possible that the best solution will be to turn them on during the non-peak tariff hours, for my case this is during the night from 9pm to 2am. All these decisions are made automatically by the EMS using forecasts of both the PV production and the house power consumption. Some other good packages and projects offer similar approaches as EMHASS. I can cite for example the good work done by my friends at the G2ELab in Grenoble, France. They have implemented the OMEGAlpes package that can also be used as an optimized EMS using LP and MILP (see: (omegalpes) [ OMEGAlpes / OMEGAlpes · GitLab ]). But here in EMHASS the first goal was to keep it simple to implement using configuration files and the second goal was that it should be easy to integrate to Home Assistant. I am sure that there will be a lot of room for optimize the code and the package implementation as this solution will be used and tested in the future. I hope that this project come as and can be used as a perfect complement for the just released Energy Management and Energy Dashboard by Home Assistant. So where to begin? If you have to Home Assistant OS or Supervised then just go for the add-on: https://github.com/davidusb-geek/emhass-add-on Or if you are using Home Assistant with other installation methods as the docker container or HA core then read the installation instructions on the core EMHASS github repository: https://github.com/davidusb-geek/emhass You will find all the needed instructions to install and use the package, but if you have any questions I will happily try to help anyone interested in this project. Leave a message on this thread or if you find any bugs open new issues on those github repositories. There is a complete documentation that can be found here: https://emhass.readthedocs.io/ And there is a separate thread presenting the add-on: https://community.home-assistant.io/t/emhass-add-on-an-energy-management-optimization-add-on-for-home-assistant-os-and-supervised/405649 If you like this work please consider buying a coffee

============================================================
【回复内容】
============================================================

【2楼】 - smi
回复时间: 2021-11-08T12:04:20.213Z
----------------------------------------
Hi, I just came over your project and it sounds very interesting. Might it be possible to create a HACS integration or an Add-On for Home Assistant out of it so it can also be used by people running on Home Assistant OS? Is it possible to use hourly variable pricing for consumption and return to grid if the prices are available for the following day? Would it be possible to set a time-frame in which a specific consumer gets turned on (like if you don’t want the pool filter to run during the night)? For heatpumps (especially for water heating), it would be cool to set an average time it takes to heat up to the desired temperature, while it should then only be turned off based on the measured temperature and not on a fixed time. Thanks
----------------------------------------

【3楼】 - davidusb
回复时间: 2021-11-08T12:50:10.466Z
----------------------------------------
Hi, thanks for the input. I will try to answer your questions. Might it be possible to create a HACS integration or an Add-On for Home Assistant out of it so it can also be used by people running on Home Assistant OS? Of course, it is the ultimate goal. I just realeased the first version to work with the bare Home Assistant Core, as this is the same version that I have been using for a long time now. But I’m completely aware that the vast majority of users use HA OS. This is in my TODO list, for now I just had the time to read the HA developers site to understand how to do this. If you or anyone can help me to port this as an add-on it could also be grat. Is it possible to use hourly variable pricing for consumption and return to grid if the prices are available for the following day? For now this is not possible but again in the TODO list. I will add support for this soon as the easy solution would be to let the user upload a CSV file with their hourly consumption and selling prices. Would it be possible to set a time-frame in which a specific consumer gets turned on (like if you don’t want the pool filter to run during the night)? There is no a direct parameter to control this. I have to think of a way to add this in the future. However, for now you can achieve this by fixing the high and low consumption periods and set a really high price to the undesired period of operation. This way the optimization will never converge to a solution on this period. For heatpumps (especially for water heating), it would be cool to set an average time it takes to heat up to the desired temperature, while it should then only be turned off based on the measured temperature and not on a fixed time. Again in the list to improve the software. This will need some sort of thermal modeling which I intent to add in the future. You could however add your own model in HA with automations on measured temperature and interact with EMHASS using only the average time. I will keep updates on future improvements.
----------------------------------------

【4楼】 - davidusb
回复时间: 2021-12-22T21:25:51.911Z
----------------------------------------
Hi, just released a new version of EMHASS where it is now possible to use hourly variable pricing for consumption and return to grid from a custom CSV file. The new version is here: emhass · PyPI
----------------------------------------

【5楼】 - DarthMob
回复时间: 2022-01-30T18:57:07.556Z
----------------------------------------
Perfect @davidusb ! Exactly what I was searching. Sadly I have to wait for HACS or Addon integration since I’m on Raspi. One more addition: I have my excess PV currently powering a 3 kW heating rod in my hot water system. To follow the PV curve I have attached a Tasmota Dimmer (Robotdyn Zero Cross) which i regulate from 0-100%. Maybe this can also be implemented in the future? Thank you! Looking forward when this hits HA
----------------------------------------

【6楼】 - davidusb
回复时间: 2022-01-30T20:37:13.428Z
----------------------------------------
Hi there. Yes the Add-on is a work in progress. For the Dimmer device it looks nice. In my case however it will not stand the rated current of my hot water rod. Otherwise, the package that I proposed is intended for optimization (planning) of the home energy. The load following using excess power from PV can be directly implemented using automations in HA. You can see my package as a higher level energy management, but still low level management strategies as the load following are needed. If I put it differently, you can automate your system to use the excess PV as you said and my package can tell you in advance (at the beginning of the day) at which times of the day you should operate your hot water rod as such in order to optimize your energy management (minimize the electricity bill for example).
----------------------------------------

【7楼】 - DarthMob
回复时间: 2022-01-31T18:58:09.208Z
----------------------------------------
nice! currently i have running: Pool Pump Electric Water Heater Heat Pump (Air) Solar Water Heater Oil Central Heating PV Power Wind Power (in Winter: Hot Water from a wood fired oven) Wallbox/Electric Car so plenty of optimization needed
----------------------------------------

【8楼】 - ahof
回复时间: 2022-02-19T11:33:30.309Z
----------------------------------------
Is there a planning for a HACS/Add-On release?
----------------------------------------

【9楼】 - davidusb
回复时间: 2022-02-19T22:17:25.478Z
----------------------------------------
Hi. I’m working on it whenever I get some spare time, so I can’t take the engagement of a release date. But it will be anytime soon in the following 3 to 4 weeks
----------------------------------------

【10楼】 - ahof
回复时间: 2022-02-20T15:54:21.484Z
----------------------------------------
Amazing looking forward. Let me know if you need testers.
----------------------------------------

【11楼】 - s_ash
回复时间: 2022-03-16T19:59:52.886Z
----------------------------------------
Hi David, i’m very exited if you would release an HACS Release. Could you provide us a little Update of the development? I’d like to test the Add-on
----------------------------------------

【12楼】 - davidusb
回复时间: 2022-03-16T21:03:22.698Z
----------------------------------------
Hi, yes just found some spare time lately. I’m working on it. Here is my repo: GitHub - davidusb-geek/emhass-add-on: The Home Assistant Add-on for EMHASS: Energy Management Optimization for Home Assistant However is totally a work in progress. I’m currently stuck on my add-on installation and using pip3 on the Dockerfile… Right now looking for a solution.
----------------------------------------

【13楼】 - davidusb
回复时间: 2022-03-26T12:04:22.904Z
----------------------------------------
Hi everyone, I just released the first version of this add-on. The add-on repository and installation instructions are here: https://github.com/davidusb-geek/emhass-add-on I am presenting this add-on on this new topic: EMHASS add-on: An energy management optimization add-on for Home Assistant OS and supervised Custom Integrations Hello everyone! This is the first release of this add-on for Home Assistant!!! The add-on repository and installation instructions are here: https://github.com/davidusb-geek/emhass-add-on This add-on implements the EMHASS module for systems using Home Assistant OS or Home Assistant Supervised. EMHASS is a Python module for Energy Management Optimization in Home Assistant. You can check the project source code here: https://github.com/davidusb-geek/emhass Feel free to test this add-on as yo… Feel free to test it and give me any feedback. If you encounter any problem you can directly open an issue on the add-on repository: Issues · davidusb-geek/emhass-add-on · GitHub Cheers!!!
----------------------------------------

【14楼】 - vdiogo
回复时间: 2022-03-26T23:14:28.229Z
----------------------------------------
Thank you for this. I get a “Invalid Add-on repository!” when adding the Github repository “ GitHub - davidusb-geek/emhass: emhass: Energy Management for Home Assistant ” Any suggestions please?
----------------------------------------

【15楼】 - davidusb
回复时间: 2022-03-27T16:33:09.921Z
----------------------------------------
Hi, yes you should be adding the add-on repository and not the emhass module repository. Add this: GitHub - davidusb-geek/emhass-add-on: The Home Assistant Add-on for EMHASS: Energy Management Optimization for Home Assistant
----------------------------------------

【16楼】 - ahof
回复时间: 2022-03-28T16:15:44.312Z
----------------------------------------
I got the error: The command ‘/bin/sh -c apt-get update &amp;&amp; apt-get install -y --no-install-recommends git &amp;&amp; pip3 install --no-cache-dir -r requirements.txt’ returned a non-zero code: 1
----------------------------------------

【17楼】 - davidusb
回复时间: 2022-03-28T16:40:21.634Z
----------------------------------------
Mmmm a quick search talked about this error when the “-y” option is missing, however this option is there in that command. What is your setup?
----------------------------------------

【18楼】 - ahof
回复时间: 2022-03-28T16:42:38.418Z
----------------------------------------
Raspberry with home assistant HAOS on raspberry 3 (32bit)
----------------------------------------

【19楼】 - davidusb
回复时间: 2022-03-28T16:46:40.661Z
----------------------------------------
Any chance of more details from your supervisor logs?
----------------------------------------

【21楼】 - ahof
回复时间: 2022-03-28T17:34:30.294Z
----------------------------------------
File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/setup.py", line 443, in &lt;module&gt; setup_package() File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/setup.py", line 435, in setup_package setup(**metadata) File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/numpy/distutils/core.py", line 171, in setup return old_setup(**new_attr) File "/usr/local/lib/python3.8/site-packages/setuptools/__init__.py", line 153, in setup return distutils.core.setup(**attrs) File "/usr/local/lib/python3.8/distutils/core.py", line 148, in setup dist.run_commands() File "/usr/local/lib/python3.8/distutils/dist.py", line 966, in run_commands self.run_command(cmd) File "/usr/local/lib/python3.8/distutils/dist.py", line 985, in run_command cmd_obj.run() File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/numpy/distutils/command/install.py", line 62, in run r = self.setuptools_run() File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/numpy/distutils/command/install.py", line 36, in setuptools_run return distutils_install.run(self) File "/usr/local/lib/python3.8/distutils/command/install.py", line 545, in run self.run_command('build') File "/usr/local/lib/python3.8/distutils/cmd.py", line 313, in run_command self.distribution.run_command(command) File "/usr/local/lib/python3.8/distutils/dist.py", line 985, in run_command cmd_obj.run() File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/numpy/distutils/command/build.py", line 47, in run old_build.run(self) File "/usr/local/lib/python3.8/distutils/command/build.py", line 135, in run self.run_command(cmd_name) File "/usr/local/lib/python3.8/distutils/cmd.py", line 313, in run_command self.distribution.run_command(command) File "/usr/local/lib/python3.8/distutils/dist.py", line 985, in run_command cmd_obj.run() File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/numpy/distutils/command/build_src.py", line 142, in run self.build_sources() File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/numpy/distutils/command/build_src.py", line 153, in build_sources self.build_library_sources(*libname_info) File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/numpy/distutils/command/build_src.py", line 286, in build_library_sources sources = self.generate_sources(sources, (lib_name, build_info)) File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/numpy/distutils/command/build_src.py", line 369, in generate_sources source = func(extension, build_dir) File "numpy/core/setup.py", line 669, in get_mathlib_info raise RuntimeError("Broken toolchain: cannot link a simple C program") RuntimeError: Broken toolchain: cannot link a simple C program [end of output] note: This error originates from a subprocess, and is likely not a problem with pip. error: legacy-install-failure × Encountered error while trying to install package. ╰─&gt; numpy note: This is an issue with the package mentioned above, not pip. hint: See above for output from the failure. [end of output] note: This error originates from a subprocess, and is likely not a problem with pip. error: subprocess-exited-with-error × pip subprocess to install build dependencies did not run successfully. │ exit code: 1 – See above for output. note: This error originates from a subprocess, and is likely not a problem with pip. Removing intermediate container 89876dbb4803
----------------------------------------

【2楼】 - smi
回复时间: 2021-11-08T12:04:20.213Z
----------------------------------------
Hi, I just came over your project and it sounds very interesting. Might it be possible to create a HACS integration or an Add-On for Home Assistant out of it so it can also be used by people running on Home Assistant OS? Is it possible to use hourly variable pricing for consumption and return to grid if the prices are available for the following day? Would it be possible to set a time-frame in which a specific consumer gets turned on (like if you don’t want the pool filter to run during the night)? For heatpumps (especially for water heating), it would be cool to set an average time it takes to heat up to the desired temperature, while it should then only be turned off based on the measured temperature and not on a fixed time. Thanks
----------------------------------------

【3楼】 - davidusb
回复时间: 2021-11-08T12:50:10.466Z
----------------------------------------
Hi, thanks for the input. I will try to answer your questions. Might it be possible to create a HACS integration or an Add-On for Home Assistant out of it so it can also be used by people running on Home Assistant OS? Of course, it is the ultimate goal. I just realeased the first version to work with the bare Home Assistant Core, as this is the same version that I have been using for a long time now. But I’m completely aware that the vast majority of users use HA OS. This is in my TODO list, for now I just had the time to read the HA developers site to understand how to do this. If you or anyone can help me to port this as an add-on it could also be grat. Is it possible to use hourly variable pricing for consumption and return to grid if the prices are available for the following day? For now this is not possible but again in the TODO list. I will add support for this soon as the easy solution would be to let the user upload a CSV file with their hourly consumption and selling prices. Would it be possible to set a time-frame in which a specific consumer gets turned on (like if you don’t want the pool filter to run during the night)? There is no a direct parameter to control this. I have to think of a way to add this in the future. However, for now you can achieve this by fixing the high and low consumption periods and set a really high price to the undesired period of operation. This way the optimization will never converge to a solution on this period. For heatpumps (especially for water heating), it would be cool to set an average time it takes to heat up to the desired temperature, while it should then only be turned off based on the measured temperature and not on a fixed time. Again in the list to improve the software. This will need some sort of thermal modeling which I intent to add in the future. You could however add your own model in HA with automations on measured temperature and interact with EMHASS using only the average time. I will keep updates on future improvements.
----------------------------------------

【4楼】 - davidusb
回复时间: 2021-12-22T21:25:51.911Z
----------------------------------------
Hi, just released a new version of EMHASS where it is now possible to use hourly variable pricing for consumption and return to grid from a custom CSV file. The new version is here: emhass · PyPI
----------------------------------------

【5楼】 - DarthMob
回复时间: 2022-01-30T18:57:07.556Z
----------------------------------------
Perfect @davidusb ! Exactly what I was searching. Sadly I have to wait for HACS or Addon integration since I’m on Raspi. One more addition: I have my excess PV currently powering a 3 kW heating rod in my hot water system. To follow the PV curve I have attached a Tasmota Dimmer (Robotdyn Zero Cross) which i regulate from 0-100%. Maybe this can also be implemented in the future? Thank you! Looking forward when this hits HA
----------------------------------------

【6楼】 - davidusb
回复时间: 2022-01-30T20:37:13.428Z
----------------------------------------
Hi there. Yes the Add-on is a work in progress. For the Dimmer device it looks nice. In my case however it will not stand the rated current of my hot water rod. Otherwise, the package that I proposed is intended for optimization (planning) of the home energy. The load following using excess power from PV can be directly implemented using automations in HA. You can see my package as a higher level energy management, but still low level management strategies as the load following are needed. If I put it differently, you can automate your system to use the excess PV as you said and my package can tell you in advance (at the beginning of the day) at which times of the day you should operate your hot water rod as such in order to optimize your energy management (minimize the electricity bill for example).
----------------------------------------

【7楼】 - DarthMob
回复时间: 2022-01-31T18:58:09.208Z
----------------------------------------
nice! currently i have running: Pool Pump Electric Water Heater Heat Pump (Air) Solar Water Heater Oil Central Heating PV Power Wind Power (in Winter: Hot Water from a wood fired oven) Wallbox/Electric Car so plenty of optimization needed
----------------------------------------

【8楼】 - ahof
回复时间: 2022-02-19T11:33:30.309Z
----------------------------------------
Is there a planning for a HACS/Add-On release?
----------------------------------------

【9楼】 - davidusb
回复时间: 2022-02-19T22:17:25.478Z
----------------------------------------
Hi. I’m working on it whenever I get some spare time, so I can’t take the engagement of a release date. But it will be anytime soon in the following 3 to 4 weeks
----------------------------------------

【10楼】 - ahof
回复时间: 2022-02-20T15:54:21.484Z
----------------------------------------
Amazing looking forward. Let me know if you need testers.
----------------------------------------

【11楼】 - s_ash
回复时间: 2022-03-16T19:59:52.886Z
----------------------------------------
Hi David, i’m very exited if you would release an HACS Release. Could you provide us a little Update of the development? I’d like to test the Add-on
----------------------------------------

【12楼】 - davidusb
回复时间: 2022-03-16T21:03:22.698Z
----------------------------------------
Hi, yes just found some spare time lately. I’m working on it. Here is my repo: GitHub - davidusb-geek/emhass-add-on: The Home Assistant Add-on for EMHASS: Energy Management Optimization for Home Assistant However is totally a work in progress. I’m currently stuck on my add-on installation and using pip3 on the Dockerfile… Right now looking for a solution.
----------------------------------------

【13楼】 - davidusb
回复时间: 2022-03-26T12:04:22.904Z
----------------------------------------
Hi everyone, I just released the first version of this add-on. The add-on repository and installation instructions are here: https://github.com/davidusb-geek/emhass-add-on I am presenting this add-on on this new topic: EMHASS add-on: An energy management optimization add-on for Home Assistant OS and supervised Custom Integrations Hello everyone! This is the first release of this add-on for Home Assistant!!! The add-on repository and installation instructions are here: https://github.com/davidusb-geek/emhass-add-on This add-on implements the EMHASS module for systems using Home Assistant OS or Home Assistant Supervised. EMHASS is a Python module for Energy Management Optimization in Home Assistant. You can check the project source code here: https://github.com/davidusb-geek/emhass Feel free to test this add-on as yo… Feel free to test it and give me any feedback. If you encounter any problem you can directly open an issue on the add-on repository: Issues · davidusb-geek/emhass-add-on · GitHub Cheers!!!
----------------------------------------

【14楼】 - vdiogo
回复时间: 2022-03-26T23:14:28.229Z
----------------------------------------
Thank you for this. I get a “Invalid Add-on repository!” when adding the Github repository “ GitHub - davidusb-geek/emhass: emhass: Energy Management for Home Assistant ” Any suggestions please?
----------------------------------------

【15楼】 - davidusb
回复时间: 2022-03-27T16:33:09.921Z
----------------------------------------
Hi, yes you should be adding the add-on repository and not the emhass module repository. Add this: GitHub - davidusb-geek/emhass-add-on: The Home Assistant Add-on for EMHASS: Energy Management Optimization for Home Assistant
----------------------------------------

【16楼】 - ahof
回复时间: 2022-03-28T16:15:44.312Z
----------------------------------------
I got the error: The command ‘/bin/sh -c apt-get update &amp;&amp; apt-get install -y --no-install-recommends git &amp;&amp; pip3 install --no-cache-dir -r requirements.txt’ returned a non-zero code: 1
----------------------------------------

【17楼】 - davidusb
回复时间: 2022-03-28T16:40:21.634Z
----------------------------------------
Mmmm a quick search talked about this error when the “-y” option is missing, however this option is there in that command. What is your setup?
----------------------------------------

【18楼】 - ahof
回复时间: 2022-03-28T16:42:38.418Z
----------------------------------------
Raspberry with home assistant HAOS on raspberry 3 (32bit)
----------------------------------------

【19楼】 - davidusb
回复时间: 2022-03-28T16:46:40.661Z
----------------------------------------
Any chance of more details from your supervisor logs?
----------------------------------------

【21楼】 - ahof
回复时间: 2022-03-28T17:34:30.294Z
----------------------------------------
File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/setup.py", line 443, in &lt;module&gt; setup_package() File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/setup.py", line 435, in setup_package setup(**metadata) File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/numpy/distutils/core.py", line 171, in setup return old_setup(**new_attr) File "/usr/local/lib/python3.8/site-packages/setuptools/__init__.py", line 153, in setup return distutils.core.setup(**attrs) File "/usr/local/lib/python3.8/distutils/core.py", line 148, in setup dist.run_commands() File "/usr/local/lib/python3.8/distutils/dist.py", line 966, in run_commands self.run_command(cmd) File "/usr/local/lib/python3.8/distutils/dist.py", line 985, in run_command cmd_obj.run() File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/numpy/distutils/command/install.py", line 62, in run r = self.setuptools_run() File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/numpy/distutils/command/install.py", line 36, in setuptools_run return distutils_install.run(self) File "/usr/local/lib/python3.8/distutils/command/install.py", line 545, in run self.run_command('build') File "/usr/local/lib/python3.8/distutils/cmd.py", line 313, in run_command self.distribution.run_command(command) File "/usr/local/lib/python3.8/distutils/dist.py", line 985, in run_command cmd_obj.run() File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/numpy/distutils/command/build.py", line 47, in run old_build.run(self) File "/usr/local/lib/python3.8/distutils/command/build.py", line 135, in run self.run_command(cmd_name) File "/usr/local/lib/python3.8/distutils/cmd.py", line 313, in run_command self.distribution.run_command(command) File "/usr/local/lib/python3.8/distutils/dist.py", line 985, in run_command cmd_obj.run() File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/numpy/distutils/command/build_src.py", line 142, in run self.build_sources() File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/numpy/distutils/command/build_src.py", line 153, in build_sources self.build_library_sources(*libname_info) File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/numpy/distutils/command/build_src.py", line 286, in build_library_sources sources = self.generate_sources(sources, (lib_name, build_info)) File "/tmp/pip-install-2gih2rmj/numpy_1441dd882a91498892b69d0ea99d79cc/numpy/distutils/command/build_src.py", line 369, in generate_sources source = func(extension, build_dir) File "numpy/core/setup.py", line 669, in get_mathlib_info raise RuntimeError("Broken toolchain: cannot link a simple C program") RuntimeError: Broken toolchain: cannot link a simple C program [end of output] note: This error originates from a subprocess, and is likely not a problem with pip. error: legacy-install-failure × Encountered error while trying to install package. ╰─&gt; numpy note: This is an issue with the package mentioned above, not pip. hint: See above for output from the failure. [end of output] note: This error originates from a subprocess, and is likely not a problem with pip. error: subprocess-exited-with-error × pip subprocess to install build dependencies did not run successfully. │ exit code: 1 – See above for output. note: This error originates from a subprocess, and is likely not a problem with pip. Removing intermediate container 89876dbb4803
----------------------------------------

【22楼】 - vdiogo
回复时间: 2022-03-28T17:42:47.024Z
----------------------------------------
Same error here: The command '/bin/sh -c apt-get update &amp;&amp; apt-get install -y --no-install-recommends git &amp;&amp; pip3 install --no-cache-dir -r requirements.txt' returned a non-zero code: 1 Running: |core-2022.3.5| |Home Assistant Supervised| On a PI4
----------------------------------------

【23楼】 - davidusb
回复时间: 2022-03-28T20:21:47.249Z
----------------------------------------
Ok, trying to solve this right now. I didn’t tested it on arm archs, just amd64 and it worked fine… I will try now to create a Dockerfile for multiple architectures, including PI4 arm’s…
----------------------------------------

【24楼】 - davidusb
回复时间: 2022-03-28T20:58:51.818Z
----------------------------------------
Right. Could you please try now? I just pushed a new version with a quick fix that will hopefully overcome that Numpy installation problem. If the problem persists I will later switch to official hass docker images for each arch.
----------------------------------------

【25楼】 - markpurcell
回复时间: 2022-03-29T06:14:03.620Z
----------------------------------------
Fantastic project and I look forward to getting things running. Version 0.1.16 loaded correctly on my odroid n2+ , which is the same hardware as HA Blue so that is a start. I am not currently on my local network, and access HA via Nabu Casa , so I presume I cannot access EMHASS, which makes control difficult outside of LAN. Interesting other Add-On’s can still access localhost, so there maybe a way around that I haven’t identifed. I have multiple inverters with multiple strings pointing in different directions, which doesn’t seem to be supported in the EMHASS configuration setup. I am also interested in the use of pvlib within EMHASS given the HA energy dashboard already has good support for solar forecasting though either the Solcast or Forecast.Solar integrations, which in my case are already setup. EMHASS assumes that the solar compensation, TOU pricing and timings are constant, but there are other cases. I have forecast and actual feed in and general tariff pricing available in 30 minute blocks vi the Amber Electric Integration. That is OK, I can make a steady state approximation as to my TOU windows and pricing, but something to consider for the future, and something that would really benefit from the LP, although I suspect the calculations may need to occur more than once a day as my forecast pricing is updated every 30 minutes. EMHASS assumes that the deferable loads needs to run for a fixed number of hours but there are other cases. My EV/ Home Battery charging time is an inverse function with its state of charge, the Power draw for EV charging can also be modulated to self consume excess solar, my Pool Heating time is a function of the temperature difference with the desired set point. My HVAC running time is a bizzare function of the temperature difference with the desired set point with an allowance for pre heating/ cooling before electricity price peak windows. So looking forward to seeing how far we can push EMHASS.
----------------------------------------

【26楼】 - browetd
回复时间: 2022-03-29T07:05:28.583Z
----------------------------------------
Great project ! I am really interested as I have to ideally maximize the usage of my solar production to minimize my electricity bill but also minimize the price for installing batteries in the future… EMHASS combined with the recording of the power consummed by some of my equipments (a total of 22), the battery simulator (battery_sim) and the energy dashboard, will allow me to meet my objectives I think.
----------------------------------------

【27楼】 - vdiogo
回复时间: 2022-03-29T07:47:04.192Z
----------------------------------------
Tried just now on 0.1.16 image 2060×578 46.8 KB but getting an error: image 1208×578 55.2 KB
----------------------------------------

【28楼】 - davidusb
回复时间: 2022-03-29T10:33:28.164Z
----------------------------------------
Hi thanks for the feedback! Version 0.1.16 loaded correctly on my odroid n2+ , which is the same hardware as HA Blue so that is a start. You will need to rebuild as I have just updated EMHASS (the module not the add-on) I am not currently on my local network, and access HA via Nabu Casa , so I presume I cannot access EMHASS, which makes control difficult outside of LAN. Interesting other Add-On’s can still access localhost, so there maybe a way around that I haven’t identifed. Ok so in version 0.1.16 (the latest) I’m using directly communication with the supervisor. So EMHASS should be able to communicate directly with your hass core instance. Have you tested the connection? I have multiple inverters with multiple strings pointing in different directions, which doesn’t seem to be supported in the EMHASS configuration setup. I am also interested in the use of pvlib within EMHASS given the HA energy dashboard already has good support for solar forecasting though either the Solcast or Forecast.Solar integrations, which in my case are already setup. Ok this is a very nice use case, I will definitely update the code in the near future to support multiple inverters. The core code is actually ready for this as everything is in lists, so you we could have a list of inverters with no problem. But I will need to work a little bit further on the add-on. For you to use PVLib inside EMHASS you will have to provide and pass the irradiance and temperature forecasts provided by whatever service you want. As you said this is already implemented in HA, so it will be nice to retrieve these forecasts directly. This is already possible using your own CSV files with my EMHASS Python module but not the Add-on. I will also update the add-on for you to be able to import directly the variables from those forecasting services you mentioned. I will work on it. EMHASS assumes that the solar compensation, TOU pricing and timings are constant, but there are other cases. I have forecast and actual feed in and general tariff pricing available in 30 minute blocks vi the Amber Electric Integration. That is OK, I can make a steady state approximation as to my TOU windows and pricing, but something to consider for the future, and something that would really benefit from the LP, although I suspect the calculations may need to occur more than once a day as my forecast pricing is updated every 30 minutes. Again this is actually already implemented in the EMHASS Python module but still not in the add-on. I was trying to figure out how to possible import variable pricings. The Amber Electric integration is just for AU users, so I will need to find a more generalized solution. How to feed a forecast variable to EMHASS? EMHASS assumes that the deferable loads needs to run for a fixed number of hours but there are other cases. My EV/ Home Battery charging time is an inverse function with its state of charge, the Power draw for EV charging can also be modulated to self consume excess solar, my Pool Heating time is a function of the temperature difference with the desired set point. My HVAC running time is a bizzare function of the temperature difference with the desired set point with an allowance for pre heating/ cooling before electricity price peak windows. There are definitely a lot of using cases to take care of. For now an answer to the EV case. You can consider adding a battery to EMHASS and fix a discharging power to zero and a target SOC to whatever SOC you want the EV to be at the end of the day.
----------------------------------------

【29楼】 - davidusb
回复时间: 2022-03-29T10:35:00.182Z
----------------------------------------
Yes, that’s exactly the goal of this package. Looking to see what it can do for you.
----------------------------------------

【30楼】 - davidusb
回复时间: 2022-03-29T10:35:30.271Z
----------------------------------------
Please post your supervisor logs to be able to see what’s the actual problem.
----------------------------------------

【31楼】 - markpurcell
回复时间: 2022-03-29T11:54:42.208Z
----------------------------------------
davidusb: I was trying to figure out how to possible import variable pricings. The Amber Electric integration is just for AU users, so I will need to find a more generalized solution. How to feed a forecast variable to EMHASS? I’m also aware of the Octopus Agile integration for UK users, which also has variable pricing. In both cases I think the generic use case is a sensor for current price, a sensor for forecast price and then attributes listing subsequent prices. A generic approach for forecast data would be useful across HA. image 1328×1217 127 KB
----------------------------------------

【32楼】 - markpurcell
回复时间: 2022-03-29T12:14:55.930Z
----------------------------------------
davidusb: I am not currently on my local network, and access HA via Nabu Casa , so I presume I cannot access EMHASS, which makes control difficult outside of LAN. Interesting other Add-On’s can still access localhost, so there maybe a way around that I haven’t identifed. Ok so in version 0.1.16 (the latest) I’m using directly communication with the supervisor. So EMHASS should be able to communicate directly with your hass ore instance. Have you tested the connection? I can start/ stop EMHASS from the Addon tab, so yes they are connected, but I cannot access the Web UI though the http://xyzz.ui.nabu.casa:5000 address, it will be a few days before I can access my LAN directly, and then I anticipate I will be able to use the http://homeassistant.local:5000 address for the Web UI. image 1451×715 63.8 KB By comparison the File Editor, Studio Code Server. Terminal &amp; SSH Addon does allow me access though the nabu.casa proxy: https://xxyyy.ui.nabu.casa/hassio/ingress/core_ssh image 1114×898 112 KB Interesting to note I can telnet to localhost port 5000 from within the Telnet &amp; SSH addon, but I presume EMHASS does not have a CLI available. It looks like these other add on’s work remotely as they bind to the hassio/ingress file system space, rather than presenting on a different port (5000 in EMHASS case).
----------------------------------------

【33楼】 - vdiogo
回复时间: 2022-03-29T13:04:35.498Z
----------------------------------------
22-03-29 14:01:37 INFO (MainThread) [supervisor.store.git] Cloning add-on https://github.com/davidusb-geek/emhass-add-on repository 22-03-29 14:01:39 WARNING (SyncWorker_5) [supervisor.addons.validate] Add-on config 'auto_uart' is deprecated, use 'uart'. Please report this to the maintainer of deCONZ 22-03-29 14:01:39 INFO (MainThread) [supervisor.store] Loading add-ons from store: 67 all - 1 new - 0 remove 22-03-29 14:01:39 INFO (MainThread) [supervisor.resolution.evaluate] Starting system evaluation with state CoreState.RUNNING 22-03-29 14:01:39 INFO (MainThread) [supervisor.resolution.evaluate] System evaluation complete 22-03-29 14:01:45 INFO (MainThread) [supervisor.addons] Creating Home Assistant add-on data folder /data/addons/data/5b918bf2_emhass 22-03-29 14:01:45 INFO (SyncWorker_3) [supervisor.docker.addon] Starting build for 5b918bf2/armv7-addon-emhass:0.1.16 22-03-29 14:01:50 ERROR (SyncWorker_3) [supervisor.docker.addon] Can't build 5b918bf2/armv7-addon-emhass:0.1.16: The command '/bin/bash -o pipefail -c apt-get update &amp;&amp; apt-get install -y --no-install-recommends libffi-dev python3 python3-pip python3-dev git build-essential &amp;&amp; pip3 install --no-cache-dir -U setuptools wheel &amp;&amp; pip3 install --no-cache-dir -r requirements.txt &amp;&amp; apt-get purge -y --auto-remove git build-essential python3-dev &amp;&amp; rm -rf /var/lib/apt/lists/*' returned a non-zero code: 100 22-03-29 14:01:50 ERROR (SyncWorker_3) [supervisor.docker.addon] Build log: Step 1/19 : ARG BUILD_FROM Step 2/19 : FROM ${BUILD_FROM} ---&gt; 4227b8cc9f8d Step 3/19 : WORKDIR /usr/src ---&gt; Using cache ---&gt; e953a1313722 Step 4/19 : COPY ./requirements.txt /usr/src/requirements.txt ---&gt; Using cache ---&gt; 81662027936f Step 5/19 : RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends libffi-dev python3 python3-pip python3-dev git build-essential &amp;&amp; pip3 install --no-cache-dir -U setuptools wheel &amp;&amp; pip3 install --no-cache-dir -r requirements.txt &amp;&amp; apt-get purge -y --auto-remove git build-essential python3-dev &amp;&amp; rm -rf /var/lib/apt/lists/* ---&gt; Running in ced58ef1a383 Get:1 http://deb.debian.org/debian bullseye InRelease [116 kB] Get:2 http://security.debian.org/debian-security bullseye-security InRelease [44.1 kB] Get:3 http://deb.debian.org/debian bullseye-updates InRelease [39.4 kB] Err:2 http://security.debian.org/debian-security bullseye-security InRelease At least one invalid signature was encountered. Err:1 http://deb.debian.org/debian bullseye InRelease At least one invalid signature was encountered. Err:3 http://deb.debian.org/debian bullseye-updates InRelease At least one invalid signature was encountered. Reading package lists... W: GPG error: http://security.debian.org/debian-security bullseye-security InRelease: At least one invalid signature was encountered. E: The repository 'http://security.debian.org/debian-security bullseye-security InRelease' is not signed. W: GPG error: http://deb.debian.org/debian bullseye InRelease: At least one invalid signature was encountered. E: The repository 'http://deb.debian.org/debian bullseye InRelease' is not signed. W: GPG error: http://deb.debian.org/debian bullseye-updates InRelease: At least one invalid signature was encountered. E: The repository 'http://deb.debian.org/debian bullseye-updates InRelease' is not signed. Removing intermediate container ced58ef1a383
----------------------------------------

【34楼】 - davidusb
回复时间: 2022-03-29T13:12:19.969Z
----------------------------------------
A generic approach for forecast will be much appreciated. For now manually feeding that data in json format could be an option, but it will be specific to each integration.
----------------------------------------

【35楼】 - davidusb
回复时间: 2022-03-29T13:16:59.304Z
----------------------------------------
Oh yes I see! The webui is bound by default to localhost (host=‘0.0.0.0’). Maybe a current solution can be to access your LAN using VPN. What I may do is let the user to choose its desired host from the configuration pane. In your case: https://xxyyy.ui.nabu.casa/
----------------------------------------

【36楼】 - davidusb
回复时间: 2022-03-29T13:23:27.507Z
----------------------------------------
vdiogo: Err:1 http://deb.debian.org/debian bullseye InRelease At least one invalid signature was encountered. Maybe related to not enough space on your system. For now it is just a guess. See: docker - At least one invalid signature was encountered - Stack Overflow Be careful applying any docker image volume or builder prune commands, as they can be destructive. But I’m not sure how can you perform this in HA OS Some hints here?: Disk almost full - #38 by WTFoX74
----------------------------------------

【37楼】 - davidusb
回复时间: 2022-03-29T13:43:48.384Z
----------------------------------------
markpurcell: EMHASS assumes that the deferable loads needs to run for a fixed number of hours but there are other cases. My EV/ Home Battery charging time is an inverse function with its state of charge, the Power draw for EV charging can also be modulated to self consume excess solar, my Pool Heating time is a function of the temperature difference with the desired set point. My HVAC running time is a bizzare function of the temperature difference with the desired set point with an allowance for pre heating/ cooling before electricity price peak windows. Just elaborating a little bit more on this. Right out the box EMHASS can be used for loads that are deferrable. This means that these loads can be “moved” around the day with “ideally” no impact on our everyday life. Good examples of these are: dishwasher, washing machine, etc. At my place I also considered as deferrable the water heater and the pool pump. For the water heater the time constant is quite slow, so as long as I respect a total number of working hours I know that I will have hot water all time regardless on the times that the water heater was on. For the pool pump is the same for me, I’m just looking to fixed total operating hours objective. I’m maybe taking a different approach with this. Of course that what you’re doing with the pool heating and the HVAC is totally valid as they need to be a function of temperatures and maybe other variables. These type of loads that are a function of other variables could be introduced and modeled in the LP formulation, as long as the relationship remains fairly linear. I may be introducing these different types of loads en the LP problem in the future. For EV’s you’ll need to test as I said using the battery option and a discharging power. I’m guessing that this can work as the SOC evolution is well implemented in the LP formulation. I may test this myself in the near future as I’m waiting for my EV to be delivered
----------------------------------------

【38楼】 - browetd
回复时间: 2022-03-30T06:21:54.235Z
----------------------------------------
Hello, I tried to add : GitHub - davidusb-geek/emhass-add-on: The Home Assistant Add-on for EMHASS: Energy Management Optimization for Home Assistant but I got the message “Invalid Add-on repository !” Any suggestions ? Updated: After a few attemps, it worked… So discard this message…
----------------------------------------

【39楼】 - markpurcell
回复时间: 2022-03-30T23:57:41.275Z
----------------------------------------
I have access to my LAN now and get an impressive set of optimization results, but not quite sure what I am looking at and how to best use the system. I presume it would be good to start simply and then build complexity into the model, that seems to work best for me with HA. Do you have a worked example for a simple model? Maybe sensors for production, excess-production, prices and a switch for one deferable load? image 1596×1267 144 KB
----------------------------------------

【40楼】 - markpurcell
回复时间: 2022-03-31T00:39:03.025Z
----------------------------------------
davidusb: A generic approach for forecast will be much appreciated. For now manually feeding that data in json format could be an option, but it will be specific to each integration. My journey for EV charging might be useful here. Level 1. Fixed time window charging 1000-1400 over solar soak window. Set EV charging rate fixed to 50% of max PV production, to allow for other household loads. Level 2. Measure excess PV production and set EV charging rate to match, updated every minute. Optimizing use of unused Solar Power to charge a Tesla - #12 by markpurcell Level 3. Sort the list of 30 minute price forecasts to find the relevant price for the cheapest fixed 2 hours daily (e.g. Car Charging) or 8 hours (e.g. Pool Pump). These 30 minute forecasts change during the day and this method constantly recalculates for the optimal solution. image 2227×622 121 KB Level 4.Based on EV/ Battery State of Charge/ Pool Temp difference and known charging rate determine how long (30 blocks) needs to be charged and then identify the relevant price. I.E. Lots of charging at low SOC and limited charging windows at high SOC.These 30 minute forecasts change during the day and this method constantly recalculates for the optimal solution. image 1558×638 104 KB
----------------------------------------

【41楼】 - davidusb
回复时间: 2022-03-31T08:27:43.517Z
----------------------------------------
Great you can see the UI. Although there are two missing buttons there, to manually launch the optimization and data publish task. I have access to my LAN now and get an impressive set of optimization results, but not quite sure what I am looking at and how to best use the system. You’re looking at the latests results stored in a csv file on the data folder inside the add-on. Each time that you launch the optimization task this csv file is rewritten and the graph and table in the UI can be refreshed. I left this initial csv there so that the user can check to what to expect when launching the optimization task. This initial csv was obtained with the default configuration presented in the configuration pane. The graph is interactive, so what you can do is use the legend turn off the visualization of all variables except the deferrable load powers. In that example we have two deferrable loads and what you’re seeing is the result of the optimization. This is giving you the optimal evolution and turn on/off times of those deferrable loads in order to maximize profit for example, depending on what objective function you choose. Everything is explained in the docs here: https://emhass.readthedocs.io/ The steps to make this work: Define all the parameters in the configuration You most notably will need to define the main data entering EMHASS. This will be the sensor_power_photovoltaics for the name of the your hass variable containing the PV produced power and the variable sensor_power_load_no_var_loads for the load power of your household excluding the power of the deferrable loads that you want to optimize. Launch the actual optimization and check the results. This can be done manually using the buttons in the web ui or with a curl command like this: curl -X POST http://localhost:5000/action/dayahead-optim If you’re good with the optimization results then you can set the optimization and data publish task commands in an automation. You can read all this in the add-on docs pane. The final step is to link the deferrable loads variables to real switchs on your installation. Read the docs for an example code for this using automations and the shell command integration. I presume it would be good to start simply and then build complexity into the model, that seems to work best for me with HA. Do you have a worked example for a simple model? Yes you’re right. The simplest example will contain just one deferrable load and no battery. A study case and a comparison of the different possible objective function definitions is presented here: https://emhass.readthedocs.io/en/latest/study_case.html Maybe sensors for production, excess-production, prices and a switch for one deferable load? Follow the steps that I wrote before. Maybe the hardest part is the load data: sensor_power_load_no_var_loads . As we want to optimize the energies, the load forecast is a naive approach using persistence, this mean that the load data variable should not contain the data from the deferrable load itself. For example lets say that you set your deferrable load to be the washing machine. The variable that you should enter in EMHASS will be: sensor_power_load_no_var_loads = sensor_power_load - sensor_power_washing_machine . This is supposing that the overall load of your house is contained in variable: sensor_power_load . This can be easily done with a new template sensor
----------------------------------------

【42楼】 - davidusb
回复时间: 2022-03-31T10:02:30.971Z
----------------------------------------
Thank you for this input. That kind of forecast data can be shipped in a json and passed to EMHASS as a data parameter. I’m working on this so that users can be able to pass this kind of data. What you’re describing is a rule-based approach to energy management. This is totally valid and based on the complexity of the rules it can be an efficient and robust approach. However, my claim with EMHASS, is that that kind of approach is by definition sub-optimal. In your case you are considering the load price forecast, so that’s great. But what about the PV power production in the future, or the house load demand, or the selling price evolution of excess PV power to the grid, the presence of a real battery like a power wall ??? All these are complex uncertainties. The goal of EMHASS is to propose an optimized approach to deal with all this complexity. In EMHASS we have basically 4 forecasts to deal with: PV power production forecast (internally based on the weather forecast and the characteristics of your PV plant) Load power forecast: how much power on 30min blocks your house will demand on the next 24h PV production selling price forecast: at what price are you selling your excess PV production on the next 24h Load cost forecast: the price of the energy from the grid on the next 24h (the data that you already have) The results of the optimization from EHMASS should help you to optimize even further your rule-based approach. This further optimization based on forecast is needed the most when your system is complex, when you have storage devices and EVs and variable costs in time. The forecast will enable us to take action in advance in order to maximize profit or maximize auto-consumption from PV, etc.
----------------------------------------

【43楼】 - markpurcell
回复时间: 2022-03-31T10:29:52.071Z
----------------------------------------
davidusb: The results of the optimization from EHMASS should help you to optimize even further your rule-based approach. I am looking forward to the further optimization that the LP model will provide, the rules based approach is OK, but the complexity is getting difficult to manage and I currently have no way to consider future PV production, so the price might be right to turn on a deferable load, but I may not have sufficient PV at that time to switch on without drawing from the grid. In EMHASS we have basically 4 forecasts to deal with: HA has been really good in bringing together disparate systems, which goes a long way towards populating the EMHASS model. PV power production forecast (internally based on the weather forecast and the characteristics of your PV plant) SolCast &amp; Forecast Solar gives me good hourly forecasts with 10/50/90 percentiles: ‘06:00’: pv_estimate: 52.7 pv_estimate10: 24.1 pv_estimate90: 55.3 ‘07:00’: pv_estimate: 852.6 pv_estimate10: 347.3 pv_estimate90: 895.2 ‘08:00’: pv_estimate: 2440.2 pv_estimate10: 1318.5 pv_estimate90: 2542.2 Load power forecast: how much power on 30min blocks your house will demand on the next 24h This is the tricky one. I know what I used yesterday and last week, but a bit more difficult to predict tomorrow as this is a function of how many people are going to be home over what times, external climate, km driven in my EV,… PV production selling price forecast: at what price are you selling your excess PV production on the next 24h Feed In Forecasts Price state_attr(‘sensor.amber_feed_in_forecast’, ‘forecasts’) |map(attribute=‘per_kwh’)|list}} [0.22, 0.32, 0.29, 0.32, 0.32, 0.27, 0.21, 0.27, 0.21, 0.21, 0.13, 0.13, 0.13, 0.13, 0.13, 0.13, 0.13, 0.21, 0.25, 0.32, 0.32, 0.29, 0.3, 0.29, 0.13, 0.21, 0.13, 0.11, 0.1, 0.1, 0.1, 0.1, 0.11, 0.11, 0.1, 0.13, 0.29, 0.32, 0.32, 0.32, 0.29, 0.33, 0.37, 0.51, 0.51, 0.37, 0.37, 0.37] Load cost forecast: the price of the energy from the grid on the next 24h (the data that you already have) General Price Forecasts state_attr(‘sensor.amber_general_forecast’, ‘forecasts’) |map(attribute=‘per_kwh’)|list}} [0.33, 0.44, 0.42, 0.44, 0.44, 0.39, 0.33, 0.39, 0.33, 0.33, 0.24, 0.24, 0.24, 0.24, 0.24, 0.24, 0.24, 0.33, 0.38, 0.44, 0.44, 0.42, 0.42, 0.42, 0.24, 0.33, 0.24, 0.21, 0.21, 0.21, 0.21, 0.21, 0.21, 0.21, 0.21, 0.24, 0.42, 0.44, 0.45, 0.44, 0.42, 0.46, 0.5, 0.66, 0.66, 0.5, 0.5, 0.5]
----------------------------------------

【44楼】 - davidusb
回复时间: 2022-03-31T13:39:27.326Z
----------------------------------------
HA has been really good in bringing together disparate systems, which goes a long way towards populating the EMHASS model. Agree… SolCast &amp; Forecast Solar gives me good hourly forecasts with 10/50/90 percentiles I’m using a scrapping method on the clearoutside webpage. From what I see they are using the same weather forcast data from Forecsat solar, dar sky, etc… So that’s ok. The advantage that I see with EMHASS is that I’m using PVLib, which is proven to work really well using the actual physical model of I-V curves for PV modules and the actual inverter efficiency curve. So the converted PV power from EMHASS will be more precise at least than Forecast Solar. For SolCast I don’t know. This is the tricky one. Yes this is the tricky one! For now as I said I’m just using the persistence model. It is far from perfect but is giving me some decent results. This is a very complex task what I’m willing to give it a shot to provide my own load forecast service. The good thing is that the framework to do it is there: the add-on environment with Python + a good forecast module . I’ve tried to achieve this with facebook prophet module with mitigated results and at the end not better than the persistance model. My conclusion at the time was that I needed to provide the forecast model with more regression variables, such as those that you cited: km driven with EV, expected number of people at home, the date (week-days/week-end), etc etc… I will try in the near future to obtain better load forecast results with this package: Time Series Made Easy in Python — darts documentation It seems nice an very intuitive. In any case for each of these 4 forecasts, the user will be able to directly provide their forecasts using other services and passing the data using json to EMHASS. By the way with new version 0.1.17 you will be able to access the web ui from outside your LAN.
----------------------------------------

【45楼】 - davidusb
回复时间: 2022-04-10T17:03:25.716Z
----------------------------------------
Hi; version v0.1.18 of this add-on is out. You should be able to pass all your own forecast data from other HA services. The data can be simply passed as a numeric list using json data. Take a look at the add-on documentation for more information on how to achieve this. Leave a message or open an issue on github if you encounter any problem.
----------------------------------------

【46楼】 - davidusb
回复时间: 2022-04-13T07:05:32.429Z
----------------------------------------
Hi. I just released v0.1.19. Fixed a bunch of errors. Enjoy! GitHub Release EMHASS add-on v0.1.19 · davidusb-geek/emhass-add-on This release solved different issues. Everything is working fine. This has been tested using the HA dev-container. Enjoy!!! Fix Removed possibility to pass web ui url as a parameter. Added the pos...
----------------------------------------

【47楼】 - david1
回复时间: 2022-04-17T16:41:27.848Z
----------------------------------------
thanks! Can you post a screenshot? Why would i want to use yours over the built in energy tab?
----------------------------------------

【48楼】 - davidusb
回复时间: 2022-04-17T20:36:24.935Z
----------------------------------------
Hi! Just because they are not at all the same thing. You may find an explanation of what is this in the add-on documentation. There is also a screenshot of the web ui. Take a look here: github.com davidusb-geek/emhass-add-on/blob/bc847f2f80d55ae4a4c14b7b4678fc63257f81e7/emhass/DOCS.md # EMHASS Add-on Documentation This is the documentation for the Add-on of **EMHASS: Energy Management for Home Assistant** This add-on repository: [https://github.com/davidusb-geek/emhass-add-on](https://github.com/davidusb-geek/emhass-add-on) The EMHASS module github repository: [https://github.com/davidusb-geek/emhass](https://github.com/davidusb-geek/emhass) The complete documentation for this module can be found here: [https://emhass.readthedocs.io/en/latest/](https://emhass.readthedocs.io/en/latest/) EMHASS is a Python module proposing an **optimized energy management** approach using the Linear Programming (LP) optimization technique. Right out the box EMHASS can be used to optimize the use of loads that are deferrable. This means that these loads can be “moved” around the day with “ideally” no impact on our everyday life. Good examples of these are: dishwasher, washing machine, etc. At my place I also considered as deferrable the water heater and the pool pump. You must follow these steps to make EMHASS work properly: 1) Define all the parameters in the configuration pane according to your installation. See the description for each parameter in the **configuration** section below. 2) You most notably will need to define the main data entering EMHASS. This will be the `sensor_power_photovoltaics` for the name of the your hass variable containing the PV produced power and the variable `sensor_power_load_no_var_loads` for the load power of your household excluding the power of the deferrable loads that you want to optimize. 3) Launch the actual optimization and check the results. This can be done manually using the buttons in the web ui or with a `curl` command like this: `curl -i -H "Content-Type: application/json" -X POST -d '{}' http://localhost:5000/action/dayahead-optim`. This file has been truncated. show original Essentially the built-in energy tab is just a dashboard of yours different power flows and energies. It will help you to visualize and understand how is the energy flow in your house at each hour of the day. You can then possibly build some automation rules to try to optimize you energy bill. This is however manual and the optimality is not guaranteed. The emhass package and the add-on perform an actual mathematical optimization of the future energy flow of your home using linear programming. Is an optimal dispatch of your home energy. This is interesting as your home system will be more complex and a bunch of manual automations won’t guarantee you the best optimal solution. As an input you can provide your home load forecast, your PV power production forecast, your energy prices forecasts (consumed and produced), your systems characteristics, etc. As an output emhass will give you the optimal dispatch of your defined deferrable loads, for example: hot water rod, pool pump, storage battery, etc.
----------------------------------------

【49楼】 - davidusb
回复时间: 2022-04-20T22:03:47.388Z
----------------------------------------
New improved v0.1.24: Release EMHASS add-on v0.1.24 · davidusb-geek/emhass-add-on · GitHub
----------------------------------------

【50楼】 - markpurcell
回复时间: 2022-04-28T00:58:14.998Z
----------------------------------------
davidusb: The advantage that I see with EMHASS is that I’m using PVLib, which is proven to work really well using the actual physical model of I-V curves for PV modules and the actual inverter efficiency curve. So the converted PV power from EMHASS will be more precise at least than Forecast Solar. For SolCast I don’t know. Just working my way through the PVLib settings. I have two SolarEdge 7 kW 3 phase inverters model SE7K-AUBTEBEU4 and 18.5 kW of panels (50x370W Winaico panels) arranged in four strings east/ west facing on 10 deg tilts. I have checked in the pvlib library and cannot see these models: github.com //github.com/NREL/SAM/tree/develop/deploy/libraries How can I specify generic system parameters on the add-on configuration dialog/ yaml?
----------------------------------------

【51楼】 - davidusb
回复时间: 2022-04-28T10:10:12.275Z
----------------------------------------
Hi, if you cannot find your exact models then just pick one with similar nominal power sizes for both the inverter and the panels. You should be able to find this. This is not ideal but it will still be much better than simpler PV modeling approaches. For our purposes PV panels IV curves and power inverters efficiencies curves are fairly similar from one model to another. These libraries are regularly updated and they add the new inverters and panels models. So let’s hope that they include yours in a next update. BTW v0.1.38 is released: Release EMHASS add-on v0.1.38 · davidusb-geek/emhass-add-on · GitHub
----------------------------------------

【52楼】 - davidusb
回复时间: 2022-05-02T09:46:44.077Z
----------------------------------------
Hi, in your case you should be almost good with this model from the PVLib CEC database: SolarEdge Technologies Ltd : SE7600A-US [240V] There are two important things that will be considered when modeling the PV array: The inverter efficiency. In this case if you choose a similar inverter from the same manufacturer and in a similar power range it should be good enough. The efficiency curve as a function of the inverter power will be fairly similar. The maximum AC output from the inverter. This should be a little bit more problematic because a different max nominal power will mean that the simulation may throw a higher (or lower) power output that you may actually get on your real system. I can see that for the present model on the CEC database it will differ from yours on roughly 625W. That may not be much and for our purposes sufficiently low to get some good usable results from this simulation. I may introduce a user given max PV output parameter to the add-on configuration to deal with these special cases.
----------------------------------------

【53楼】 - markpurcell
回复时间: 2022-05-03T05:06:04.249Z
----------------------------------------
Thanks, I ended up with that model. The trick is getting all the special characters and replacing them with ‘_’. I have two inverters each with one string of 25 panels on each, challenge is I have 21 panels East facing and 29 West facing, so it doesn’t exactly line up with my strings as SolarEdge uses optimisers so each panel more or less runs independently. You can see here inverter 1 is not reporting. image 636×1027 55.7 KB I have Winaico 370W mono panels so I just picked something close and set up with 21 &amp; 29 panels on each string, which seems to give pretty close results. pv_module_model: Advance_Power_API_M370,Advance_Power_API_M370 pv_inverter_model: &gt;- SolarEdge_Technologies_Ltd___SE7600A_US__208V_,SolarEdge_Technologies_Ltd___SE7600A_US__208V_ surface_tilt: 10,10 surface_azimuth: 90,270 modules_per_string: 29,21 strings_per_inverter: 1,1
----------------------------------------

【54楼】 - davidusb
回复时间: 2022-05-23T13:31:54.161Z
----------------------------------------
This emhass module is now on its version &gt;&gt; v0.3.11: Release EMHASS version 0.3.11 · davidusb-geek/emhass · GitHub Lots of improvements since v0.3.0… A new docker standalone mode is now fully functional.
----------------------------------------

【55楼】 - markpurcell
回复时间: 2022-05-31T09:12:46.376Z
----------------------------------------
I have started using ApexCharts card - A highly customizable graph card to visualise some of the EMHASS data as an alternative to the local UI. @kc_au @ThirtyDursty @madpilot type: custom:apexcharts-card span: start: minute header: show: true title: EMHASS Forecasts show_states: true colorize_states: true now: show: true label: now series: - entity: sensor.p_pv_forecast curve: stepline show: in_header: before_now stroke_width: 1 data_generator: | return entity.attributes.forecasts.map((entry) =&gt; { return [new Date(entry.date), entry.p_pv_forecast]; }); - entity: sensor.p_batt_forecast curve: stepline show: in_header: before_now stroke_width: 1 data_generator: | return entity.attributes.forecasts.map((entry) =&gt; { return [new Date(entry.date), entry.p_batt_forecast]; }); - entity: sensor.p_load_forecast curve: stepline show: in_header: before_now stroke_width: 1 data_generator: | return entity.attributes.forecasts.map((entry) =&gt; { return [new Date(entry.date), entry.p_load_forecast]; }); - entity: sensor.p_deferrable0 curve: stepline stroke_width: 1 show: in_header: before_now data_generator: | return entity.attributes.deferrables_schedule.map((entry) =&gt; { return [new Date(entry.date), entry.p_deferrable0]; }); - entity: sensor.p_deferrable1 curve: stepline stroke_width: 1 show: in_header: before_now data_generator: | return entity.attributes.deferrables_schedule.map((entry) =&gt; { return [new Date(entry.date), entry.p_deferrable1]; }); Works well for my energy provider as well: type: custom:apexcharts-card experimental: color_threshold: true graph_span: 24h span: start: minute header: show: true title: Amber Electricty Forecast show_states: true colorize_states: true series: - entity: sensor.amber_general_forecast float_precision: 2 show: in_header: after_now color_threshold: - value: 0 color: cyan - value: 0.16 color: green - value: 0.2 color: yellow - value: 0.3 color: red name: price kwh data_generator: | return entity.attributes.forecasts.map((entry) =&gt; { return [new Date(entry.start_time), entry.per_kwh]; }); yaxis: - min: 0 max: 1 decimals: 2 apex_config: forceNiceScale: true My EMHASS config file: web_ui_url: 0.0.0.0 hass_url: empty long_lived_token: empty costfun: profit optimization_time_step: 30 historic_days_to_retrieve: 2 method_ts_round: first set_total_pv_sell: false lp_solver: COIN_CMD lp_solver_path: /usr/bin/cbc sensor_power_photovoltaics: sensor.apf_generation_entity sensor_power_load_no_var_loads: sensor.power_load_no_var_loads number_of_deferrable_loads: 4 list_nominal_power_of_deferrable_loads: - nominal_power_of_deferrable_loads: 1500 - nominal_power_of_deferrable_loads: 5500 - nominal_power_of_deferrable_loads: 11500 - nominal_power_of_deferrable_loads: 2400 list_operating_hours_of_each_deferrable_load: - operating_hours_of_each_deferrable_load: 4 - operating_hours_of_each_deferrable_load: 2 - operating_hours_of_each_deferrable_load: 2 - operating_hours_of_each_deferrable_load: 1 list_peak_hours_periods_start_hours: - peak_hours_periods_start_hours: '02:54' - peak_hours_periods_start_hours: '17:24' list_peak_hours_periods_end_hours: - peak_hours_periods_end_hours: '15:24' - peak_hours_periods_end_hours: '20:24' list_treat_deferrable_load_as_semi_cont: - treat_deferrable_load_as_semi_cont: true - treat_deferrable_load_as_semi_cont: true - treat_deferrable_load_as_semi_cont: false - treat_deferrable_load_as_semi_cont: false load_peak_hours_cost: 0.1907 load_offpeak_hours_cost: 0.1419 photovoltaic_production_sell_price: 0.065 maximum_power_from_grid: 30000 list_pv_module_model: - pv_module_model: Advance_Power_API_M370 - pv_module_model: Advance_Power_API_M370 list_pv_inverter_model: - pv_inverter_model: SolarEdge_Technologies_Ltd___SE7600A_US__208V_ - pv_inverter_model: SolarEdge_Technologies_Ltd___SE7600A_US__208V_ list_surface_tilt: - surface_tilt: 18 - surface_tilt: 10 list_surface_azimuth: - surface_azimuth: 90 - surface_azimuth: 270 list_modules_per_string: - modules_per_string: 29 - modules_per_string: 21 list_strings_per_inverter: - strings_per_inverter: 1 - strings_per_inverter: 1 set_use_battery: true battery_discharge_power_max: 5264 battery_charge_power_max: 5000 battery_discharge_efficiency: 0.95 battery_charge_efficiency: 0.95 battery_nominal_energy_capacity: 13500 battery_minimum_state_of_charge: 0.05 battery_maximum_state_of_charge: 1 battery_target_state_of_charge: 0.1 nominal_power_of_deferrable_loads: 5500,1500,7000,3000 operating_hours_of_each_deferrable_load: 10,16,3,1 peak_hours_periods_start_hours: 02:54,17:24 peak_hours_periods_end_hours: 15:24,20:24 pv_module_model: Advance_Power_API_M370,Advance_Power_API_M370 pv_inverter_model: &gt;- SolarEdge_Technologies_Ltd___SE7600A_US__208V_,SolarEdge_Technologies_Ltd___SE7600A_US__208V_ surface_tilt: 10,10 surface_azimuth: 90,270 modules_per_string: 29,21 strings_per_inverter: 1,1
----------------------------------------

【56楼】 - markpurcell
回复时间: 2022-05-31T09:20:15.343Z
----------------------------------------
Here are some of my configurations to get EMHASS working with Amber Electric (Australia) Custom Component . @madpilot @kc_au @ThirtyDursty The magic happens in the shell commands: shell_command: dayahead_optim: "curl -i -H \"Content-Type: application/json\" -X POST -d '{}' http://localhost:5000/action/dayahead-optim" publish_data: "curl -i -H \"Content-Type: application/json\" -X POST -d '{}' http://localhost:5000/action/publish-data " post_amber_forecast: "curl -i -H 'Content-Type: application/json' -X POST -d '{\"prod_price_forecast\":{{( state_attr('sensor.amber_feed_in_forecast', 'forecasts')|map(attribute='per_kwh')|list) }},\"load_cost_forecast\":{{( state_attr('sensor.amber_general_forecast', 'forecasts') |map(attribute='per_kwh')|list) }}}' http://localhost:5000/action/dayahead-optim" post_emhass_forecast: "curl -i -H 'Content-Type: application/json' -X POST -d '{\"prod_price_forecast\":{{( state_attr('sensor.amber_feed_in_forecast', 'forecasts')|map(attribute='per_kwh')|list) }},{{states('sensor.solcast_24hrs_forecast')}},\"load_cost_forecast\":{{( state_attr('sensor.amber_general_forecast', 'forecasts') |map(attribute='per_kwh')|list) }}}' http://localhost:5000/action/dayahead-optim" post_mpc_optim: "curl -i -H \"Content-Type: application/json\" -X POST -d '{\"load_cost_forecast\":{{( ([states('sensor.amber_general_price')|float(0)] + state_attr('sensor.amber_general_forecast', 'forecasts') |map(attribute='per_kwh')|list)[:48]) }}, \"prod_price_forecast\":{{( ([states('sensor.amber_feed_in_price')|float(0)] + state_attr('sensor.amber_feed_in_forecast', 'forecasts')|map(attribute='per_kwh')|list)[:48]) }}, \"prediction_horizon\":{{min(48, (state_attr('sensor.amber_feed_in_forecast', 'forecasts')|map(attribute='per_kwh')|list|length)+1) }},\"soc_init\":{{states('sensor.powerwall_charge')|float(0)/100}},\"soc_final\":0.05,\"def_total_hours\":[8,3,2,2]}' http://localhost:5000/action/naive-mpc-optim" But let me unpack this for you first, I recommend you do a lot of work in the Developer Tools Template first. {{state_attr('sensor.p_batt_forecast', 'forecasts')|map(attribute='p_batt_forecast')|list|length}} {{state_attr('sensor.p_batt_forecast', 'forecasts')|map(attribute='p_batt_forecast')|list}} "soc_init":{{states('sensor.powerwall_charge')|float(0)/100}} "prediction_horizon":{{min(48,state_attr('sensor.amber_feed_in_forecast', 'forecasts')|map(attribute='per_kwh')|list|length+1)}} "load_cost_forecast":{{([states('sensor.amber_general_price')|float] + state_attr('sensor.amber_general_forecast', 'forecasts') |map(attribute='per_kwh')|list)[:48]}} "prod_price_forecast":{{([states('sensor.amber_feed_in_price')|float] + state_attr('sensor.amber_feed_in_forecast', 'forecasts')|map(attribute='per_kwh')|list)[:48]}} "load_now": {{(states('sensor.powerwall_load_now')|float(0)*1000)|round(0)}} "pv_now": {{(states('sensor.powerwall_solar_now')|float(0)*1000)|round(0)}} "def_total_hours [EV 11 kW]": {{ state_attr('sensor.duka_charging_rate_sensor','time_left')|int(2)}} "def_total_hours [Pool Filter 1.4 kW]": 4 "def_total_hours [HVAC humidity 4 kW]": {{max(0,(state_attr('climate.family','current_humidity')|int(0) - 60)/10)|int(0)}} "def_total_hours [HVAC temp 4 kW]": {{max(0,(state_attr('climate.bedroom','current_temperature')|float(0) - state_attr('climate.daikin_ap46401','temperature')|float))}} "def_total_hours [HVAC No People 4 kW]": {{states('zone.home')}} "def_total_hours [Pool Heater 5 kW]": {{states('input_number.pool_temperature_set_point')|int - states('input_number.pool_temperature')|int}} curl -i -H "Content-Type: application/json" -X POST -d '{"prod_price_forecast":{{( (state_attr('sensor.amber_feed_in_forecast', 'forecasts')|map(attribute='per_kwh')|list) ) }},"load_cost_forecast":{{( (state_attr('sensor.amber_general_forecast', 'forecasts') |map(attribute='per_kwh')|list) ) }},"prediction_horizon":{{(state_attr('sensor.amber_feed_in_forecast', 'forecasts')|map(attribute='per_kwh')|list|length) }},"soc_init":{{states('sensor.powerwall_charge')|float(0)/100 }},"soc_final":0.05,"def_total_hours":[4,5,3,1]}' http://localhost:5000/action/naive-mpc-optim post_mpc_optim: "curl -i -H \"Content-Type: application/json\" -X POST -d '{\"prod_price_forecast\":{{( [states('sensor.amber_feed_in_price')|float(0)] + (state_attr('sensor.amber_feed_in_forecast', 'forecasts')|map(attribute='per_kwh')|list)[:47]) }},\"load_cost_forecast\":{{( [states('sensor.amber_general_price')|float(0)] + (state_attr('sensor.amber_general_forecast', 'forecasts') |map(attribute='per_kwh')|list)[:47]) }},\"prediction_horizon\":{{min(48, (state_attr('sensor.amber_feed_in_forecast', 'forecasts')|map(attribute='per_kwh')|list|length)+1) }},\"soc_init\":{{states('sensor.powerwall_charge')|float(0)/100}},\"soc_final\":0.05,\"def_total_hours\":[4,5]}' http://localhost:5000/action/naive-mpc-optim" image 1246×762 31.4 KB My Automations, either a single day-ahead optimisation or MPC running every minute. alias: EMHASS day-ahead optimization description: '' trigger: - platform: time_pattern minutes: '25' hours: '5' condition: [] action: - service: shell_command.post_amber_forecast data: {} - service: shell_command.publish_data data: {} mode: single alias: EMHASS MPC optimization description: '' trigger: - platform: time_pattern minutes: /1 condition: [] action: - service: shell_command.post_mpc_optim data: {} - service: shell_command.publish_data data: {} mode: single alias: p_deferable1 automation description: '' trigger: - platform: numeric_state entity_id: sensor.p_deferrable1 above: '0.1' for: hours: 0 minutes: 2 seconds: 0 - platform: numeric_state entity_id: sensor.p_deferrable1 for: hours: 0 minutes: 2 seconds: 0 below: '0.1' condition: [] action: - choose: - conditions: - condition: numeric_state entity_id: sensor.p_deferrable1 above: '0.1' sequence: - type: turn_on device_id: 03a766ec3275e2c80020c5f5a3d8e603 entity_id: switch.pool_heater_pump domain: switch - service: notify.mobile_app_pixel_6 data: message: Pool Heater on default: - type: turn_off device_id: 03a766ec3275e2c80020c5f5a3d8e603 entity_id: switch.pool_heater_pump domain: switch - service: notify.mobile_app_pixel_6 data: message: Pool Heater off mode: single alias: p_batt automation description: '' trigger: - platform: numeric_state entity_id: sensor.p_batt_forecast below: '-4000' condition: [] action: - choose: - conditions: - condition: numeric_state entity_id: sensor.p_batt_forecast below: '-3000' sequence: - service: notify.mobile_app_pixel_6 data: title: p_batt alert {{states('sensor.p_batt_forecast')}} - mode:backup message: d{{states('sensor.amber_general_price')}} $/kWh - service: tesla_gateway.set_operation data: real_mode: backup - conditions: - condition: numeric_state entity_id: sensor.p_batt_forecast above: '4900' sequence: - service: tesla_gateway.set_operation data: real_mode: autonomous backup_reserve_percent: 1 - service: notify.mobile_app_pixel_6 data: title: &gt;- p_batt alert {{states('sensor.p_batt_forecast')}} - mode:autonomous message: d{{states('sensor.amber_general_price')}} $/kWh default: - service: notify.mobile_app_pixel_6 data: title: &gt;- p_batt alert {{states('sensor.p_batt_forecast')}} - mode:self_consumption message: d{{states('sensor.amber_general_price')}} $/kWh - service: tesla_gateway.set_operation data: real_mode: self_consumption backup_reserve_percent: 2 mode: single
----------------------------------------

【57楼】 - markpurcell
回复时间: 2022-05-31T09:21:24.438Z
----------------------------------------
Automation to get Tesla Powerwall Gateway to discharge to grid at 0700 and 1700 for 60 minutes (during sunrise/ sunset peak) for maximum FIT and to help the grid when under stress. I recommend getting the excellent TeslaPy libray talking to your powerwall first. (You need the cache.json anyway) Update: this can all now be controlled with Tesla Custom Integration image 1128×1156 76.8 KB You need to do some setup first: Tonight during the price spike event I had Home Assistant switch PW2 to Time Based Control and my battery started exporting at 5 kW, until 1800 when HA switched the PW2 back to self powered mode and stopped exporting. Needs the following TOU settings to be pre-loaded to PW2, but I find the highest FIT has been occuring around this time regularly so I can automate with HA to control the mode switching. I do the following to discharge PW2 at 5 kW during peak FIT between 5pm - 6pm. Setup time of use settings and prices per the attached screenshot. Switch battery to Self-Powered and it will store and consume excess solar to match household production and load. Switch to Time-Based Control and the Battery will charge from the grid during off peak window and discharge to the grid during peak (and sometimes mid peak). So at 6am this morning TBC mode discharged the battery to get maximum FIT. At 1030 it started consuming excess solar and charging from the grid (upto 5 kW). At 1330 it (generally) stops charging from the grid but still charges off excess solar. At 1700 ideally your battery is at 100% and it will start discharging at 5kW as it tries to empty battery before next off peak window at 1800 to gain maximum FIT for the day. The next step is very important, before 1800 switch back to self-consumption mode otherwise it will start charging from the grid at a very expensive price. There are some new advanced grid controls that would mitigate this. You can edit the price schedule in the app to extend discharging window. Best I have done is $60 credit during price spike event. But be aware changing the schedule doesn’t take effect immediately I find changes take effect after the next quarter hour block (IE minute 0,15,30 or 45). If you are uncomfortable with what the battery is doing, put it back into self-powered mode and it should settle within seconds. You can tell battery to charge at any time by increasing reserve % (albeit slower at 3.3 kW). I find this method extends the charging/ discharging windows for longer than SmartShift, if that is what you want. Works well with Amber pricing being so different at different times. Home Assistant/ python scripts allow you to change between modes; self_consumption, backup (100% reserve) and autonomous (time based control) or set reserve % directly, so you can automate the above process based off your own rules. Home Assistant doesn’t allow you to change your tou windows. This is actually quite helpful as it is supplying extra capacity to the grid when grid is under stress and you gain access to higher FIT and the financial benefits. May be an image of text that says &amp;quot;Summary No Seasons x Edit All-year January December Schedule Edit Off Peak Mid-Peak 10:30 13:30 Peak 13:30 17:00 Off- Peak Peak 17:00 18:00 18:00 21:00 Pricing 21:00 10:30 Edit Mid- Peak B $0.43/ kWh Sell Price $0.10/ kWh Peak B $0.43/ kWh Sell Price $0.30 kWh Save Start Over&amp;quot; 640×1422 44.9 KB
----------------------------------------

【58楼】 - davidusb
回复时间: 2022-05-31T12:28:40.988Z
----------------------------------------
Nice setup, thanks for the sharing. This can be really helpful for Amber AU users
----------------------------------------

【59楼】 - davidusb
回复时间: 2022-05-31T12:30:31.849Z
----------------------------------------
Nice graphics also with the ApexCharts! There is also the option of the Plotly card from HACS. The local UI is using the Plolty library for Python charts… That local UI is just intended for debugging when setting up emhass.
----------------------------------------

【60楼】 - kc_au
回复时间: 2022-06-01T00:31:15.211Z
----------------------------------------
HI @markpurcell , I cant send you enough Thank You’s and if I ever meet you, beers are on me! I will have a few questions, but here is my first: Your calling “sensor.solcast_24hrs_forecast”. What value are you populating here? I am using the HACS Solcast Integration and my options are Forecast Today, Forecast Today Remaining or Forecast Tomorrow. All returns a single instance value ie/ 40KW for today. Are you derving this value in YAML or how are you collecting this info? Are you using the core Solcast HACS or are you using another version?
----------------------------------------

【61楼】 - markpurcell
回复时间: 2022-06-01T01:20:55.742Z
----------------------------------------
Ah, you found that one… I would focus on just getting amber buy/sell prices first and use the inbuild pvlib estimation for solar production which is pretty good. post_amber_forecast You don’t need to use all of those scripts at the same time, rather they are different ways to populate the future forecasts. I have a vision of submitting both actual current and forecast pv production, which is where that is going. Unfortunately the solcast integration only provides 60 minute resolution and I wanted to run emhass on 30 minute resolution to match the amber pricing windows. A lot of great discussion and visualisation for SolCast here: REST API command/platform fails on POST to external URL (solcast) - #132 by safepay Something like this to grab the solcast data direct, I still need to convert kW to W and get into correct sensor (note sensors have 255 character limits - which can be exceeded when having a full list of 24 hrs - hence the use of attributes): - platform: rest name: "Solcast Forecast Data" json_attributes: - forecasts resource: https://api.solcast.com.au/rooftop_sites/SOLCAST_RESOURCE_ID/forecasts?format=json&amp;api_key=SOLCAST_API_KEY&amp;hours=24 method: GET value_template: "{{ value_json.forecasts[0].pv_estimate|round(2) }}" unit_of_measurement: "W" device_class: power scan_interval: 00:30 force_update: true image 941×720 77.8 KB
----------------------------------------

【62楼】 - markpurcell
回复时间: 2022-06-02T21:59:58.904Z
----------------------------------------
Today’s plan. Feed-in price stays above 60¢/ kWh all day (peaks at $15/ kWh tonight), which is higher than the 40¢ / kWh general price tomorrow morning! EMHASS daily optimisation is saying to shift all deferrable loads to tomorrow to maximise battery charging (to export over tonight’s peak @ $10-$15) and maximise exports during the day @ 60¢. A lot of interest in EMHASS from the Australian Amber users facebook group as we try and optimise our way through a crazy electricity market. Redirecting... image 756×1147 40 KB
----------------------------------------

【63楼】 - davidusb
回复时间: 2022-06-02T22:42:18.142Z
----------------------------------------
Nice discussion. I’m currently working on a hopefully better load forecast module. I’m a data scientist, so now that EMHASS seems quite stable the next step is to improve those forecast. The naive persistence approach is basic but robust. I’m testing to see what kind of model could we use to obtain better load forecasts, better than the naive method. This is currently narrowed to RNN (Recurrent neural networks) and LSTM ( Long short-term memory) models. They seem to give some nice results. I’m working on this right now.
----------------------------------------

【64楼】 - kc_au
回复时间: 2022-06-03T11:17:04.155Z
----------------------------------------
@davidusb A small feature request would be to put totals on the columns: cost_profit cost_fun_profi or like a 24 hour forecast of cost/profit so you can see how the model is going to perform as a whole for the period.
----------------------------------------

【65楼】 - davidusb
回复时间: 2022-06-03T11:50:01.544Z
----------------------------------------
Hi, yes this can be done. An additional table that sums up the results shown in the table. The total cost is already been printed on the add-on logger though. This result is printed every time that an optimization routine is launched.
----------------------------------------

【66楼】 - markpurcell
回复时间: 2022-06-03T12:00:25.815Z
----------------------------------------
That m it’s would be useful to have the sum of cost brought through into HA, or just bring cost_profit and others with attributes, when could then be summed inside HA. apexcharts will sum data series, so it would be good to put in the header. Could I also ask you consider bringing the other variables across, like SOC and p_grid as that can help with control.
----------------------------------------

【67楼】 - davidusb
回复时间: 2022-06-03T12:14:45.202Z
----------------------------------------
This can be done for p_grid . For the SOC this is already done. Aren’t you able to see sensor.soc_batt_forecast with its future values as attributes?
----------------------------------------

【68楼】 - davidusb
回复时间: 2022-06-03T13:42:20.332Z
----------------------------------------
Advanced a bit on new load forecasting methods. Here is a quite decent result for the N-BEATS model: image 1062×652 85.8 KB
----------------------------------------

【69楼】 - markpurcell
回复时间: 2022-06-03T20:40:38.913Z
----------------------------------------
The pattern of life. Interesting to see how each day is similar but different. Of course the Mon-Fri pattern is often similar but different to the Sat-Sun pattern, so it would be interesting to see how the forecasting model accommodates that. My observation of the current EMHASS forecasting is that not surprisingly if yesterday was abnormal (ie higher or lower consumption) that then flows into the current optimisation. Your approach with N-BEATS and other advanced models will address this. One suggestion from me is to include the now actual power load value into the modelling. (sensor.power_load_no_var_loads) As you are aware I am running the mpc optimisation updated every minute. Into that model I am injecting the buy/ sell values, and using method_ts_round first, I include the current now value plus the subsequent forecast values for future timeslots. Given EMHASS already had access to the now values for load (sensor.power_load_no_var_loads) and production (sensor.power_photovoltaics), it would seem to make sense when using method_ts_round first to use the actual now values when developing the forecasts. In practice I would see these now values replacing the now values in any EMHASS forecast and subsequent calculations. For example I can see in the optimisation results many examples when EMHASS sets the battery power value to match baseload or PV production values, to produce a net zero effect. Pvlib at that instant maybe forecasting 3000W production and then EMHASS calculates p_batt_forecast to -3000W to balance. But sensor.power_photovoltaics may be 2000W, thus p_batt_forecast should be calculated to match at -2000W, because if we set to -3000W we need to draw that additional 1000W power from the grid. I am aware I can inject the now values myself, as I am doing with the buy/ sell values. But if I generate my own forecasts for PV production including the now value, I loose access to the benefits of pvlib and if I generate my own load forecasts including the now value I would loose access to N-BEATS or other advanced modelling. I hope that makes sense, but happy to discuss further if useful.
----------------------------------------

【70楼】 - markpurcell
回复时间: 2022-06-03T21:44:01.775Z
----------------------------------------
Oh, sorry I missed the inclusion of that one. I am finding control of the battery a frustrating issue, nothing to do with EMHASS. Looking at Home Solar battery systems like the Victron @kc_au it seems you can send the desired battery control value in W directly - so p_batt_forecast from EMHASS can be sent directly to the Victron and it will match for both charging and discharging. I have a Tesla Powerwall2 and monitoring and control via the undocumented API is somewhat limited. I’m using the excellent teslapy library which provides the best level of control possible. The battery is capable of charging/ discharging at +/- 5 kW, but getting it to achieve this on command is difficult. I can set backup mode which sets charging from the grid at 3.3 kW (usually) which is a close proxy for charging on demand, albeit a bit slower than max. So when p_batt_forecast is below -3300 I can switch to backup mode and when it is above -3300 I switch to self_consumption mode. In self_consumption mode excess solar (upto 5 kW) is stored in the battery and excess load (upto 5 kW) is provided by the battery. So this is a great mode to balance peaks and troughs. I can also set backup_reserve as desired % minimum charge. I can easily take sensor.soc_batt_forecast and use that to set backup_reserve. When this value is over the actual SOC the battery will charge from the grid, when this value is below SOC the battery will discharge to meet household load only, but only down to backup_reserve. I could set backup_reserve after every optimisation and that would be partially effective. But wouldn’t support the peaks and troughs, as the battery would not discharge below backup_reserve. So what about discharging to the grid? Possible, but complex. I can set autonomous mode on the battery that takes into consideration history of solar production and load and a set time based control schedule with windows for super_offpeak, offpeak, mid_peak and peak. All with set buy/ sell prices for each window. The general strategy the battery follows is to ensure there is sufficient battery charge to cover peak, by charging during offpeak. To maximise returns this includes discharging the battery (5 kW to the grid) during high price sell windows (peak) and charging the battery (5 kW from the grid) during low cost buy windows (off-peak). I can switch to autonomous mode via a script, but cannot (as yet) use a script to change the windows or prices. Now of course EMHASS is more flexible and might want to charge from the grid at anytime conditions are right, especially when optimising for wholesale pricing that changes continuously. Typically the times we want to discharge to the grid are those times when the grid is under extreme demand, needs additional capacity and thus the wholesale price shoots up (in my case upto $13/ kWh) to drive additional supply to meet that demand. Generally the sunrise and sunset morning and evening peaks. I have set in the battery high price peak windows for 0600-0700 &amp; 1700-1800 and my automation is if p_batt_forcecast is greater than 4000W and it is between these hours I switch to autonomous mode which sets the battery to discharge (5 kW to the grid) during the times of most need and afterwards I switch back to self_consumption mode. So possible, but complex with a Powerwall2. I guess they are trying to limit over-cycling the battery. But the Victron style level of control does have its advantages.
----------------------------------------

【71楼】 - kc_au
回复时间: 2022-06-04T04:35:51.378Z
----------------------------------------
@markpurcell I set my Grid Set Point to a value in W. So if I set it to -5000, the Victron inverter will target export 5000 W. if my house consumption is 2000W, the inverter will output 7000W to meet its target. 0 = self consume. + 5000 would be take 5000 from grid, and excess into battery, shortage from battery. Just confirmation on how the Victron works. What I cant do, is set the Victron to export 3kw from battery, ignore house loads. and it takes 5-6 seconds to get data, and then 5-6 seconds to push, so I cant update it live. Pros and Cons of each. I am struggling with visualising EMHASS data atm. , but once I can see the data that EMHASS is asking my batt to do, I can do the automations. Wether I take the value from EMHASS direct, or apply some logic/rules to it. Unsure at this point. Loving what I am seeing so far though!
----------------------------------------

【72楼】 - davidusb
回复时间: 2022-06-04T06:57:40.288Z
----------------------------------------
The more advanced models should adapt very well to the hour of the day and the day of the week (weekdays, weekends, etc). This is because I am using that information as encoded covariate inputs to the models. This is very interesting in deed as these values are perfectly known in the future. The overall quality of the forecast will also depend on the quantity of data used when training the model. We should provide as much data as possible. This is multivariate, so l am also adding as inputs the historical values of weather data for example. Something I’ve not done yet is to also provide occupation data, but I will do in the future. This is looking great. I am still thinking if this should be a complete new add-on or if I will directly integrate this in emhass. The problem that I see is that the docker image will be bigger and harder to compile for arm archs. As for the now values, these are of course already integrated in the forecast models. The models often find a direct correlation with the closest data lags of the history values. When feeding history values to the models the now values are the last historical values, so they are taken into consideration when forecasting. I’m not sure if I’m missing something else on your analysis about this.
----------------------------------------

【73楼】 - markpurcell
回复时间: 2022-06-04T07:27:47.029Z
----------------------------------------
My apologies, I think I haven’t explained myself for the ‘now’ variable. Take for a specific example pv_forecast over the last 30 minutes (1630-1700 - sunset is 1703): image 482×591 26.2 KB image 1485×120 6.23 KB pvlib has calulated pv_forecast as 729 W and p_load constant at 896W and as a consequence p_batt_forecast has been set a constant 166W for the full 30 minute period. I am running mpc_optim every minute. emhass has already access to the top graph variables for load and pv, but doesn’t use them when calculating the optimisation, it only looks back over the last 24 hrs, I don’t believe it uses the current value. So p_batt should be increasing after each mpc_optimisation to reflect the actual differences (now values) for Solar Power and Load Power. This is just a minor example, but I sometimes have errors between forecasts and actuals of 1000 W or 2000 W, which would make a substantive difference to the published p_batt_forecast value. Now for pv_forecast I could inject the ‘now’ values, with method_ts_round first using something like: "pv_now": {{(states('sensor.powerwall_solar_now')|float(0))}} "solcast_future_forecasts": {{state_attr('sensor.solcast_forecast_data', 'forecasts')|map(attribute='pv_estimate')| list}} "pv_power_forecasts:"{{([states('sensor.powerwall_solar_now')|float(0)] + (state_attr('sensor.solcast_forecast_data', 'forecasts')|map(attribute='pv_estimate')| list))[:48]}} pv_now would be updated and injected for each mpc_optim run and the remainder of the forecasts would be fairly stable. "pv_now": 0.05 "solcast_future_forecasts": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.383, 2.8362, 4.7992, 6.8943, 8.5046, 10.0137, 11.0883, 12.0041, 12.6009, 12.8405, 13.0011, 12.7743, 12.5328, 11.8008, 10.8927, 9.6497, 7.8646, 6.2096, 4.2492, 2.1112, 0.3171] "pv_power_forecasts:"[0.05, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.383, 2.8362, 4.7992, 6.8943, 8.5046, 10.0137, 11.0883, 12.0041, 12.6009, 12.8405, 13.0011, 12.7743, 12.5328, 11.8008, 10.8927, 9.6497, 7.8646, 6.2096, 4.2492, 2.1112]
----------------------------------------

【74楼】 - davidusb
回复时间: 2022-06-04T11:18:05.318Z
----------------------------------------
Oh yes I do get it now. Ok this is specific to MPC. You are right, when using MPC it is just using the forecast from the day ahead optimization. Those forecast should be updated every time. I’ll fix this.
----------------------------------------

【75楼】 - davidusb
回复时间: 2022-06-04T17:06:03.159Z
----------------------------------------
Ok, taking a deeper look into this, the dayahead and the MPC optimization implementations are just fine. The scraping method for PV forecast and the naive method for load consumption forecast are just what they are with their respective limitations. To make the current/now values act as input to the forecast we will need what I’m doing right now for the load forecast: train a machine learning regression model. What I realize now is that we need to do this also for the PV forecast. We have a PV forecast obtained from scraping a website with data from GFS model. We then use PVLib to convert from irradiance to watts. Now we can use this along with the history of real PV production values to train a regression model that will be more accurate because it will be fitted to the latest lags of the real data. Ok I’ll put all this on the roadmap and continue working on these better machine learning based forecast models. So there is nothing to fix, just need to provide better forecasts. Of course the user is always open to provide their own forecasts via the runtime passed data when using MPC.
----------------------------------------

【76楼】 - prinzkafka
回复时间: 2022-06-05T13:23:35.835Z
----------------------------------------
Hi, I have a problem with my template sensor for the sensor_power_load_no_var_loads in the EMHASS Addon This is the Log: [2022-06-05 15:11:44,615] ERROR in app: Exception on /action/dayahead-optim [POST] Traceback (most recent call last): File "/usr/local/lib/python3.9/dist-packages/requests/models.py", line 910, in json return complexjson.loads(self.text, **kwargs) File "/usr/lib/python3.9/json/__init__.py", line 346, in loads return _default_decoder.decode(s) File "/usr/lib/python3.9/json/decoder.py", line 340, in decode raise JSONDecodeError("Extra data", s, end) json.decoder.JSONDecodeError: Extra data: line 1 column 5 (char 4) During handling of the above exception, another exception occurred: Traceback (most recent call last): File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 2077, in wsgi_app response = self.full_dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1525, in full_dispatch_request rv = self.handle_user_exception(e) File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1523, in full_dispatch_request rv = self.dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1509, in dispatch_request return self.ensure_sync(self.view_functions[rule.endpoint])(**req.view_args) File "/usr/local/lib/python3.9/dist-packages/emhass/web_server.py", line 130, in action_call input_data_dict = set_input_data_dict(config_path, str(config_path.parent), costfun, File "/usr/local/lib/python3.9/dist-packages/emhass/command_line.py", line 81, in set_input_data_dict P_load_forecast = fcst.get_load_forecast(method=optim_conf['load_forecast_method']) File "/usr/local/lib/python3.9/dist-packages/emhass/forecast.py", line 454, in get_load_forecast rh.get_data(days_list, var_list) File "/usr/local/lib/python3.9/dist-packages/emhass/retrieve_hass.py", line 107, in get_data data = response.json()[0] File "/usr/local/lib/python3.9/dist-packages/requests/models.py", line 917, in json raise RequestsJSONDecodeError(e.msg, e.doc, e.pos) requests.exceptions.JSONDecodeError: [Errno Extra data] 500 Internal Server Error Server got itself in trouble: 4 This is how I calculate the Template Sensor: emhass_power_no_var_load: value_template: &gt; {% set powerload = states('sensor.electricity_rietschener_str_24_total_power') | float %} {% set heizpatrone = states('sensor.heizpatrone_power') | float %} {% set geschirrspueler = states('sensor.geschirrspuler_current_consumption') | float %} {% set waschmaschine = states('sensor.waschmaschine_power_consumption') | float %} {% set value = ( powerload - heizpatrone - geschirrspueler - waschmaschine ) | round(1) %} {{ '{:.1f}'.format(value) }} unit_of_measurement: 'W' When I use the sensor of my electricity meter, everything works smoothly, so I assume that I made a mistake somewhere with the template sensor. Maybe someone has an idea where the error could be?
----------------------------------------

【77楼】 - prinzkafka
回复时间: 2022-06-05T18:42:37.249Z
----------------------------------------
I think I figured out what the problem might be. The template sensor sometimes has an unknown state. Could this be the problem? How can I work around this? Bildschirmfoto 2022-06-05 um 20.39.09 964×842 61.6 KB
----------------------------------------

【78楼】 - davidusb
回复时间: 2022-06-05T19:28:23.623Z
----------------------------------------
This a breaking change in Home Assistant templates with the new 2022.6 release. You’ll need to catch those unknown values with some if else statements in your template.
----------------------------------------

【79楼】 - davidusb
回复时间: 2022-06-05T19:37:30.688Z
----------------------------------------
You can also specify default values inside the failing function on the template. Take a look here: Fail template functions when no default specified by emontnemery · Pull Request #71687 · home-assistant/core · GitHub
----------------------------------------

【80楼】 - prinzkafka
回复时间: 2022-06-06T10:21:02.082Z
----------------------------------------
Thanks for the tips, have tried both - also both together - after a restart the first state will be an unknown state in the database - here is the code of the template sensor. Any other ideas? {% set powerload = states('sensor.electricity_rietschener_str_24_total_power') | float(default=0) %} {% set heizpatrone = states('sensor.heizpatrone_power') | float(default=0) %} {% set geschirrspueler = states('sensor.geschirrspuler_current_consumption') | float(default=0) %} {% set waschmaschine = states('sensor.waschmaschine_power_consumption') | float(default=0) %} {% set value = ( powerload - heizpatrone - geschirrspueler - waschmaschine ) | round(1) %} {% if (states('sensor.electricity_rietschener_str_24_total_power') != "unavailable") %} {{ '{:.1f}'.format(value) }} {% else %} 0 {% endif %}
----------------------------------------

【81楼】 - davidusb
回复时间: 2022-06-07T07:14:01.124Z
----------------------------------------
prinzkafka: round(1) Try round(1,default=0) . I had to do this with my templates… You will have to do this in templates where you use these functions: round , multiply , log , sin , cos , tan , asin , acos , atan , atan2 , sqrt , timestamp_custom , timestamp_local , timestamp_utc , as_timestamp , strptime , float , int .
----------------------------------------

【82楼】 - prinzkafka
回复时间: 2022-06-07T15:16:38.924Z
----------------------------------------
Thank you. I tried this: value_template: &gt; {% set powerload = states('sensor.electricity_rietschener_str_24_total_power') | float(default=0) %} {% set heizpatrone = states('sensor.heizpatrone_power') | float(default=0) %} {% set geschirrspueler = states('sensor.geschirrspuler_current_consumption') | float(default=0) %} {% set waschmaschine = states('sensor.waschmaschine_power_consumption') | float(default=0) %} {% set value = ( powerload - heizpatrone - geschirrspueler - waschmaschine ) | round(1,default=0) %} {{ value }} but as you can see from the picture, there is still an unknown state in the database after each restart. Could someone please post his working template sensor as an example? Bildschirmfoto 2022-06-07 um 17.09.49 1044×1574 65.8 KB
----------------------------------------

【83楼】 - markpurcell
回复时间: 2022-06-07T20:07:17.216Z
----------------------------------------
My energy plan for today, optimised by EMHASS. Total forecasts value is $60 credit. Today’s s.qld energy plan. Buy low (10¢ / kWh forecast at midday) and sell high ($13/ kWh forecast at 6pm price spike)! The grid needs your help. High prices this morning ($1/ kWh forecast @ 7am) and a price spike tonight ($15/ kWh @ 6pm) present opportunity to discharge the battery to the grid for a double cycle. Very low prices, finally, over the midday solar soak (10¢/ kWh forecast between 10am - 3pm) is the ideal window to charge everything and run all your power hungry loads. With a forecast feed in tariff of 0¢ try to self consume 100% of any generated solar as any exports at that time are literally worthless. f2707dba24dd45f08a7bf997eb6abe55-Screenshot_20220608-054427 864×1920 192 KB
----------------------------------------

【84楼】 - davidusb
回复时间: 2022-06-07T21:05:44.356Z
----------------------------------------
So try to catch that wrong value. Something like this: value_template: &gt; {% set powerload = states('sensor.electricity_rietschener_str_24_total_power') | float(default=0) %} {% set heizpatrone = states('sensor.heizpatrone_power') | float(default=0) %} {% set geschirrspueler = states('sensor.geschirrspuler_current_consumption') | float(default=0) %} {% set waschmaschine = states('sensor.waschmaschine_power_consumption') | float(default=0) %} {% set value = ( powerload - heizpatrone - geschirrspueler - waschmaschine ) | round(1,default=0) %} {% if (value == 'unavailable') or (value == 'unknown') %} {{ 0.0 }} {% else %} {{ value }}
----------------------------------------

【85楼】 - prinzkafka
回复时间: 2022-06-08T05:58:52.165Z
----------------------------------------
Thank you. I have changed it that way. Still after every restart one unknown state in the database.
----------------------------------------

【86楼】 - davidusb
回复时间: 2022-06-08T07:17:33.430Z
----------------------------------------
Well that template sensor should be fine for the new values that will arrive to your base sensors. However the unknown values that where stored in the database are still there. If this is the case, here is a guide to modify database values manually: How to fix statistics data (e.g. energy data) And are you still having the same error in emhass?
----------------------------------------

【87楼】 - prinzkafka
回复时间: 2022-06-08T07:34:38.224Z
----------------------------------------
Yes, same error with this template sensor: [2022-06-08 09:32:00,090] ERROR in app: Exception on /action/dayahead-optim [POST] Traceback (most recent call last): File "/usr/local/lib/python3.9/dist-packages/requests/models.py", line 910, in json return complexjson.loads(self.text, **kwargs) File "/usr/lib/python3.9/json/__init__.py", line 346, in loads return _default_decoder.decode(s) File "/usr/lib/python3.9/json/decoder.py", line 340, in decode raise JSONDecodeError("Extra data", s, end) json.decoder.JSONDecodeError: Extra data: line 1 column 5 (char 4) During handling of the above exception, another exception occurred: Traceback (most recent call last): File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 2077, in wsgi_app response = self.full_dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1525, in full_dispatch_request rv = self.handle_user_exception(e) File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1523, in full_dispatch_request rv = self.dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1509, in dispatch_request return self.ensure_sync(self.view_functions[rule.endpoint])(**req.view_args) File "/usr/local/lib/python3.9/dist-packages/emhass/web_server.py", line 134, in action_call input_data_dict = set_input_data_dict(config_path, str(config_path.parent), costfun, File "/usr/local/lib/python3.9/dist-packages/emhass/command_line.py", line 81, in set_input_data_dict P_load_forecast = fcst.get_load_forecast(method=optim_conf['load_forecast_method']) File "/usr/local/lib/python3.9/dist-packages/emhass/forecast.py", line 454, in get_load_forecast rh.get_data(days_list, var_list) File "/usr/local/lib/python3.9/dist-packages/emhass/retrieve_hass.py", line 107, in get_data data = response.json()[0] File "/usr/local/lib/python3.9/dist-packages/requests/models.py", line 917, in json raise RequestsJSONDecodeError(e.msg, e.doc, e.pos) requests.exceptions.JSONDecodeError: [Errno Extra data] 500 Internal Server Error Server got itself in trouble: 4
----------------------------------------

【88楼】 - davidusb
回复时间: 2022-06-10T09:59:44.504Z
----------------------------------------
Hi, I just released a new add-on version with some improvements &gt;&gt; v0.2.18: Release EMHASS add-on v0.2.18 · davidusb-geek/emhass-add-on · GitHub Added new sensors for the grid power and the total value of the cost function after an optimization. Added a new method to obtain a mix forecast and take into account now/current measured values. This will work when using MPC optimization and you can define the two new runtime parameters alpha and beta as passed data when calling naive-mpc-optim . See this description in the docs: The forecast module — emhass 0.3.16 documentation Improved the documentation a little (still some work to do on this)
----------------------------------------

【89楼】 - markpurcell
回复时间: 2022-06-13T06:39:35.818Z
----------------------------------------
emhass with the ‘now’ values really makes a smooth set of calculations for its forecasts. Below you can see the measured values in the top graphic and the forecast values from emhass, running mpc-optim every minute. image 526×959 53.5 KB I really like how you can see the grid power forecast at 3:40 pm slowly increment up as the PV production reduces to maintain the fixed load (5.5 kW for deferrable1 - my pool heater) and then at 4pm deferrable2 my variable EV charger matches PV production minus the baseload and slowly increments down with PV production. At about 3:30pm you can see deferrable1 switch on and off and on and off and on. I have a hysteresis delay (5 minutes on, 2 minutes off), to smooth out the switching so these rapid changes aren’t actually passed through to the heater pump. You can see some slight differences to the forecasts, at 2:40pm my battery is charging instead of deferrable1 (my pool heater) operating, I intervened getting the battery SOC to 100% before sunset. At 3:40pm the battery was discharging (top graphic), whilst the bottom graphic wanted to draw from the grid, I am still trying to get that level of fine control over my battery.
----------------------------------------

【90楼】 - davidusb
回复时间: 2022-06-13T08:57:28.299Z
----------------------------------------
Nice to see the improvements working! markpurcell: You can see some slight differences to the forecasts, at 2:40pm my battery is charging instead of deferrable1 (my pool heater) operating, I intervened getting the battery SOC to 100% before sunset. The fine tuning is very case specific. These should be sorted out with custom automation rules. I saw that you had already worked out a lot of these specific rules. EMHASS should be used as a top level intelligent energy management, but you will still need those low level rule-based management for fine tuning. As for the new mixed forecast using now/current values, you can play with the settings of the weight of now values over forecast values that will be used. This is done by passing parameters alpha and beta at runtime. They are both fixed by default at 0.5. See the equation for this here in the docs: The forecast module — emhass 0.8.0 documentation Cheers
----------------------------------------

【91楼】 - Gunth
回复时间: 2022-07-05T13:45:20.524Z
----------------------------------------
I tried to install this addon but when trigger a perfect-optim i recieve a error in my log, did i miss somthing in my configuration ? I’m running it as an add-on for Home Assistant OS with the latest version (0.2.19) [2022-06-30 20:00:34,713] ERROR in optimization: It was not possible to find a valid solver for Pulp package [2022-06-30 20:00:34,715] INFO in optimization: Status: Not Solved [2022-06-30 20:00:34,715] WARNING in optimization: Cost function cannot be evaluated, probably None [2022-06-30 20:00:34,729] ERROR in app: Exception on /action/perfect-optim [POST] Traceback (most recent call last): File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 2077, in wsgi_app response = self.full_dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1525, in full_dispatch_request rv = self.handle_user_exception(e) File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1523, in full_dispatch_request rv = self.dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1509, in dispatch_request return self.ensure_sync(self.view_functions[rule.endpoint])(**req.view_args) File "/usr/local/lib/python3.9/dist-packages/emhass/web_server.py", line 143, in action_call opt_res = perfect_forecast_optim(input_data_dict, app.logger) File "/usr/local/lib/python3.9/dist-packages/emhass/command_line.py", line 161, in perfect_forecast_optim opt_res = input_data_dict['opt'].perform_perfect_forecast_optim(df_input_data, input_data_dict['days_list']) File "/usr/local/lib/python3.9/dist-packages/emhass/optimization.py", line 460, in perform_perfect_forecast_optim opt_tp = self.perform_optimization(data_tp, P_PV, P_load, File "/usr/local/lib/python3.9/dist-packages/emhass/optimization.py", line 384, in perform_optimization opt_tp["P_grid"] = [P_grid_pos[i].varValue + P_grid_neg[i].varValue for i in set_I] File "/usr/local/lib/python3.9/dist-packages/emhass/optimization.py", line 384, in &lt;listcomp&gt; opt_tp["P_grid"] = [P_grid_pos[i].varValue + P_grid_neg[i].varValue for i in set_I] TypeError: unsupported operand type(s) for +: 'NoneType' and 'NoneType'
----------------------------------------

【92楼】 - davidusb
回复时间: 2022-07-05T14:10:30.658Z
----------------------------------------
Hi, as the log says, the system did not found a valid solver. The default solver works just fine on amd64 machines, but not so in others. You just need to modify the solver in the configuration params. This can be controlled in the configuration file with parameters lp_solver and lp_solver_path . The options for lp_solver are: ‘PULP_CBC_CMD’, ‘GLPK_CMD’ and ‘COIN_CMD’. If using ‘COIN_CMD’ as the solver you will need to provide the correct path to this solver in parameter lp_solver_path , ex: ‘/usr/bin/cbc’.
----------------------------------------

【93楼】 - Gunth
回复时间: 2022-07-05T14:25:17.449Z
----------------------------------------
davidusb: GLPK_CMD Thanks it work with GLPK_CMD, i 'm running the addon on a Raspberry Pi4 that’s the reason why it was failing …
----------------------------------------

【94楼】 - haraldov
回复时间: 2022-07-07T10:44:42.425Z
----------------------------------------
I installed the Emhass addon and in the configuration changed the default sensor to: - name: "Power_load_no_var_loads" unit_of_measurement: "W" device_class: power state: &gt; {% set powerload = states('sensor.power_adresse_xx') | float(default=0) %} {% set vvb = states('sensor.bryter_varmvannsbereder_electric_consumed_w') | float(default=0) %} {% set vaskemaskin = states('sensor.strombryter_vaskemaskin_electrical_measurement') | float(default=0) %} {% set value = ( powerload - vvb - vaskemaskin) | round(1,default=0) %} {{ value }} When I trigger a “Perfect optimization” or “Day-ahead optimization” I get error in the log. The recorded history of sensor.power_load_no_var_loads is only one day old. Is this error related to how many days the recorder has kept the data? [2022-07-07 12:35:35,609] INFO in command_line: Setting up needed data [2022-07-07 12:35:35,615] INFO in retrieve_hass: Retrieve hass get data method initiated... [2022-07-07 12:35:35,652] ERROR in retrieve_hass: The retrieved JSON is empty, check that correct day or variable names are passed [2022-07-07 12:35:35,653] ERROR in retrieve_hass: Either the names of the passed variables are not correct or days_to_retrieve is larger than the recorded history of your sensor (check your recorder settings) [2022-07-07 12:35:35,653] ERROR in app: Exception on /action/perfect-optim [POST] Traceback (most recent call last): File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 2077, in wsgi_app response = self.full_dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1525, in full_dispatch_request rv = self.handle_user_exception(e) File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1523, in full_dispatch_request rv = self.dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1509, in dispatch_request return self.ensure_sync(self.view_functions[rule.endpoint])(**req.view_args) File "/usr/local/lib/python3.9/dist-packages/emhass/web_server.py", line 134, in action_call input_data_dict = set_input_data_dict(config_path, str(config_path.parent), costfun, File "/usr/local/lib/python3.9/dist-packages/emhass/command_line.py", line 64, in set_input_data_dict rh.get_data(days_list, var_list, File "/usr/local/lib/python3.9/dist-packages/emhass/retrieve_hass.py", line 130, in get_data self.df_final = pd.concat([self.df_final, df_day], axis=0) UnboundLocalError: local variable 'df_day' referenced before assignment [2022-07-07 12:35:36,992] INFO in command_line: Setting up needed data [2022-07-07 12:35:36,994] INFO in forecast: Retrieving weather forecast data using method = scrapper [2022-07-07 12:35:39,318] INFO in forecast: Retrieving data from hass for load forecast using method = naive [2022-07-07 12:35:39,319] INFO in retrieve_hass: Retrieve hass get data method initiated... [2022-07-07 12:35:39,328] ERROR in retrieve_hass: The retrieved JSON is empty, check that correct day or variable names are passed [2022-07-07 12:35:39,328] ERROR in retrieve_hass: Either the names of the passed variables are not correct or days_to_retrieve is larger than the recorded history of your sensor (check your recorder settings) [2022-07-07 12:35:39,328] ERROR in app: Exception on /action/dayahead-optim [POST] Traceback (most recent call last): File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 2077, in wsgi_app response = self.full_dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1525, in full_dispatch_request rv = self.handle_user_exception(e) File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1523, in full_dispatch_request rv = self.dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1509, in dispatch_request return self.ensure_sync(self.view_functions[rule.endpoint])(**req.view_args) File "/usr/local/lib/python3.9/dist-packages/emhass/web_server.py", line 134, in action_call input_data_dict = set_input_data_dict(config_path, str(config_path.parent), costfun, File "/usr/local/lib/python3.9/dist-packages/emhass/command_line.py", line 77, in set_input_data_dict P_load_forecast = fcst.get_load_forecast(method=optim_conf['load_forecast_method']) File "/usr/local/lib/python3.9/dist-packages/emhass/forecast.py", line 476, in get_load_forecast rh.get_data(days_list, var_list) File "/usr/local/lib/python3.9/dist-packages/emhass/retrieve_hass.py", line 130, in get_data self.df_final = pd.concat([self.df_final, df_day], axis=0) UnboundLocalError: local variable 'df_day' referenced before assignment
----------------------------------------

【95楼】 - haraldov
回复时间: 2022-07-07T14:15:22.667Z
----------------------------------------
The perfect optimization are now running without error. I was solved when I waited 2 days (historic_days_to_retrieve). The day-ahead optimization is still giving error, but I hope it is solved when I wait a few hours. [2022-07-07 16:04:14,019] INFO in web_server: EMHASS server online, serving index.html... [2022-07-07 16:04:16,751] INFO in command_line: Setting up needed data [2022-07-07 16:04:16,755] INFO in retrieve_hass: Retrieve hass get data method initiated... [2022-07-07 16:04:17,091] INFO in web_server: &gt;&gt; Performing perfect optimization... [2022-07-07 16:04:17,091] INFO in command_line: Performing perfect forecast optimization [2022-07-07 16:04:17,093] INFO in optimization: Perform optimization for perfect forecast scenario [2022-07-07 16:04:17,094] INFO in optimization: Solving for day: 5-7-2022 [2022-07-07 16:04:17,162] INFO in optimization: Status: Optimal [2022-07-07 16:04:17,163] INFO in optimization: Total value of the Cost function = -2.31 [2022-07-07 16:04:17,171] INFO in optimization: Solving for day: 6-7-2022 [2022-07-07 16:04:17,222] INFO in optimization: Status: Optimal [2022-07-07 16:04:17,222] INFO in optimization: Total value of the Cost function = -4.5 /usr/local/lib/python3.9/dist-packages/emhass/web_server.py:46: FutureWarning: Dropping of nuisance columns in DataFrame reductions (with 'numeric_only=None') is deprecated; in a future version this will raise TypeError. Select only valid columns before calling the reduction.
----------------------------------------

【96楼】 - davidusb
回复时间: 2022-07-07T21:14:17.927Z
----------------------------------------
Ok, nice that the perfect optimization is running, effectively the historic_days_to_retrieve has to match the available data on your HA database. What is the error on the day-ahead optimization?
----------------------------------------

【97楼】 - haraldov
回复时间: 2022-07-08T01:05:51.320Z
----------------------------------------
When I push the “Day-Ahead Optimization” button in the web page I get this: “ERROR in retrieve_hass”. But when I push the “Perfect Optimization” I do not get the error. Home Assistant 2022.7.0 Supervisor 2022.07.0 Operating System 8.2 Frontend 20220706.0 - latest 2022-07-08 02:59:14,383] INFO in web_server: EMHASS server online, serving index.html... [2022-07-08 02:59:26,345] INFO in command_line: Setting up needed data [2022-07-08 02:59:26,372] INFO in forecast: Retrieving weather forecast data using method = scrapper [2022-07-08 02:59:27,715] INFO in forecast: Retrieving data from hass for load forecast using method = naive [2022-07-08 02:59:27,716] INFO in retrieve_hass: Retrieve hass get data method initiated... [2022-07-08 02:59:27,724] ERROR in retrieve_hass: The retrieved JSON is empty, check that correct day or variable names are passed [2022-07-08 02:59:27,725] ERROR in retrieve_hass: Either the names of the passed variables are not correct or days_to_retrieve is larger than the recorded history of your sensor (check your recorder settings) [2022-07-08 02:59:27,725] ERROR in app: Exception on /action/dayahead-optim [POST] Traceback (most recent call last): File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 2077, in wsgi_app response = self.full_dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1525, in full_dispatch_request rv = self.handle_user_exception(e) File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1523, in full_dispatch_request rv = self.dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1509, in dispatch_request return self.ensure_sync(self.view_functions[rule.endpoint])(**req.view_args) File "/usr/local/lib/python3.9/dist-packages/emhass/web_server.py", line 134, in action_call input_data_dict = set_input_data_dict(config_path, str(config_path.parent), costfun, File "/usr/local/lib/python3.9/dist-packages/emhass/command_line.py", line 77, in set_input_data_dict P_load_forecast = fcst.get_load_forecast(method=optim_conf['load_forecast_method']) File "/usr/local/lib/python3.9/dist-packages/emhass/forecast.py", line 476, in get_load_forecast rh.get_data(days_list, var_list) File "/usr/local/lib/python3.9/dist-packages/emhass/retrieve_hass.py", line 130, in get_data self.df_final = pd.concat([self.df_final, df_day], axis=0) UnboundLocalError: local variable 'df_day' referenced before assignment [2022-07-08 02:59:55,840] INFO in command_line: Setting up needed data [2022-07-08 02:59:55,843] INFO in retrieve_hass: Retrieve hass get data method initiated... [2022-07-08 02:59:56,325] INFO in web_server: &gt;&gt; Performing perfect optimization... [2022-07-08 02:59:56,325] INFO in command_line: Performing perfect forecast optimization [2022-07-08 02:59:56,328] INFO in optimization: Perform optimization for perfect forecast scenario [2022-07-08 02:59:56,328] INFO in optimization: Solving for day: 6-7-2022 [2022-07-08 02:59:56,417] INFO in optimization: Status: Optimal [2022-07-08 02:59:56,418] INFO in optimization: Total value of the Cost function = -8.68 [2022-07-08 02:59:56,423] INFO in optimization: Solving for day: 7-7-2022 [2022-07-08 02:59:56,483] INFO in optimization: Status: Optimal [2022-07-08 02:59:56,484] INFO in optimization: Total value of the Cost function = -6.87 /usr/local/lib/python3.9/dist-packages/emhass/web_server.py:46: FutureWarning: Dropping of nuisance columns in DataFrame reductions (with 'numeric_only=None') is deprecated; in a future version this will raise TypeError. Select only valid columns before calling the reduction.
----------------------------------------

【98楼】 - davidusb
回复时间: 2022-07-08T06:34:17.273Z
----------------------------------------
In your configuration you need to check that in both var_PV and var_load , they have the correct name as in your HA sensors and yes that there is enough history data.
----------------------------------------

【99楼】 - haraldov
回复时间: 2022-07-08T08:57:00.423Z
----------------------------------------
I suspect the ha recorder does not have enough data for “sensor.power_adresse_xx” (only one and a half day recording). I will wait. I am going to report back later. - name: "Power_load_no_var_loads" unit_of_measurement: "W" device_class: power state: &gt; {% set powerload = states('sensor.power_adresse_xx') | float(default=0) %} {% set vvb = states('sensor.bryter_varmvannsbereder_electric_consumed_w') | float(default=0) %} {% set vaskemaskin = states('sensor.strombryter_vaskemaskin_electrical_measurement') | float(default=0) %} {% set value = ( powerload - vvb - vaskemaskin) | round(1,default=0) %} {{ value }}
----------------------------------------

【100楼】 - haraldov
回复时间: 2022-07-08T20:15:30.063Z
----------------------------------------
haraldov: When I push the “Day-Ahead Optimization” button in the web page I get this: “ERROR in retrieve_hass”. The “Day-Ahead Optimization” is now working. The solution was to wait for 2 days of recording. Next question: I have 12 solar cell modules (REC_Solar_REC295TP2) on my garage roof with three AP System QS1 microinvertere ( Discontinued APsystems QS1 - APsystems USA | The global leader in multi-platform MLPE technology ) placed in the center with four solar cell modules attached. So I have 12 panels and 3 QS1 microinverteres. The microinverters are attached to one 220 V power cabel. On the house roof I have 6 solar cell modules (REC_Solar_REC295TP2). Four of the panels are attaced to one QS1 and two of them are attached to APSystem YC600. So I have 6 panels and 1 QS1 microinverteres + 1 YC600 ( Discontinued APsystems YC600 - APsystems USA | The global leader in multi-platform MLPE technology ) pr string. The microinverters are attached to one 220 V power cabel. Can you verify if pv configuration is correct? I know the “list_surface_tilt” and “list_surface_azimuth” is not correct. I must measure it outside first. image 660×710 28 KB image 296×710 13.3 KB
----------------------------------------

【101楼】 - davidusb
回复时间: 2022-07-08T21:48:09.472Z
----------------------------------------
Great! From your description your configuration seems good to me. What you should do is validate that it is good by comparing the PV forecast that will be produced with your actual power production. If they match very well on a clear sky day then it is validated.
----------------------------------------

【102楼】 - JG_smart
回复时间: 2022-07-28T22:22:42.045Z
----------------------------------------
I’m trying to configure emhass on my home assistant installation running on a Raspberry Pi 4 rpi4-64. I’ll get errors when using my selected pv_module and pv_inverter. Maybe I don’t apply the right number of _? or is there a bug? I figured out which pv-module is most similar to my panels (as my panels from Bauer are not listed in the csv file), so I choose: Vietnam Sunergy Joint Stock Company VSUN380-120BMH Same for the inverter, but luckily the vendor exist, only diff is that my inverter is a 4.6KTL: Huawei Technologies Co Ltd : SUN2000-5KTL-USL0 [240V] When applying config, starting emhass and launching day-ahead optimization from the web-ui I get following log entries: s6-rc: info: service s6rc-oneshot-runner: starting s6-rc: info: service s6rc-oneshot-runner successfully started s6-rc: info: service fix-attrs: starting s6-rc: info: service fix-attrs successfully started s6-rc: info: service legacy-cont-init: starting s6-rc: info: service legacy-cont-init successfully started s6-rc: info: service legacy-services: starting services-up: info: copying legacy longrun emhass (no readiness notification) s6-rc: info: service legacy-services successfully started [2022-07-27 23:23:23,463] INFO in web_server: Launching the emhass webserver at: http://0.0.0.0:5000 [2022-07-27 23:23:23,464] INFO in web_server: Home Assistant data fetch will be performed using url: http://supervisor/core/api [2022-07-27 23:23:23,466] INFO in web_server: The base path is: /usr/src [2022-07-27 23:23:23,474] INFO in web_server: Using core emhass version: 0.3.17 [2022-07-27 23:23:32,087] INFO in web_server: EMHASS server online, serving index.html... [2022-07-27 23:24:21,390] INFO in command_line: Setting up needed data [2022-07-27 23:24:21,479] INFO in forecast: Retrieving weather forecast data using method = scrapper [2022-07-27 23:24:24,611] ERROR in app: Exception on /action/dayahead-optim [POST] Traceback (most recent call last): File "/root/.local/lib/python3.9/site-packages/pandas/core/indexes/base.py", line 3621, in get_loc return self._engine.get_loc(casted_key) File "pandas/_libs/index.pyx", line 136, in pandas._libs.index.IndexEngine.get_loc File "pandas/_libs/index.pyx", line 163, in pandas._libs.index.IndexEngine.get_loc File "pandas/_libs/hashtable_class_helper.pxi", line 5198, in pandas._libs.hashtable.PyObjectHashTable.get_item File "pandas/_libs/hashtable_class_helper.pxi", line 5206, in pandas._libs.hashtable.PyObjectHashTable.get_item KeyError: 'Vietnam_Sunergy_Joint_Stock_Company_VSUN380_120BMH' The above exception was the direct cause of the following exception: Traceback (most recent call last): File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 2077, in wsgi_app response = self.full_dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1525, in full_dispatch_request rv = self.handle_user_exception(e) File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1523, in full_dispatch_request rv = self.dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1509, in dispatch_request return self.ensure_sync(self.view_functions[rule.endpoint])(**req.view_args) File "/usr/local/lib/python3.9/dist-packages/emhass/web_server.py", line 134, in action_call input_data_dict = set_input_data_dict(config_path, str(config_path.parent), costfun, File "/usr/local/lib/python3.9/dist-packages/emhass/command_line.py", line 76, in set_input_data_dict P_PV_forecast = fcst.get_power_from_weather(df_weather) File "/usr/local/lib/python3.9/dist-packages/emhass/forecast.py", line 317, in get_power_from_weather module = cec_modules[self.plant_conf['module_model'][i]] File "/root/.local/lib/python3.9/site-packages/pandas/core/frame.py", line 3505, in __getitem__ indexer = self.columns.get_loc(key) File "/root/.local/lib/python3.9/site-packages/pandas/core/indexes/base.py", line 3623, in get_loc raise KeyError(key) from err KeyError: 'Vietnam_Sunergy_Joint_Stock_Company_VSUN380_120BMH' When replacing the pv-module name in the config with the documentation example: CSUN_Eurasia_Energy_Systems_Industry_and_Trade_CSUN295_60M I’ll get this: s6-rc: info: service s6rc-oneshot-runner: starting s6-rc: info: service s6rc-oneshot-runner successfully started s6-rc: info: service fix-attrs: starting s6-rc: info: service fix-attrs successfully started s6-rc: info: service legacy-cont-init: starting s6-rc: info: service legacy-cont-init successfully started s6-rc: info: service legacy-services: starting services-up: info: copying legacy longrun emhass (no readiness notification) s6-rc: info: service legacy-services successfully started [2022-07-27 23:34:08,710] INFO in web_server: Launching the emhass webserver at: http://0.0.0.0:5000 [2022-07-27 23:34:08,710] INFO in web_server: Home Assistant data fetch will be performed using url: http://supervisor/core/api [2022-07-27 23:34:08,711] INFO in web_server: The base path is: /usr/src [2022-07-27 23:34:08,718] INFO in web_server: Using core emhass version: 0.3.17 [2022-07-27 23:34:21,858] INFO in web_server: EMHASS server online, serving index.html... [2022-07-27 23:34:33,264] INFO in command_line: Setting up needed data [2022-07-27 23:34:33,353] INFO in forecast: Retrieving weather forecast data using method = scrapper [2022-07-27 23:34:35,533] ERROR in app: Exception on /action/dayahead-optim [POST] Traceback (most recent call last): File "/root/.local/lib/python3.9/site-packages/pandas/core/indexes/base.py", line 3621, in get_loc return self._engine.get_loc(casted_key) File "pandas/_libs/index.pyx", line 136, in pandas._libs.index.IndexEngine.get_loc File "pandas/_libs/index.pyx", line 163, in pandas._libs.index.IndexEngine.get_loc File "pandas/_libs/hashtable_class_helper.pxi", line 5198, in pandas._libs.hashtable.PyObjectHashTable.get_item File "pandas/_libs/hashtable_class_helper.pxi", line 5206, in pandas._libs.hashtable.PyObjectHashTable.get_item KeyError: 'Huawei_Technologies_Co_Ltd___SUN2000_5KTL_USL0__240V_' The above exception was the direct cause of the following exception: Traceback (most recent call last): File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 2077, in wsgi_app response = self.full_dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1525, in full_dispatch_request rv = self.handle_user_exception(e) File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1523, in full_dispatch_request rv = self.dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1509, in dispatch_request return self.ensure_sync(self.view_functions[rule.endpoint])(**req.view_args) File "/usr/local/lib/python3.9/dist-packages/emhass/web_server.py", line 134, in action_call input_data_dict = set_input_data_dict(config_path, str(config_path.parent), costfun, File "/usr/local/lib/python3.9/dist-packages/emhass/command_line.py", line 76, in set_input_data_dict P_PV_forecast = fcst.get_power_from_weather(df_weather) File "/usr/local/lib/python3.9/dist-packages/emhass/forecast.py", line 318, in get_power_from_weather inverter = cec_inverters[self.plant_conf['inverter_model'][i]] File "/root/.local/lib/python3.9/site-packages/pandas/core/frame.py", line 3505, in __getitem__ indexer = self.columns.get_loc(key) File "/root/.local/lib/python3.9/site-packages/pandas/core/indexes/base.py", line 3623, in get_loc raise KeyError(key) from err KeyError: 'Huawei_Technologies_Co_Ltd___SUN2000_5KTL_USL0__240V_'
----------------------------------------

【103楼】 - davidusb
回复时间: 2022-07-29T12:53:09.274Z
----------------------------------------
Hi, I’ve just answered you on github: https://github.com/davidusb-geek/emhass-add-on/issues/23 Everything should be fine but you’ll need to find a module name from the database. The inverter name does exists in the database.
----------------------------------------

【104楼】 - JG_smart
回复时间: 2022-08-01T12:03:09.443Z
----------------------------------------
Thanks @davidusb , I’ll respond on github
----------------------------------------

【105楼】 - KasperEdw
回复时间: 2022-08-02T22:27:18.310Z
----------------------------------------
is there a way to integrate variable tariffs in EMHASS? In Denmark (and Scandinavia) we get hourly prices from Nordpool. ( Market data | Nord Pool ), they are published for the next 24 hours every day at 13.00 CET, showing the hourly rate. It can be used in HomeAssistant with the Nordpool integration. With the current price fluctuations it would be really useful to have EMHASS determine usage and charging based on nordpool prices or whatever entity sets the power prices in your area.
----------------------------------------

【106楼】 - markpurcell
回复时间: 2022-08-02T22:44:57.733Z
----------------------------------------
I do exactly this with my energy provider Amber, who change the price forecasts every five minutes based off or national energy market. EMHASS is ideal for this scenario as it will create an optimum scheduled based on these variables. Although your case of a single daily price update is simpler to implement. It will be good to have more users on with variable pricing. You can see some configuration snippets here: The forecast module — emhass 0.3.17 documentation and my EMHASS forecast plan for today: Screenshot_20220803-083512 864×1920 188 KB
----------------------------------------

【107楼】 - davidusb
回复时间: 2022-08-03T05:16:15.778Z
----------------------------------------
Hi, thanks to Mark for the fast answer. So yes this is totally possible. Take a look at the documentation link provided by Mark. There are several examples to do this. You’ll just basically need to use templates to convert the prices provided by the Nordpool integration into a list of values and then pass the list when calling the EMHASS optimization routine.
----------------------------------------

【108楼】 - KasperEdw
回复时间: 2022-08-03T08:13:01.763Z
----------------------------------------
Thanks a lot for the replies. This is great and just what I have been looking for. It will be fun to get this working
----------------------------------------

【109楼】 - mirecekd
回复时间: 2022-08-21T20:42:38.076Z
----------------------------------------
Hi David, could you please add examples how to calculate alpha and beta values to documentation? Thanks Mirek
----------------------------------------

【110楼】 - davidusb
回复时间: 2022-08-22T14:11:41.179Z
----------------------------------------
Hi Mirek, I’ve just updated the documentation on this part here: The forecast module — emhass 0.3.17 documentation I hope it helps…
----------------------------------------

【111楼】 - haraldov
回复时间: 2022-08-25T17:39:49.156Z
----------------------------------------
davidusb: You’ll just basically need to use templates to convert the prices provided by the Nordpool integration into a list of values and then pass the list when calling the EMHASS optimization routine. I am trying to pass the Nordpool cost prices raw_today + raw_tomorrow, but the unit_load_cost do not get updated. Why doesn’t this work? I use this template to pass the cost price value to the list: 'curl -i -H "Content-Type: application/json" -X POST -d '{"load_cost_forecast": {{ ((( state_attr('sensor.nordpool', 'raw_today') + state_attr('sensor.nordpool', 'raw_tomorrow')) |map(attribute='value')|list)[:48]) }}' http://localhost:5000/action/dayahead-optim' bilde 774×236 12.1 KB and this shell_command to pass the list to emhass: shell_command: load_cost_forecast: "curl -i -H \"Content-Type: application/json\" -X POST -d '{\"load_cost_forecast\": {{ ((( state_attr('sensor.nordpool', 'raw_today') + state_attr('sensor.nordpool', 'raw_tomorrow')) |map(attribute='value')|list)[:48]) }}' http://localhost:5000/action/dayahead-optim" The shell_command debug says the command returned successful: ➜ config tail -100 home-assistant.log | grep "homeassistant.components.shell_command" 2022-08-25 19:08:30.940 DEBUG (MainThread) [homeassistant.components.shell_command] Stdout of command: `curl -i -H "Content-Type: application/json" -X POST -d '{"load_cost_forecast": {{ ((( state_attr('sensor.nordpool', 'raw_today') + state_attr('sensor.nordpool', 'raw_tomorrow')) |map(attribute='value')|list)[:48]) }}' http://localhost:5000/action/dayahead-optim`, return code: 0: 2022-08-25 19:08:30.941 DEBUG (MainThread) [homeassistant.components.shell_command] Stderr of command: `curl -i -H "Content-Type: application/json" -X POST -d '{"load_cost_forecast": {{ ((( state_attr('sensor.nordpool', 'raw_today') + state_attr('sensor.nordpool', 'raw_tomorrow')) |map(attribute='value')|list)[:48]) }}' http://localhost:5000/action/dayahead-optim`, return code: 0: bilde 1679×314 34.1 KB I use the emhass addon version 0.2.19 with this config: bilde 317×774 15.2 KB The emhass log: [2022-08-25 19:03:08,159] INFO in web_server: EMHASS server online, serving index.html... [2022-08-25 19:08:49,585] INFO in web_server: EMHASS server online, serving index.html... [2022-08-25 19:09:29,125] INFO in command_line: Setting up needed data [2022-08-25 19:09:29,368] INFO in forecast: Retrieving weather forecast data using method = scrapper [2022-08-25 19:09:32,306] INFO in web_server: EMHASS server online, serving index.html... [2022-08-25 19:09:35,093] INFO in forecast: Retrieving data from hass for load forecast using method = naive [2022-08-25 19:09:35,096] INFO in retrieve_hass: Retrieve hass get data method initiated... [2022-08-25 19:09:58,215] INFO in web_server: &gt;&gt; Performing dayahead optimization... [2022-08-25 19:09:58,216] INFO in command_line: Performing day-ahead forecast optimization [2022-08-25 19:09:58,227] INFO in optimization: Perform optimization for the day-ahead [2022-08-25 19:09:58,823] INFO in optimization: Status: Optimal [2022-08-25 19:09:58,825] INFO in optimization: Total value of the Cost function = -3.61 /usr/local/lib/python3.9/dist-packages/emhass/web_server.py:46: FutureWarning: Dropping of nuisance columns in DataFrame reductions (with 'numeric_only=None') is deprecated; in a future version this will raise TypeError. Select only valid columns before calling the reduction. [2022-08-25 19:19:45,309] INFO in web_server: EMHASS server online, serving index.html... [2022-08-25 19:29:24,315] INFO in web_server: EMHASS server online, serving index.html...
----------------------------------------

【112楼】 - davidusb
回复时间: 2022-08-27T20:55:40.286Z
----------------------------------------
Hi, I just can’t what is wrong here. This is just working fine for me and there is a specific unit test in the code to test for this and everything seems fine. What is the Home Assistant log saying when you execute that shell command? Please open a github issue to follow this more in detail there.
----------------------------------------

【113楼】 - haraldov
回复时间: 2022-09-02T17:10:17.562Z
----------------------------------------
@KasperEdw I solved it! I found out I have done two errors. The first was passing wrong amount of data in this list. Nordpool publish prices for every hour so the list must have 24 data points, not 48 points. You need to be careful here to send the correct amount of data on this list, the correct length. For example, if the data time step is defined to 1h and you are performing a day-ahead optimization, then this list length should be of 24 data points. In the emhass configuration you must also have 60 (minuts) for optimization_time_step. The price data must also be for the next day and price data must be in Euro. When you setup Nordpool addon you can choose Euro as the price data. Update: You can use whatever currency you want as long as you use the same currency everywhere. The second was using template with errors. My template was wrong with the parenthesis and curly bracket. After fixing the template the shell_command worked and the passing of load_cost_forecast and prod_price_forecast was successful. Here is the correct template for passing forecast data from Nordpool. shell_command: publish_data: "curl -i -H 'Content-Type:application/json' -X POST -d '{}' http://localhost:5000/action/publish-data" post_nordpool_forecast: "curl -i -H 'Content-Type: application/json' -X POST -d '{\"load_cost_forecast\":{{( (state_attr('sensor.nordpool_euro', 'raw_tomorrow')|map(attribute='value')|list)[:24]) }},\"prod_price_forecast\":{{( (state_attr('sensor.nordpool_euro', 'raw_tomorrow')|map(attribute='value')|list)[:24])}}}' http://localhost:5000/action/dayahead-optim" Hope it helps others
----------------------------------------

【114楼】 - xxgmxx
回复时间: 2022-09-03T22:16:15.602Z
----------------------------------------
Hi guys! I am struggling with the initial config, as long as I am not changing the hass_url from the default “empty” I get EMHASS UI running without any data from HA. With the hass_url changed I get this error message: s6-rc: info: service s6rc-oneshot-runner: starting s6-rc: info: service s6rc-oneshot-runner successfully started s6-rc: info: service fix-attrs: starting s6-rc: info: service fix-attrs successfully started s6-rc: info: service legacy-cont-init: starting s6-rc: info: service legacy-cont-init successfully started s6-rc: info: service legacy-services: starting services-up: info: copying legacy longrun emhass (no readiness notification) s6-rc: info: service legacy-services successfully started Traceback (most recent call last): File "/usr/local/lib/python3.9/dist-packages/requests/models.py", line 971, in json return complexjson.loads(self.text, **kwargs) File "/usr/lib/python3.9/json/__init__.py", line 346, in loads return _default_decoder.decode(s) File "/usr/lib/python3.9/json/decoder.py", line 337, in decode obj, end = self.raw_decode(s, idx=_w(s, 0).end()) File "/usr/lib/python3.9/json/decoder.py", line 355, in raw_decode raise JSONDecodeError("Expecting value", s, err.value) from None json.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0) During handling of the above exception, another exception occurred: Traceback (most recent call last): File "/usr/lib/python3.9/runpy.py", line 197, in _run_module_as_main return _run_code(code, main_globals, None, File "/usr/lib/python3.9/runpy.py", line 87, in _run_code exec(code, run_globals) File "/usr/local/lib/python3.9/dist-packages/emhass/web_server.py", line 241, in &lt;module&gt; config_hass = response.json() File "/usr/local/lib/python3.9/dist-packages/requests/models.py", line 975, in json raise RequestsJSONDecodeError(e.msg, e.doc, e.pos) requests.exceptions.JSONDecodeError: Expecting value: line 1 column 1 (char 0) With this config: web_ui_url: 0.0.0.0 hass_url: https://xxx:8123/ long_lived_token: empty costfun: self-consumption optimization_time_step: 30 historic_days_to_retrieve: 2 method_ts_round: nearest set_total_pv_sell: false lp_solver: PULP_CBC_CMD lp_solver_path: empty sensor_power_photovoltaics: sensor.pv_power sensor_power_load_no_var_loads: sensor.house_consumption number_of_deferrable_loads: 2 list_nominal_power_of_deferrable_loads: - nominal_power_of_deferrable_loads: 3000 - nominal_power_of_deferrable_loads: 750 list_operating_hours_of_each_deferrable_load: - operating_hours_of_each_deferrable_load: 5 - operating_hours_of_each_deferrable_load: 8 list_peak_hours_periods_start_hours: - peak_hours_periods_start_hours: "02:54" - peak_hours_periods_start_hours: "17:24" list_peak_hours_periods_end_hours: - peak_hours_periods_end_hours: "15:24" - peak_hours_periods_end_hours: "20:24" list_treat_deferrable_load_as_semi_cont: - treat_deferrable_load_as_semi_cont: true - treat_deferrable_load_as_semi_cont: true load_peak_hours_cost: 0.1907 load_offpeak_hours_cost: 0.1419 photovoltaic_production_sell_price: 0.065 maximum_power_from_grid: 22080 list_pv_module_model: - pv_module_model: IBEX-132MHC-EiGER-495-500 list_pv_inverter_model: - pv_inverter_model: GoodWe_10K_ET_Plus+ list_surface_tilt: - surface_tilt: 25 list_surface_azimuth: - surface_azimuth: 205 list_modules_per_string: - modules_per_string: 6 list_strings_per_inverter: - strings_per_inverter: 2 set_use_battery: false battery_discharge_power_max: 6390 battery_charge_power_max: 6390 battery_discharge_efficiency: 0.95 battery_charge_efficiency: 0.95 battery_nominal_energy_capacity: 10668 battery_minimum_state_of_charge: 0.2 battery_maximum_state_of_charge: 1 battery_target_state_of_charge: 0.6 Could anyone point me in the right direction, please?
----------------------------------------

【115楼】 - davidusb
回复时间: 2022-09-04T01:24:33.225Z
----------------------------------------
Hi, you need to define the long_lived_token parameter, otherwise EMHASS won’t be able to access your HA instance data.
----------------------------------------

【116楼】 - xxgmxx
回复时间: 2022-09-04T07:00:40.918Z
----------------------------------------
Even if I use the long_lived_token the error is the same, however I do have a supervisor so I left it empty. Am I supposed to use the token under my admin profile, right? Same as the URL, which should not be needed with the supervisor. Maybe I am just messing around with wrong setting to get my problem solved. With the default config with supervisor like this web_ui_url: 0.0.0.0 hass_url: empty long_lived_token: empty I get no error, but the data are not fed into EMHASS at all. s6-rc: info: service s6rc-oneshot-runner: starting s6-rc: info: service s6rc-oneshot-runner successfully started s6-rc: info: service fix-attrs: starting s6-rc: info: service fix-attrs successfully started s6-rc: info: service legacy-cont-init: starting s6-rc: info: service legacy-cont-init successfully started s6-rc: info: service legacy-services: starting services-up: info: copying legacy longrun emhass (no readiness notification) s6-rc: info: service legacy-services successfully started [2022-09-04 09:24:00,823] INFO in web_server: Launching the emhass webserver at: http://0.0.0.0:5000 [2022-09-04 09:24:00,823] INFO in web_server: Home Assistant data fetch will be performed using url: http://supervisor/core/api [2022-09-04 09:24:00,824] INFO in web_server: The base path is: /usr/src [2022-09-04 09:24:00,828] INFO in web_server: Using core emhass version: 0.3.18 [2022-09-04 09:25:00,166] INFO in command_line: Setting up needed data [2022-09-04 09:25:00,318] INFO in web_server: &gt;&gt; Publishing data... [2022-09-04 09:25:00,320] INFO in command_line: Publishing data to HASS instance [2022-09-04 09:25:00,458] INFO in retrieve_hass: Successfully posted value in a newly created entity_id [2022-09-04 09:25:00,572] INFO in retrieve_hass: Successfully posted value in a newly created entity_id [2022-09-04 09:25:00,748] INFO in retrieve_hass: Successfully posted value in a newly created entity_id [2022-09-04 09:25:00,860] INFO in retrieve_hass: Successfully posted value in a newly created entity_id [2022-09-04 09:25:01,000] INFO in retrieve_hass: Successfully posted value in a newly created entity_id [2022-09-04 09:25:01,123] INFO in retrieve_hass: Successfully posted value in a newly created entity_id [2022-09-04 09:25:57,581] INFO in web_server: EMHASS server online, serving index.html... I can now access EMHASS UI, but it never gets updated, the data keep being the “default” one shown below. What could be the problem then? Thanks for any suggestions.
----------------------------------------

【117楼】 - davidusb
回复时间: 2022-09-04T11:28:42.408Z
----------------------------------------
Why do you say that no data is being fed to the add-on? You need to set some automations to launch the optimization tasks, have you already done this? The graph on the web ui won’t update until you launch an optimization task
----------------------------------------

【118楼】 - xxgmxx
回复时间: 2022-09-04T18:44:04.453Z
----------------------------------------
Thanks a lot for your help, I thought that no data is being fed, so I just checked the deferrable load entity from time to time if they got changed or not. I also changed some details in the configuration and later discovered that the UI got updated with all the data. The P_deferrable in UI is spot on, but I struggle to get it into HA. The reason why I said that no data is being fed is because of the log: [2022-09-04 20:25:00,808] INFO in web_server: &gt;&gt; Publishing data... [2022-09-04 20:25:00,809] INFO in command_line: Publishing data to HASS instance [2022-09-04 20:25:00,904] INFO in retrieve_hass: Successfully posted to sensor.p_pv_forecast = 1391.13 [2022-09-04 20:25:00,946] INFO in retrieve_hass: Successfully posted to sensor.p_load_forecast = 169.94 [2022-09-04 20:25:00,989] INFO in retrieve_hass: Successfully posted to sensor.p_deferrable0 = 0.0 [2022-09-04 20:25:01,033] INFO in retrieve_hass: Successfully posted to sensor.p_deferrable1 = 0.0 [2022-09-04 20:25:01,077] INFO in retrieve_hass: Successfully posted to sensor.p_grid_forecast = -1221.19 [2022-09-04 20:25:01,118] INFO in retrieve_hass: Successfully posted to sensor.total_cost_fun_value = -0.61 It just keeps publishing the “default” values, instead of the ones I am seeing in UI. image 1462×525 26.4 KB image 1260×190 13.4 KB I might be missing something totally obvious for you, but my lack of experience and language skills makes it quite challenging for me. Thanks for any suggestions. Little edit: EMHASS: An Energy Management for Home Assistant Custom Integrations Why do you say that no data is being fed to the add-on? You need to set some automations to launch the optimization tasks, have you already done this? The graph on the web ui won’t update until you launch an optimization task Just noticed that the result table does not contain data unless I manually press the Perfect Optimization. I do have these lines in /config/configuration.yaml image 907×88 5.57 KB And these lines in /config/automations.yaml Are those the automatization you were talking about? I hope I did not miss any.
----------------------------------------

【119楼】 - daman7cz
回复时间: 2022-09-08T20:13:19.584Z
----------------------------------------
Hello all, Seems to me I have issues with module and inverter name. If I understood well the documentation (chapter Configuration File) I need to find as close model as possible in SAM/deploy/libraries at develop · NREL/SAM · GitHub and to replace the special chars by underscore. If I use the model used in the example (‘CSUN_Eurasia_Energy_Systems_Industry_and_Trade_CSUN295_60M’ and ‘Fronius_International_GmbH__Fronius_Primo_5_0_1_208_240__240V_’) everything works. However if I try to insert ‘GoodWe_Technologies_Co___Ltd___GW9600A_ES__240V_’ or module ‘LONGi_Green_Energy_Technology_Co__Ltd__LR5_66HBD_490M’) I get following error message in log after clicking on Day-Ahead Optimization. See at the end of my post. Am I missing anything? Or I need to pass somehow the information about used module/invertor? Thank you [2022-09-08 22:02:24,044] ERROR in app: Exception on /action/dayahead-optim [POST] Traceback (most recent call last): File “/usr/local/lib/python3.9/dist-packages/pandas/core/indexes/base.py”, line 3621, in get_loc return self._engine.get_loc(casted_key) File “pandas/_libs/index.pyx”, line 136, in pandas._libs.index.IndexEngine.get_loc File “pandas/_libs/index.pyx”, line 163, in pandas._libs.index.IndexEngine.get_loc File “pandas/_libs/hashtable_class_helper.pxi”, line 5198, in pandas._libs.hashtable.PyObjectHashTable.get_item File "pandas/ libs/hashtable_class_helper.pxi", line 5206, in pandas. libs.hashtable.PyObjectHashTable.get_item KeyError: 'GoodWe_Technologies_Co___Ltd___GW9600A_ES__240V ’ The above exception was the direct cause of the following exception: Traceback (most recent call last): File “/usr/local/lib/python3.9/dist-packages/flask/app.py”, line 2525, in wsgi_app response = self.full_dispatch_request() File “/usr/local/lib/python3.9/dist-packages/flask/app.py”, line 1822, in full_dispatch_request rv = self.handle_user_exception(e) File “/usr/local/lib/python3.9/dist-packages/flask/app.py”, line 1820, in full_dispatch_request rv = self.dispatch_request() File “/usr/local/lib/python3.9/dist-packages/flask/app.py”, line 1796, in dispatch_request return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args) File “/usr/local/lib/python3.9/dist-packages/emhass/web_server.py”, line 134, in action_call input_data_dict = set_input_data_dict(config_path, str(config_path.parent), costfun, File “/usr/local/lib/python3.9/dist-packages/emhass/command_line.py”, line 76, in set_input_data_dict P_PV_forecast = fcst.get_power_from_weather(df_weather) File “/usr/local/lib/python3.9/dist-packages/emhass/forecast.py”, line 337, in get_power_from_weather inverter = cec_inverters[self.plant_conf[‘inverter_model’][i]] File “/usr/local/lib/python3.9/dist-packages/pandas/core/frame.py”, line 3505, in getitem indexer = self.columns.get_loc(key) File “/usr/local/lib/python3.9/dist-packages/pandas/core/indexes/base.py”, line 3623, in get_loc raise KeyError(key) from err KeyError: 'GoodWe_Technologies_Co___Ltd___GW9600A_ES__240V ’
----------------------------------------

【120楼】 - davidusb
回复时间: 2022-09-09T06:15:01.098Z
----------------------------------------
Hello, The problem is that your module and inverter models are not found in the database. This is a recurrent problem. You should look if your models are available. If they are not avalable, solution (1) is to pick another model as close as possible as yours in terms of the nominal power. The available module models are listed here: https://github.com/davidusb-geek/emhass-add-on/files/9234460/sam-library-cec-modules-2019-03-05.csv And the available inverter models are listed here: https://github.com/davidusb-geek/emhass-add-on/files/9532724/sam-library-cec-inverters-2019-03-05.csv Solution (2) would be to use SolCast and pass that data directly to emhass as a list of values from a template. Take a look at this example here: The forecast module — emhass 0.3.18 documentation I checked your module model and there are no 490W models or even 500W models on the database, so you are better off going with solution (2)
----------------------------------------

【121楼】 - xxgmxx
回复时间: 2022-09-09T10:01:31.254Z
----------------------------------------
Oh, now I can see the problem I am facing, the SAM library included in the EMHASS is not up to date, judging by the date in the file name " 2019-03-05 " I checked the file and did not find the module and inverter models, that I can see in the link documentation refers to: The complete list of supported modules and inverter models can be found here: pvlib.pvsystem.retrieve_sam — pvlib python 0.10.3 documentation This link then refers to : Files available at SAM/deploy/libraries at develop · NREL/SAM · GitHub These files are not the same. The inverter Daman is talking about is listed in the original SAM libraries, but not in the EMHASS one. So I just wanted to point out to others, who did use the link from documentation, that it may contain the models you are looking for, but may not work. daman7cz: GoodWe_Technologies_Co___Ltd___GW9600A_ES__240V_ image 693×93 13.2 KB
----------------------------------------

【122楼】 - davidusb
回复时间: 2022-09-09T17:10:59.132Z
----------------------------------------
Hi, I’ve just updated this in the documentation.
----------------------------------------

【123楼】 - per.takman
回复时间: 2022-09-11T23:21:00.466Z
----------------------------------------
Hi David, Thank you for a very cool project! I’ve followed the example from haraldov to get a list from Nordpool as well as the example in The forecast module — emhass 0.3.18 documentation to get SolCast forecast data. I’ve defined these shell_commands: post_nordpool_forecast: ‘curl -i -H ‘‘Content-Type: application/json’’ -X POST -d ‘’{“load_cost_forecast”:{{( (state_attr(’‘sensor.nordpool’’, ‘‘raw_tomorrow’’)|map(attribute=’‘value’’)|list)[:24]) }},“prod_price_forecast”:{{( (state_attr(’‘sensor.nordpool’’, ‘‘raw_tomorrow’’)|map(attribute=’‘value’’)|list)[:24])}}}’’ http://localhost:5000/action/dayahead-optim ’ post_mpc_optim_solcast: ‘curl -i -H ‘‘Content-Type: application/json’’ -X POST -d ‘’{“load_cost_forecast”:{{( (state_attr(’‘sensor.nordpool’’, ‘‘raw_tomorrow’’)|map(attribute=’‘value’’)|list)[:24]) }},“prod_price_forecast”:{{( (state_attr(’‘sensor.nordpool’’, ‘‘raw_tomorrow’’)|map(attribute=’‘value’’)|list)[:24]) }}, “pv_power_forecast”:{{states(’‘sensor.solcast_24hrs_forecast’’) }}}’’ http://localhost:5000/action/naive-mpc-optim ’ When I use the shell_command post_nordpool_forecast it seems to work and I get a list for the entire , but when I use post_mpc_optim_solcast the list stops at 10 am. I have a feeling it has to do with the fact that solcast sends 48 values, but Nordpool only sends 24 values, but I’m not sure. Is there a way to combine Nordpool data with solcast forecast data? Warmly, Per Takman
----------------------------------------

【124楼】 - davidusb
回复时间: 2022-09-12T04:49:36.843Z
----------------------------------------
Hi, what do you mean by combine? Nordpool is giving you load cost and production prices forecasts in currency units while Solcast is giving you PV power forecast in Watts. How to combine different quantities? Or I don’t understand your problem with that. The data is being truncated when using MPC because of the working principle of that algorithm and the prediction horizon parameter. To control that you need to define additional parameters when using MPC, for example : "prediction_horizon":10,soc_init":0.5,"soc_final":0.6,"def_total_hours":[1,3] …if you have a battery and two deferrable loads.
----------------------------------------

【125楼】 - per.takman
回复时间: 2022-09-12T05:50:55.480Z
----------------------------------------
Hi! I was not referring to combining price with watts. I thought something was wrong becuase I did not see a result that covered the entire next day. My assumption was that 24 datapoints from Nordpool vs. 48 datapoints from solcast caused the problem. From your answer I take it that MPC does not offer a prediction for the entire next day. Sounds like I need to study this in more detail.
----------------------------------------

【126楼】 - haraldov
回复时间: 2022-09-12T07:08:28.556Z
----------------------------------------
@per.takman per.takman: I thought something was wrong becuase I did not see a result that covered the entire next day. My assumption was that 24 datapoints from Nordpool vs. 48 datapoints from solcast caused the problem. Nordpool publish tomorrow power prices every day at 13:00. Sometimes the Nordpool plugin do not update the prices. I use a automation which trigger the shell command at 23:57 every day. I then get the prices from 00:00 the next day in emhass. alias: EMHASS day-ahead optimization description: "" trigger: - platform: time at: "23:57:00" condition: [] action: - service: shell_command.post_nordpool_forecast data: {} mode: single You can see if the tomorrow price data is available with Developer Tools-&gt;State: If you are sending emty raw_tomorrow list the column unit_load_cost and the cost_profit in the emhass webpage do not update. If it work check also the price data are in the correct time index. The shell_command I use now is this one: shell_command: publish_data: "curl -i -H 'Content-Type:application/json' -X POST -d '{}' http://localhost:5000/action/publish-data" post_nordpool_forecast: 'curl -i -H ''Content-Type: application/json'' -X POST -d ''{"load_cost_forecast":{{( (state_attr(''sensor.nordpool'', ''raw_tomorrow'')|map(attribute=''value'')|list)[:24]) }},"prod_price_forecast":{{( (state_attr(''sensor.nordpool'', ''raw_tomorrow'')|map(attribute=''value'')|list)[:24])}}}'' http://localhost:5000/action/dayahead-optim'
----------------------------------------

【127楼】 - per.takman
回复时间: 2022-09-12T21:05:21.393Z
----------------------------------------
Hi again, Sorry about not being clear in my first post. I believe that I’ve followed the instruction now, but I still think that the fact that Nordpool publish 24 values and solcast publish 48 values cause a problem. Please bear with me. After stumbling a bit on the syntax in Studio Code Server I now have the following shell commands: dayahead_optim: 'curl -i -H ''Content-Type: application/json'' -X POST -d ''{"load_cost_forecast":{{( (state_attr(''sensor.nordpool_kwh_se3_sek_3_10_025'', ''raw_tomorrow'')|map(attribute=''value'')|list)[:24]) }},"prod_price_forecast":{{( (state_attr(''sensor.nordpool_kwh_se3_sek_3_10_025'', ''raw_tomorrow'')|map(attribute=''value'')|list)[:24])}}}'' http://localhost:5000/action/dayahead-optim' mpc_optim: 'curl -i -H "Content-Type: application/json" -X POST -d ''{"load_cost_forecast":{{( (state_attr(''sensor.nordpool_kwh_se3_sek_3_10_025'', ''raw_tomorrow'')|map(attribute=''value'')|list)[:24]) }}, "prod_price_forecast":{{( (state_attr(''sensor.nordpool_kwh_se3_sek_3_10_025'', ''raw_tomorrow'')|map(attribute=''value'')|list)[:24]) }}, "pv_power_forecast":{{states(''sensor.solcast_24hrs_forecast'') }}, "prediction_horizon":48,"soc_init":{{(states(''sensor.r2_d2_battery_level'')|float(0))/100 }},"soc_final":0.05,"def_total_hours":[2]}'' http://localhost:5000/action/naive-mpc-optim' publish_data: "curl -i -H 'Content-Type:application/json' -X POST -d '{}' http://localhost:5000/action/publish-data" dayahead_optim and publish_data both execute sucessfully, but mpc_optim generate the following log trace in the EMHASS add-on: [2022-09-12 22:57:35,264] INFO in command_line: Setting up needed data [2022-09-12 22:57:35,272] INFO in retrieve_hass: Retrieve hass get data method initiated... [2022-09-12 22:57:36,221] INFO in forecast: Retrieving weather forecast data using method = list [2022-09-12 22:57:36,231] INFO in forecast: Retrieving data from hass for load forecast using method = naive [2022-09-12 22:57:36,233] INFO in retrieve_hass: Retrieve hass get data method initiated... [2022-09-12 22:57:39,148] ERROR in app: Exception on /action/naive-mpc-optim [POST] Traceback (most recent call last): File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 2525, in wsgi_app response = self.full_dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1822, in full_dispatch_request rv = self.handle_user_exception(e) File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1820, in full_dispatch_request rv = self.dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1796, in dispatch_request return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args) File "/usr/local/lib/python3.9/dist-packages/emhass/web_server.py", line 134, in action_call input_data_dict = set_input_data_dict(config_path, str(config_path.parent), costfun, File "/usr/local/lib/python3.9/dist-packages/emhass/command_line.py", line 112, in set_input_data_dict df_input_data_dayahead = copy.deepcopy(df_input_data_dayahead)[df_input_data_dayahead.index[0]:df_input_data_dayahead.index[prediction_horizon-1]] File "/usr/local/lib/python3.9/dist-packages/pandas/core/indexes/base.py", line 5039, in __getitem__ return getitem(key) File "/usr/local/lib/python3.9/dist-packages/pandas/core/arrays/datetimelike.py", line 341, in __getitem__ "Union[DatetimeLikeArrayT, DTScalarOrNaT]", super().__getitem__(key) File "/usr/local/lib/python3.9/dist-packages/pandas/core/arrays/_mixins.py", line 272, in __getitem__ result = self._ndarray[key] IndexError: index 47 is out of bounds for axis 0 with size 24 Is there a way to use MPC together with data from Nordpool? Should I be using a different service for pv_power_forecast with 60 minute intervals? Is it sufficient to only use dayahead_optim once a day and then publish every 5 minutes? Does anybody have good example how to control battery based on sensor.p_batt_forecast? Cheers, Per Takman
----------------------------------------

【128楼】 - markpurcell
回复时间: 2022-09-12T21:11:39.393Z
----------------------------------------
You need to ensure that the data you pass have the same number of elements. Either 24 x60 minute intervals or 48 x30 minute intervals you can’t mix 24 values for price and 48 values for production. I would suggest you just focus on price only and use the internal pvlib solar forecast to start. In your case you have 24 x60 price forecasts so you need to change your time interval to 60 minutes. Using the internal pvlib solar forecast is reasonable, but don’t worry if you don’t have exact models to match. Once you get EMHASS writing with price forecasts, then as a second stage you can look to integrate the external solar forecasts.
----------------------------------------

【129楼】 - per.takman
回复时间: 2022-09-12T21:27:26.348Z
----------------------------------------
Hi Mark, I’ve already set the optimization time step to 60 to make Nordpool with their 24 data points work. Your suggestion to use the internal pvlib solar forecast sounds good. Can I do this by simply removing the line }}, "pv_power_forecast":{{states(''sensor.solcast_24hrs_forecast'') in my shell command mpc_optim? The new shell command would then be: mpc_optim: 'curl -i -H "Content-Type: application/json" -X POST -d ''{"load_cost_forecast":{{( (state_attr(''sensor.nordpool_kwh_se3_sek_3_10_025'', ''raw_tomorrow'')|map(attribute=''value'')|list)[:24]) }}, "prod_price_forecast":{{( (state_attr(''sensor.nordpool_kwh_se3_sek_3_10_025'', ''raw_tomorrow'')|map(attribute=''value'')|list)[:24]) }}, "prediction_horizon":48,"soc_init":{{(states(''sensor.r2_d2_battery_level'')|float(0))/100 }},"soc_final":0.05,"def_total_hours":[2]}'' http://localhost:5000/action/naive-mpc-optim' Thank you in advance! /Perr
----------------------------------------

【130楼】 - markpurcell
回复时间: 2022-09-12T21:40:01.312Z
----------------------------------------
Yes that is looking simpler, which is easier to debug. You should also change prediction_horizon from 48 to 24 to match the 24 elements you are passing.
----------------------------------------

【131楼】 - markpurcell
回复时间: 2022-09-12T21:47:13.037Z
----------------------------------------
per.takman: Does anybody have good example how to control battery based on sensor.p_batt_forecast It really depends on which battery you have and the controls available to you in Home Assistant. I have a Tesla powerwall2 and use the Tesla Gateway custom integration. One automation that sets backup_reserve_percent based off the EMHASS state of charge forecast: alias: Battery SOC Forecast description: "" trigger: - platform: state entity_id: - sensor.soc_batt_forecast condition: [] action: - service: tesla_gateway.set_reserve data: backup_reserve_percent: "{{states('sensor.soc_batt_forecast')|int(0)-5}}" mode: single I also have an alternative method by changing the battery modes, which roughly does the right thing. This also has some alerts so I can monitor the mode changes. alias: p_batt automation description: "" trigger: - platform: numeric_state entity_id: sensor.p_batt_forecast below: "-1000" - platform: numeric_state entity_id: sensor.p_batt_forecast above: "-1000" below: "4900" - platform: numeric_state entity_id: sensor.p_batt_forecast above: "4900" condition: [] action: - choose: - conditions: - condition: numeric_state entity_id: sensor.p_batt_forecast below: "-1000" sequence: - service: notify.mobile_app_pixel_6 data: title: p_batt alert {{states('sensor.p_batt_forecast')}} - mode:backup message: price:{{states('sensor.amber_general_price')}} $/kWh - service: tesla_gateway.set_operation data: real_mode: backup backup_reserve_percent: 3 - conditions: - condition: numeric_state entity_id: sensor.p_batt_forecast above: "4900" enabled: false sequence: - service: tesla_gateway.set_operation data: real_mode: autonomous backup_reserve_percent: 1 enabled: false - service: notify.mobile_app_pixel_6 data: title: &gt;- p_batt alert {{states('sensor.p_batt_forecast')}} - consider mode:autonomous message: Price:{{states('sensor.amber_general_price')}} $/kWh default: - service: tesla_gateway.set_operation data: real_mode: self_consumption backup_reserve_percent: 2 - service: notify.mobile_app_pixel_6 data: title: &gt;- p_batt alert {{states('sensor.p_batt_forecast')}} - mode:self_consumption message: Price:{{states('sensor.amber_general_price')}} $/kWh mode: single
----------------------------------------

【132楼】 - per.takman
回复时间: 2022-09-12T21:52:33.484Z
----------------------------------------
Thank you Mark! I no longer get errors after reducing the prediction horizon to 24 instead of 48 regardless of whether I use mpc_optim or mpc_optim3 where I use solcast_24hrs_forecast. However, I get the impression that I either should not run it directly after a dayahead_optim or that something else is wrong. mpc_optim: 'curl -i -H "Content-Type: application/json" -X POST -d ''{"load_cost_forecast":{{( (state_attr(''sensor.nordpool_kwh_se3_sek_3_10_025'', ''raw_tomorrow'')|map(attribute=''value'')|list)[:24]) }}, "prod_price_forecast":{{( (state_attr(''sensor.nordpool_kwh_se3_sek_3_10_025'', ''raw_tomorrow'')|map(attribute=''value'')|list)[:24]) }}, "prediction_horizon":24,"soc_init":{{(states(''sensor.r2_d2_battery_level'')|float(0))/100 }},"soc_final":0.05,"def_total_hours":[2]}'' http://localhost:5000/action/naive-mpc-optim' mpc_optim3: 'curl -i -H "Content-Type: application/json" -X POST -d ''{"load_cost_forecast":{{( (state_attr(''sensor.nordpool_kwh_se3_sek_3_10_025'', ''raw_tomorrow'')|map(attribute=''value'')|list)[:24]) }}, "prod_price_forecast":{{( (state_attr(''sensor.nordpool_kwh_se3_sek_3_10_025'', ''raw_tomorrow'')|map(attribute=''value'')|list)[:24]) }}, "pv_power_forecast":{{states(''sensor.solcast_24hrs_forecast'') }}, "prediction_horizon":24,"soc_init":{{(states(''sensor.r2_d2_battery_level'')|float(0))/100 }},"soc_final":0.05,"def_total_hours":[2]}'' http://localhost:5000/action/naive-mpc-optim' The EMHASS log looks like below: [2022-09-12 23:46:04,315] INFO in command_line: Setting up needed data [2022-09-12 23:46:04,326] INFO in retrieve_hass: Retrieve hass get data method initiated... [2022-09-12 23:46:05,427] INFO in forecast: Retrieving weather forecast data using method = list [2022-09-12 23:46:05,436] INFO in forecast: Retrieving data from hass for load forecast using method = naive [2022-09-12 23:46:05,438] INFO in retrieve_hass: Retrieve hass get data method initiated... [2022-09-12 23:46:08,698] INFO in web_server: &gt;&gt; Performing naive MPC optimization... [2022-09-12 23:46:08,698] INFO in command_line: Performing naive MPC optimization [2022-09-12 23:46:08,726] INFO in optimization: Perform an iteration of a naive MPC controller [2022-09-12 23:46:08,896] INFO in optimization: Status: Infeasible [2022-09-12 23:46:08,897] INFO in optimization: Total value of the Cost function = 0.0 What does Status: Infeasible mean? The total value of the cost function is zero.
----------------------------------------

【133楼】 - markpurcell
回复时间: 2022-09-12T22:10:48.722Z
----------------------------------------
My understanding is the nordpool pricing is only updated once a day. There are some considerations you need to take into effect. You will get a reasonable optimisation from EMHASS if you only call the optimisation once a day as well. For debugging purposes you can call many times whilst trying to setup. Can you drop your shell command into the developer template section so we can see the expansion of variables. Whilst you are setting up, drop def_hours to 0 until you get the basic functionality working. EMHASS expects the list of prices to be relative to the current time. Thus the first price in the list should correspond to the first timeslot (ie next 60 minutes), the second element in the list should correspond to the next timeslot and so on. So if you call the optimisation at 09:45, it is expecting to see the prices for 10:00, 11:00, and so on. My understanding is the nordpool sensor is only updated every 24 hrs. I’m not sure what time reference they use, but for example if the nordpool data always starts at midnight, the first element in the list will always refer to 01:00, the second element 02:00 and so on. It is upto you to ensure the data fed to EMHASS referes to the correct time slot, alternatively you can call the optimisation once a day at the correct time. Can you also share what you see at http://homeassistant.local:5000 which should show the results after an optimisation.
----------------------------------------

【134楼】 - per.takman
回复时间: 2022-09-12T22:22:19.163Z
----------------------------------------
Nordpool offers todays prices starting from 00 to 01 and so on. In addition, they publish next day prices at 13 every day. This means that the first element in the list I’m sending is for 00 to 01. To me it sounds like I should stick with the dayahead_optim and skip MPC for now.
----------------------------------------

【135楼】 - markpurcell
回复时间: 2022-09-12T23:11:17.854Z
----------------------------------------
That sounds sensible. MPC only improves the optimisation when your variables are changing very quickly. My energy provider updates and changes their prices every 5 minutes, based off the national energy market wholesale bidding prices so for me the added complexity of getting MPC functional had a lot of benefits.
----------------------------------------

【136楼】 - per.takman
回复时间: 2022-09-13T06:27:47.980Z
----------------------------------------
I’m still in the plan and prepare phase for our solar panel and battery storage investment, which is why I’m playing around with this add-on. One thing I’ve been wondering is how people with battery storage solutions factor in the cost of using the battery for a charge/discharge cycle. Some days are more profitable than others and some days the savings may not justify using the battery due to battery aging.The storage system has an investment cost and a finite lifetime. Do you somehow factor in the cost of using a kWh in EMHASS or do you simply hope that the difference in price between charge/discharge exceed the cost of the investment per kWh every day? Warmly, Per
----------------------------------------

【137楼】 - markpurcell
回复时间: 2022-09-13T07:05:17.786Z
----------------------------------------
EMHASS doesn’t currently take into account battery degradation in its costing model. I suppose you could use a lower efficiency value to represent a reduced value. EMHASS is really good for doing what if analysis for the impact if you double battery size or solar array size. EMHASS does take account of the cost to charge and discharge, including efficiency and depending on the cost model you select will only charge/ discharge your battery if it meets the objectives of maximise profit or self consumption. Have a look at the Web UI, to see the details for each time period. Screenshot_20220913-165319 864×1920 141 KB . I do have some templates that calculate the daily savings from battery and solar. But that is interested to EMHASS. Screenshot_20220913-170453 864×1920 124 KB that
----------------------------------------

【138楼】 - PatrickJanson
回复时间: 2022-09-14T16:58:38.244Z
----------------------------------------
I just cant get into the web-ui. What am I doing wrong Yeah I know, how could you guys know… But, I was hoping it was a known issue with noobs like me. The log says everything starts OK, but the web-ui just wont show up. I have uninstalled the addon, and installed it again, still not working. Any ideas, or any special information you need from me to help me out?
----------------------------------------

【139楼】 - davidusb
回复时间: 2022-09-15T04:53:40.959Z
----------------------------------------
Hi, just install the latest version of the add-on and with the add-on running go to: https://&lt;your_ha_device_ip_address&gt;:5000
----------------------------------------

【140楼】 - PatrickJanson
回复时间: 2022-09-15T06:09:08.447Z
----------------------------------------
Yeah. i found another address that worked (the button navigates to a url that wont work for me.). Thank you !
----------------------------------------

【141楼】 - RubberDucky
回复时间: 2022-09-20T16:18:58.664Z
----------------------------------------
Hi, great work on this add-on. I’m configuring it for my setup and I’ve got a question about the configuration. How do I setup multiple PV inverters and multiple batteries? I see I can add the config for one PV plant but I have two and they have different orientation, panels and inverters. For the batteries the same. I have home batteries and an EV.
----------------------------------------

【142楼】 - davidusb
回复时间: 2022-09-20T18:12:38.499Z
----------------------------------------
Hi, for the solar panels and inverter you can provide a list of elements like this: - pv_inverter_model: my_first_inverter_model - pv_inverter_model: my_second_inverter_model For the batteries you can only consider one battery. However this can still be used considering the provoded optimized battery power as a lumped power. Then outside EMHASS you can use templates to separate that power for your individual batteries
----------------------------------------

【143楼】 - PatrickJanson
回复时间: 2022-09-22T06:28:31.901Z
----------------------------------------
Whats wrong this time? image 1364×875 81.7 KB I created a new sensor that shows power without the waterheater, so I suspect i did something wrong there… The sensor is working in the UI :
----------------------------------------

【144楼】 - davidusb
回复时间: 2022-09-22T06:52:45.821Z
----------------------------------------
You are passing values that seem to be sampled at 30 min time steps while you have configured the add-on to 60 min time steps
----------------------------------------

【145楼】 - PatrickJanson
回复时间: 2022-09-22T07:28:57.498Z
----------------------------------------
post_nordpool_forecast: "curl -i -H 'Content-Type: application/json' -X POST -d '{\"load_cost_forecast\":{{( (state_attr('sensor.nordpool_kwh_oslo_nok_3_10_025', 'raw_tomorrow')|map(attribute='value')|list)[:24]) }},\"prod_price_forecast\":{{( (state_attr('sensor.nordpool_kwh_oslo_nok_3_10_025', 'raw_tomorrow')|map(attribute='value')|list)[:24])}}}' http://localhost:5000/action/dayahead-optim" This is what I use for price. and nordpool uses 60min. Does that mean that my template sensor is messing this up?
----------------------------------------

【146楼】 - markpurcell
回复时间: 2022-09-22T07:41:46.920Z
----------------------------------------
Can you copy your command into the Developer Tools template section so it can expand all your sensors, it is very difficult to debug without knowing what it expands to.
----------------------------------------

【147楼】 - mirecekd
回复时间: 2022-09-22T07:52:01.357Z
----------------------------------------
Hi David, is it possible to add emhass option to NOT charge from grid? For example I don’t have low cost tariff. I have Goodwe ET series where logic on their General mode is to support load from PV and from batt, than charge batt (when enough PV for load) than grid. Or is there another approach how to force emhass not to charge from grid? Thanks Mirek
----------------------------------------

【148楼】 - smi
回复时间: 2022-09-22T08:19:53.158Z
----------------------------------------
Hi @davidusb We’ve been in contact regarding this project pretty much at the beginning of it. Now after a lot of time, I’d like to start using it. I am using your add-on but if necessary would also switch to a separate installation. The following questions arose: Does sensor_power_load_no_var_loads needs to be negative or positive? Fronius provides this as a negative number when consuming and the max would be 0 (when no consumption is happening). Do sensor_power_load_no_var_loads and sensor.power_photovoltaics need to be an increasing number (like a meter adding more and more to its value) or should it be a live consumed value like 300 W? How would I implement a variable pricing for energy put into the grid? Under The forecast module — emhass 0.3.19 documentation I can see that this is possible but how would I do so / is it possible using the add-on? I am having the data stored in a sensor per hour. EDIT: Sorry didn’t see that this also has to be done via curl when using the add-on. Will try to do so. Thanks!
----------------------------------------

【149楼】 - davidusb
回复时间: 2022-09-22T08:37:22.451Z
----------------------------------------
Hi, there is not a direct option or parameter to forbid charging from the grid. However we can force that using artificially high load cost values. If these load costs are high enough then the optimization will normally converge to a solution where charging from the grid is forbidden. You can play with that and see if that fits your needs, however the artificial load cost may lead to the loss of real cost energy values, if this was important to you for estimating for example your real $ saving, then this could be a problem. It can be a little challenge to add more equations to the linear programming formulation to properly solve problems like this, because we will found ourselves with too many equations to solve with our open-source LP solvers
----------------------------------------

【150楼】 - davidusb
回复时间: 2022-09-22T08:45:13.276Z
----------------------------------------
Hi, Answering your questions: The load should be positive No, no increasing or cumulated values like energies in kWh. These should be instantaneous values in Watts. You can pass this data easily using the template in your automation with the shell_command . You have an example here: The forecast module — emhass 0.3.19 documentation You just need to use the correct key for your data, in your case it will be prod_price_forecast
----------------------------------------

【151楼】 - RubberDucky
回复时间: 2022-09-22T13:48:44.251Z
----------------------------------------
Thanks. Am I correct to assume that I can then prefix all these variables with pv_ and then repeat them for each solar installation? - module_model: 'CSUN_Eurasia_Energy_Systems_Industry_and_Trade_CSUN295_60M' # The PV module model - inverter_model: 'Fronius_International_GmbH__Fronius_Primo_5_0_1_208_240__240V_' # The PV inverter model - surface_tilt: 30 # The tilt angle of your solar panels - surface_azimuth: 205 # The azimuth angle of your PV installation - modules_per_string: 16 # The number of modules per string - strings_per_inverter: 1 # The number of used strings per inverter And repeat them twice for my east-west facing solar panels, once for the east facing and once for the west facing panels?
----------------------------------------

【152楼】 - davidusb
回复时间: 2022-09-22T14:15:10.926Z
----------------------------------------
You should repeat items in the lists for each of your inverter configurations. For example if you have two inverters, one for east facing modules (with 8 modules) and another for west facing modules (with 12 modules) then it will be something like this: list_pv_module_model: - pv_module_model: my_inverter_model_for_east_facing_modules - pv_module_model: my_inverter_model_for_west_facing_modules list_pv_inverter_model: - pv_inverter_model: my_module_model_for_east_facing_modules - pv_inverter_model: my_module_model_for_west_facing_modules list_surface_tilt: - surface_tilt: 30 - surface_tilt: 45 list_surface_azimuth: - surface_azimuth: 90 - surface_azimuth: 270 list_modules_per_string: - modules_per_string: 8 - modules_per_string: 12 list_strings_per_inverter: - strings_per_inverter: 1 - strings_per_inverter: 1
----------------------------------------

【153楼】 - PatrickJanson
回复时间: 2022-09-24T18:28:24.173Z
----------------------------------------
Again, I have done something to mess this up… But I cant figure out what. When I press “optimize” I get this : image 1143×564 34.3 KB
----------------------------------------

【154楼】 - PatrickJanson
回复时间: 2022-09-24T18:56:53.615Z
----------------------------------------
I figured it out… stupid me had only one of these lines… It works again now that I saw the mistake.
----------------------------------------

【155楼】 - smi
回复时间: 2022-09-24T19:17:56.620Z
----------------------------------------
Thanks, I created a Node-Red flow to get the price data for the next day and to generate the shell_command. If I want to pass prod_price_forecast and pv_power_forecast to EMHASS, which endpoint should I use in the curl? The sample for prod_price_forecast says dayahead-optim and prod_price_forecast says naive-mpc-optim. Or do i need to run separate commands? If so, in which order? As my modules and my inverter are not in the csv, I need to get the forecast data from solcast. In the add-on: Do I need to remove everything from list_pv_module_model and similar or will the command overwrite it? In the prod_price_forecast there is plenty of “awattar”. As it is an energy provider: was this just used for naming / can I simply ignore that even though this data has nothing to do with awattar? Thanks!
----------------------------------------

【156楼】 - davidusb
回复时间: 2022-09-24T19:46:18.395Z
----------------------------------------
smi: If I want to pass prod_price_forecast and pv_power_forecast to EMHASS, which endpoint should I use in the curl? The sample for prod_price_forecast says dayahead-optim and prod_price_forecast says naive-mpc-optim. The endpoints are not specific to what type of data you are passing, they are specific to an optimization task. So you should use the endpoint for the optimization task that you want to achieve. A “dayahead-optim” is designed to launch an optimization just once a day, while “naive-mpc-optim” is designed to launch an optimization at a higher frequency, say every 10 minutes for example. Or do i need to run separate commands? If so, in which order? Each endpoint, for example “dayahead-optim”, will accept the four forecast needed by emhass at once. Read the documentation for this, it is well explained there. As my modules and my inverter are not in the csv, I need to get the forecast data from solcast. In the add-on: Do I need to remove everything from list_pv_module_model and similar or will the command overwrite it? If you use the solcast method, which is now supported directly inside emhass, then don’t worry about the list_pv_module_model and list_pv_inverter_model parameters in the configuration, they will not be used. The example on how to use Solcast natively is here: https://emhass.readthedocs.io/en/latest/forecasts.html#pv-power-production-forecast smi: In the prod_price_forecast there is plenty of “awattar”. As it is an energy provider: was this just used for naming / can I simply ignore that even though this data has nothing to do with awattar? Wow, I didn’t understood much of what you said here. I don’t know what an “awattar” is…
----------------------------------------

【157楼】 - smi
回复时间: 2022-09-24T21:15:46.517Z
----------------------------------------
Thanks. Regarding the awattar thing: The sample under The forecast module — emhass 0.7.8 documentation just includes “awattar” saveral times and my question was why it is included in the example if this example is about the pv production volume. Awattar is an energy provider. When running curl -i -H “Content-Type: application/json” -X POST -d ‘{“prod_price_forecast”:[“0.26”,“0.23”,“0.21”,“0.21”,“0.19”,“0.19”,“0.22”,“0.24”,“0.27”,“0.29”,“0.27”,“0.27”,“0.27”,“0.23”,“0.21”,“0.22”,“0.27”,“0.33”,“0.38”,“0.41”,“0.39”,“0.37”,“0.34”,“0.29”]}’ http://localhost:5000/action/dayahead-optim I’m receiving a 500 error. Tried it with localhost as well as with the actual IP. Any idea why this might happen? I’m using let’s encrypt to protect HA. HA is accessible via https using the internal IP with an SSL error and from external via a domain without SSL error. EMHASS frontend is accessible via http internally. How many digits are allowed for prod_price_forecast? EDIT: Just saw the " are not existent in your sample. will try without them. Thanks
----------------------------------------

【158楼】 - markpurcell
回复时间: 2022-09-24T21:21:37.082Z
----------------------------------------
smi: just includes “awattar” saveral times and my question was why it is included in the example if this example is about the pv production volume. Awattar is an energy provide The awatter reference is just a variable name that I grabbed from another template, you can change the template variable to be anything you like.
----------------------------------------

【159楼】 - markpurcell
回复时间: 2022-09-24T21:25:20.179Z
----------------------------------------
smi: How many digits are allowed for prod_price_forecast? There shouldn’t be a limitation on the number of digits, but I notice you are passing 24 values. Have you setup 60 minutes timeslots? You may also need to pass “prediction_horizon”: 24
----------------------------------------

【160楼】 - smi
回复时间: 2022-09-24T21:56:15.018Z
----------------------------------------
Yes I set it to 60 minutes. I now also removed the " from the prices but am still getting a 505 error. I’ll now try to add spaces between each value.
----------------------------------------

【161楼】 - markpurcell
回复时间: 2022-09-24T22:02:46.767Z
----------------------------------------
This is what my call looks like: post_amber_forecast: "curl -i -H 'Content-Type: application/json' -X POST -d '{\"prod_price_forecast\":[0.01, -0.04, -0.05, -0.05, -0.06, -0.1, -0.16, -0.16, -0.14, -0.08, -0.06, -0.05, -0.05, -0.01, 0.01, 0.03, 0.07, 0.17, 0.3, 0.3, 0.3, 0.3, 0.25, 0.28, 0.23, 0.22, 0.21, 0.22, 0.21, 0.22, 0.22, 0.22, 0.22, 0.23, 0.21, 0.18, 0.16, 0.16, 0.16],\"load_cost_forecast\":[0.09, 0.04, 0.03, 0.02, 0.01, -0.03, -0.09, -0.09, -0.07, -0.0, 0.02, 0.02, 0.02, 0.07, 0.09, 0.12, 0.16, 0.27, 0.41, 0.41, 0.41, 0.41, 0.36, 0.39, 0.34, 0.33, 0.31, 0.33, 0.32, 0.33, 0.32, 0.33, 0.32, 0.34, 0.32, 0.28, 0.26, 0.26, 0.26]}' http://localhost:5000/action/dayahead-optim"
----------------------------------------

【162楼】 - smi
回复时间: 2022-09-26T06:21:03.090Z
----------------------------------------
Thanks, I tried your curl as well as several variations. Always either getting a 500 or 400 error. 400: request (your sample): curl -i -H 'Content-Type: application/json' -X POST -d '{\"prod_price_forecast\":[0.01, -0.04, -0.05, -0.05, -0.06, -0.1, -0.16, -0.16, -0.14, -0.08, -0.06, -0.05, -0.05, -0.01, 0.01, 0.03, 0.07, 0.17, 0.3, 0.3, 0.3, 0.3, 0.25, 0.28, 0.23, 0.22, 0.21, 0.22, 0.21, 0.22, 0.22, 0.22, 0.22, 0.23, 0.21, 0.18, 0.16, 0.16, 0.16],\"load_cost_forecast\":[0.09, 0.04, 0.03, 0.02, 0.01, -0.03, -0.09, -0.09, -0.07, -0.0, 0.02, 0.02, 0.02, 0.07, 0.09, 0.12, 0.16, 0.27, 0.41, 0.41, 0.41, 0.41, 0.36, 0.39, 0.34, 0.33, 0.31, 0.33, 0.32, 0.33, 0.32, 0.33, 0.32, 0.34, 0.32, 0.28, 0.26, 0.26, 0.26]}' http://192.168.0.102:5000/action/dayahead-optim reply: 26 Sep 08:16:30 - [info] [debug:debug 2] { _msgid: 'b5234528097a1aa3', topic: '', payload: 'HTTP/1.1 400 BAD REQUEST\r\n' + 'Content-Length: 167\r\n' + 'Content-Type: text/html; charset=utf-8\r\n' + 'Date: Mon, 26 Sep 2022 06:16:30 GMT\r\n' + 'Server: waitress\r\n' + '\r\n' + '&lt;!doctype html&gt;\n' + '&lt;html lang=en&gt;\n' + '&lt;title&gt;400 Bad Request&lt;/title&gt;\n' + '&lt;h1&gt;Bad Request&lt;/h1&gt;\n' + '&lt;p&gt;The browser (or proxy) sent a request that this server could not understand.&lt;/p&gt;\n', rc: { code: 0 } } 26 Sep 08:16:30 - [info] [debug:debug 2] { _msgid: 'b5234528097a1aa3', topic: '', payload: ' % Total % Received % Xferd Average Speed Time Time Time Current\n' + ' Dload Upload Total Spent Left Speed\n' + '\r 0 0 0 0 0 0 0 0 --:--:-- --:--:-- --:--:-- 0\r100 697 100 167 100 530 25955 82374 --:--:-- --:--:-- --:--:-- 136k\n', rc: { code: 0 } } 26 Sep 08:16:30 - [info] [debug:debug 2] { _msgid: 'b5234528097a1aa3', topic: '', payload: { code: 0 } } 500: request: curl -i -H 'Content-Type: application/json' -X POST -d '{"prod_price_forecast":[0.01, -0.04, -0.05, -0.05, -0.06, -0.1, -0.16, -0.16, -0.14, -0.08, -0.06, -0.05, -0.05, -0.01, 0.01, 0.03, 0.07, 0.17, 0.3, 0.3, 0.3, 0.3, 0.25, 0.28, 0.23, 0.22, 0.21, 0.22, 0.21, 0.22, 0.22, 0.22, 0.22, 0.23, 0.21, 0.18, 0.16, 0.16, 0.16]}' http://localhost:5000/action/dayahead-optim reply: 26 Sep 08:18:05 - [info] [debug:debug 2] { _msgid: '8c1603e0cdeb32c9', topic: '', payload: 'HTTP/1.1 500 INTERNAL SERVER ERROR\r\n' + 'Content-Length: 265\r\n' + 'Content-Type: text/html; charset=utf-8\r\n' + 'Date: Mon, 26 Sep 2022 06:18:03 GMT\r\n' + 'Server: waitress\r\n' + '\r\n' + '&lt;!doctype html&gt;\n' + '&lt;html lang=en&gt;\n' + '&lt;title&gt;500 Internal Server Error&lt;/title&gt;\n' + '&lt;h1&gt;Internal Server Error&lt;/h1&gt;\n' + '&lt;p&gt;The server encountered an internal error and was unable to complete your request. Either the server is overloaded or there is an error in the application.&lt;/p&gt;\n', rc: { code: 0 } } 26 Sep 08:18:05 - [info] [debug:debug 2] { _msgid: '8c1603e0cdeb32c9', topic: '', payload: ' % Total % Received % Xferd Average Speed Time Time Time Current\n' + ' Dload Upload Total Spent Left Speed\n' + '\r 0 0 0 0 0 0 0 0 --:--:-- --:--:-- --:--:-- 0\r100 266 0 0 100 266 0 221 0:00:01 0:00:01 --:--:-- 221\r100 266 0 0 100 266 0 120 0:00:02 0:00:02 --:--:-- 120\r 50 531 0 0 100 266 0 107 0:00:02 0:00:02 --:--:-- 107\r100 531 100 265 100 266 106 107 0:00:02 0:00:02 --:--:-- 213\n', rc: { code: 0 } } 26 Sep 08:18:05 - [info] [debug:debug 2] { _msgid: '8c1603e0cdeb32c9', topic: '', payload: { code: 0 } } I trigger these via Node-Red and tried localhost as well as the local IP of the raspberry running Home Assistant (and EMHASS add-on). Any idea @markpucell or @davidusb ? Thanks
----------------------------------------

【163楼】 - davidusb
回复时间: 2022-09-26T06:45:49.624Z
----------------------------------------
Please post the EMHASS logs
----------------------------------------

【164楼】 - markpurcell
回复时间: 2022-09-26T06:49:01.263Z
----------------------------------------
smi: curl -i -H ‘Content-Type: application/json’ -X POST -d ‘{“prod_price_forecast”:[0.01, -0.04, -0.05, -0.05, -0.06, -0.1, -0.16, -0.16, -0.14, -0.08, -0.06, -0.05, -0.05, -0.01, 0.01, 0.03, 0.07, 0.17, 0.3, 0.3, 0.3, 0.3, 0.25, 0.28, 0.23, 0.22, 0.21, 0.22, 0.21, 0.22, 0.22, 0.22, 0.22, 0.23, 0.21, 0.18, 0.16, 0.16, 0.16]}’ http://localhost:5000/action/dayahead-optim When I type this in my command line I get the following error, which is expected as I have 30 minute time slots in my logs: [2022-09-26 16:23:43,653] INFO in command_line: Setting up needed data [2022-09-26 16:23:43,655] ERROR in utils: ERROR: The passed data is either not a list or the length is not correct, length should be 48 [2022-09-26 16:23:43,655] ERROR in utils: Passed type is &lt;class 'list'&gt; and length is 48 What do you see in the logs, under the add-on, EMHASS section? You seem to have 39 elements in your list. If you are posting on the command line, I find I need to enclose with " rather than ’ "Content-Type: application/json" mark@odroid:~$ curl -i -H "Content-Type: application/json" -X POST -d '{"prod_price_forecast":[0.13, 0.15, 0.19, 0.24, 0.29, 0.22, 0.18, 0.18, 0.17, 0.17, 0.16, 0.17, 0.17, 0.17, 0.16, 0.17, 0.16, 0.16, 0.13, 0.15, 0.13, 0.13, 0.13, 0.12, 0.13, 0.14, 0.13, 0.13, 0.13, 0.11, 0.1, 0.1, 0.1, 0.08, 0.07, 0.07, 0.04, 0.05, 0.04, 0.04, 0.06, 0.04, 0.07, 0.07, 0.09, 0.08, 0.09, 0.1]}' http://localhost:5000/action/dayahead-optim HTTP/1.1 201 CREATED Content-Length: 45 Content-Type: text/html; charset=utf-8 Date: Mon, 26 Sep 2022 06:53:13 GMT Server: waitress EMHASS &gt;&gt; Action dayahead-optim executed... mark@odroid:~$
----------------------------------------

【165楼】 - smi
回复时间: 2022-09-26T06:58:00.494Z
----------------------------------------
Node-Red request (now holding 24 values), done via exec node: 26 Sep 08:52:47 - [info] [debug:debug 1] { payload: `curl -i -H "Content-Type: application/json" -X POST -d '{"prod_price_forecast":[0.24397000000000002,0.17504999999999998,0.15308,0.13158999999999998,0.13334,0.20021,0.36932,0.40281,0.40253999999999995,0.37013999999999997,0.37012999999999996,0.37415999999999994,0.37412,0.33176999999999995,0.28028999999999993,0.28026999999999996,0.36515,0.37512,0.40264,0.43901999999999997,0.39177999999999996,0.32489999999999997,0.31744999999999995,0.25911]}' http://192.168.0.102:5000/action/dayahead-optim`, _msgid: '3cb4f3e86362c00d' } EMHASS log: [2022-09-26 08:56:02,943] INFO in command_line: Setting up needed data [2022-09-26 08:56:02,952] INFO in forecast: Retrieving weather forecast data using method = scrapper [2022-09-26 08:56:05,491] INFO in forecast: Retrieving data from hass for load forecast using method = naive [2022-09-26 08:56:05,493] INFO in retrieve_hass: Retrieve hass get data method initiated... [2022-09-26 08:56:05,551] ERROR in retrieve_hass: The retrieved JSON is empty, check that correct day or variable names are passed [2022-09-26 08:56:05,551] ERROR in retrieve_hass: Either the names of the passed variables are not correct or days_to_retrieve is larger than the recorded history of your sensor (check your recorder settings) [2022-09-26 08:56:05,553] ERROR in app: Exception on /action/dayahead-optim [POST] Traceback (most recent call last): File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 2525, in wsgi_app response = self.full_dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1822, in full_dispatch_request rv = self.handle_user_exception(e) File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1820, in full_dispatch_request rv = self.dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1796, in dispatch_request return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args) File "/usr/local/lib/python3.9/dist-packages/emhass/web_server.py", line 134, in action_call input_data_dict = set_input_data_dict(config_path, str(config_path.parent), costfun, File "/usr/local/lib/python3.9/dist-packages/emhass/command_line.py", line 78, in set_input_data_dict P_load_forecast = fcst.get_load_forecast(method=optim_conf['load_forecast_method']) File "/usr/local/lib/python3.9/dist-packages/emhass/forecast.py", line 495, in get_load_forecast rh.get_data(days_list, var_list) File "/usr/local/lib/python3.9/dist-packages/emhass/retrieve_hass.py", line 130, in get_data self.df_final = pd.concat([self.df_final, df_day], axis=0) UnboundLocalError: local variable 'df_day' referenced before assignment I see “The retrieved JSON is empty, check that correct day or variable names are passed”. Does it require the space between each value in the json array?
----------------------------------------

【166楼】 - smi
回复时间: 2022-09-26T07:01:44.378Z
----------------------------------------
I also tried it with ". Pls find the log in my other reply. Thanks
----------------------------------------

【167楼】 - markpurcell
回复时间: 2022-09-26T07:04:27.123Z
----------------------------------------
No it doesn’t require spaces in the JSON array, perhaps try pasting into a command shell directly, and once that is working they try node-red later. Your data works here for me with the naive-mpc-optim. mark@odroid:~$ curl -i -H "Content-Type: application/json" -X POST -d '{"prod_price_forecast":[0.24397000000000002,0.17504999999999998,0.15308,0.13158999999999998,0.13334,0.20021,0.36932,0.40281,0.40253999999999995,0.37013999999999997,0.37012999999999996,0.37415999999999994,0.37412,0.33176999999999995,0.28028999999999993,0.28026999999999996,0.36515,0.37512,0.40264,0.43901999999999997,0.39177999999999996,0.32489999999999997,0.31744999999999995,0.25911], "prediction_horizon":24}' http://localhost:5000/action/naive-mpc-optim HTTP/1.1 201 CREATED Content-Length: 46 Content-Type: text/html; charset=utf-8 Date: Mon, 26 Sep 2022 07:00:36 GMT Server: waitress EMHASS &gt;&gt; Action naive-mpc-optim executed... mark@odroid:~$
----------------------------------------

【168楼】 - markpurcell
回复时间: 2022-09-26T07:07:49.015Z
----------------------------------------
smi: days_to_retrieve is larger than the recorded history of your sensor When did you setup your noloads sensor? by default it tries to go back 2 days, you can change this default days_to_retrieve in the configuration.
----------------------------------------

【169楼】 - smi
回复时间: 2022-09-26T07:28:45.181Z
----------------------------------------
I set it up a few days ago but now reinstalled everything to see if this fixes it - which it doesn’t. Minimum for days_to_retrieve is 2 days. I tried the command via the terminal add-on but this gives me "curl. (7) Failed to connect to localhost port 5000 after 0 ms: Connection refused. EMHASS seems to be running but I can’t access the interface at the moment because I’m in the office and only port-forward some ports (not 5000). [2022-09-26 09:24:22,352] INFO in web_server: Launching the emhass webserver at: http://0.0.0.0:5000 [2022-09-26 09:24:22,353] INFO in web_server: Home Assistant data fetch will be performed using url: http://supervisor/core/api [2022-09-26 09:24:22,353] INFO in web_server: The base path is: /usr/src [2022-09-26 09:24:22,358] INFO in web_server: Using core emhass version: 0.3.19
----------------------------------------

【170楼】 - markpurcell
回复时间: 2022-09-26T07:32:14.571Z
----------------------------------------
Yes, I had that challenge trying to login to a command line on my home assistant box from work. I found the Terminal &amp; SSH server add-on, will allow you to login to a local command line, but I haven’t had much joy cutting and pasting in that terminal session. Sounds like you may need to wait the two days for the sensor to fill up with meaningful data.
----------------------------------------

【171楼】 - smi
回复时间: 2022-09-26T07:36:32.313Z
----------------------------------------
I’m a bit more concerned about “ERROR in retrieve_hass: The retrieved JSON is empty, check that correct day or variable names are passed”. Sounds to me that this is the underlying reason why I get 500 errors when trying to import prices for the next day.
----------------------------------------

【172楼】 - davidusb
回复时间: 2022-09-26T09:19:12.135Z
----------------------------------------
smi: days_to_retrieve Yes the minimum days_to_retrieve is 2 and this is just how the HA API was designed, we can olny retrieve entire history days in the recorder. Don’t worry too much about the empty json error, this just most probably means in your case that you don’t have enough data in your sensor.
----------------------------------------

【173楼】 - smi
回复时间: 2022-09-26T13:34:06.443Z
----------------------------------------
@davidusb @markpurcell SOLUTION: After I created a port forwarding (5000 to 5000) and used the external HA-address (without https) to send the command from Node-Red to EMHASS, the dayahead optimization worked. If relevant: I’m using the duckdns add-on with the built-in option to generate SSL certificates. The Home Assistant Instance URL is still set to empty as settings the https URL did not work.
----------------------------------------

【174楼】 - smi
回复时间: 2022-09-26T19:14:55.452Z
----------------------------------------
@davidusb Is it possible to set a minimum runtime and a timeframe for a deferrable load? I’d like to plan my domestic hot water heat pump with EMHASS but turning it on/off frequently isn’t healthy for it. It’d be better to set it for a minimum runtime of three hours for example. At the moment it might split 3 hours to 1 2hrs and 1 1hr. Thanks
----------------------------------------

【175楼】 - markpurcell
回复时间: 2022-09-26T20:18:04.737Z
----------------------------------------
smi: Is it possible to set a minimum runtime and a timeframe for a deferrable load? I’d like to plan my domestic hot water heat pump with EMHASS but turning it on/off frequently isn’t healthy for it. I have just replaced my instant gas hot water with a heat pump hot water system so am in the process of setting this up for control by EMHASS. Screenshot_20220927-061344 864×1920 131 KB My heatpump is the Stiebel Electron WWK 302 which has an impressed current anode to protect the tank from corrosion. By default it has one mains lead which can be plugged into a 230V/ 10A socket. The until contains a factory installed battery to protect the anode during power cuts but it is recommended if you are going to switch the unit regularly that you either connect the anode circuit separately to a non switched circuit or replace the battery every three years. So I got my installer to connect a second 230V lead for the anode and control electronics to run continuously (drawing about 4 W) whilst the first circuit switches the compressor (drawing between 400W - 600W) when operating. The unit also has a SmartGrid signal line that can temporarily raise the set point from 61° C to 65° C. I have installed a Shelly 1 to switch this signal line, but haven’t yet integrated that into EMHASS. I recommend you check your manual to see if you are able to protect your anode in this fashion. Using EMHASS I have setup a 500 W deferrable load with a runtime of 3 hours to control the compressor circuit. There is an EMHASS option you can set for continuous block operation, which I have considered but haven’t used for the compressor circuit: set_def_constant: Define if we should set each deferrable load as a constant fixed value variable with just one startup for each optimization task. I have only had it running this week but the results have been pretty reliable with most scheduling occurring during the midday solar soak window/ or my cheap buy signal from my energy provider.
----------------------------------------

【176楼】 - davidusb
回复时间: 2022-09-27T05:16:59.732Z
----------------------------------------
I’ve been using emhass to control my water heater reliably for more than two years now. As long as I have a 30min time step the water heater will not switch on/off at high frequencies. When operating manually with only the thermostat it actually switch more often. However in my use case I don’t have a lot of variance in my costs inputs. As Mark noted there is an option to force fixed values in the optimization. This will add more constraints to the linear programming optimization, so if you are close to the solver problem size limit this could not be a good idea. Otherwise the set_def_constant can be set on the add-on during runtime inside the shell command.
----------------------------------------

【177楼】 - smi
回复时间: 2022-09-27T06:17:36.193Z
----------------------------------------
@davidusb I’m using a 60 minutes step currently as I have pv production prices for one hours also (might consider changing that to 30 minutes and just doubling each value in the array). The heatpump is only for hot water production and therefore does not need to run several times a day. I will check the option “set_def_constant”. Regarding my question on timeframes: It would be cool if it’d be possible to set timeframes in which specific def loads are allowed to run. Not only to for example move this timeframe close to before it’s usually needed (like heating up the water in the afternoon so it’s hot when showering in the evening), but also as things like non-inverter (and therefore loud) heatpumps, especially for pools, might run in the mid of the night, disturbing neighbors and ourselfs. By saying “def_load_1 can only run between X and Y”, this issue could be addressed. Also, a minimum time between each run of a def load would be nice, to for example stop the device from running from 22:00 to 23:00 and then again from like 01:00 to 02:00 and not the rest of the day. @markpurcell My electric anode is separated from the heat pumps electrical wiring and therefore runs 24/7, only consuming a few watts. Unfortunately the water heat pump is dump. You can set a temperature and trigger it on/off, but no temperature increase based on a relay.
----------------------------------------

【178楼】 - markpurcell
回复时间: 2022-09-27T11:01:18.839Z
----------------------------------------
A second method uses the SolCast solar forecast service. Go to https://solcast.com/ and configure your system. You will need to set method=solcast and basically use two parameters solcast_rooftop_id and solcast_api_key that should be passed as parameters at runtime. I can see how to set the two parameters at runtime, but how do I set method=solcast if I’m using emhass-addon? Do I put this into the configuration file? If I am using the mpc optimisation and calling frequently will each optimisation result in another call to the SolCast API, noting that service has a limited number of calls allowed in each 24 hour period?
----------------------------------------

【179楼】 - davidusb
回复时间: 2022-09-27T11:34:20.557Z
----------------------------------------
When providing the Solcast parameters at runtime the method will be automatically changed internally, so no need to do anything else. Yes for each optimization call the Solcast API will be used. So I understand that this should be considered and adapt the optimization time steps accordingly
----------------------------------------

【181楼】 - RubberDucky
回复时间: 2022-10-01T18:37:43.788Z
----------------------------------------
Thanks for the input above about the configuration. I’m still in the process of configuration. I’m loading the solar forecast from Solcast manually using an own script and adding storing that in a csv file. I have two sites setup that need to be combined and I could only add one Solcast site id. I have confirmed that there is a CSV file in the /data folder with the forecast data. There is also a scipt running that downloads the electricity prices from my electricity provider and stores that in a CSV file. The configuration I have now is this: optim_conf: - load_cost_forecast_method: 'csv' # options are 'hp_hc_periods' for peak and non-peak hours contracts and 'csv' to load custom cost from CSV file - list_hp_periods: # list of different tariff periods (only needed if load_cost_forecast_method='hp_hc_periods') - period_hp_1: - start: '02:54' - end: '15:24' - period_hp_2: - start: '17:24' - end: '20:24' When I trigger a optimization I’m getting the following error in the docker console: [2022-10-01 11:25:58,714] INFO in command_line: Setting up needed data [2022-10-01 11:25:58,715] ERROR in app: Exception on /action/dayahead-optim [POST] Traceback (most recent call last): File "/usr/local/lib/python3.8/site-packages/flask/app.py", line 2525, in wsgi_app response = self.full_dispatch_request() File "/usr/local/lib/python3.8/site-packages/flask/app.py", line 1822, in full_dispatch_request rv = self.handle_user_exception(e) File "/usr/local/lib/python3.8/site-packages/flask/app.py", line 1820, in full_dispatch_request rv = self.dispatch_request() File "/usr/local/lib/python3.8/site-packages/flask/app.py", line 1796, in dispatch_request return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args) File "src/emhass/web_server.py", line 134, in action_call input_data_dict = set_input_data_dict(config_path, str(config_path.parent), costfun, File "/usr/local/lib/python3.8/site-packages/emhass-0.3.19-py3.8.egg/emhass/command_line.py", line 42, in set_input_data_dict retrieve_hass_conf, optim_conf, plant_conf = utils.get_yaml_parse(config_path, params=params) File "/usr/local/lib/python3.8/site-packages/emhass-0.3.19-py3.8.egg/emhass/utils.py", line 239, in get_yaml_parse optim_conf['list_hp_periods'] = dict((key,d[key]) for d in optim_conf['list_hp_periods'] for key in d) KeyError: 'list_hp_periods' In the /data folder I have these CSV files: data_load_cost_forecast.csv data_load_forecast.csv data_prod_price_forecast.csv data_pv_power_forecast.csv data_weather_forecast.csv Some content from data_pv_power_forecast.csv 2022-10-02 06:00:00+02:00,0 2022-10-02 06:30:00+02:00,0 2022-10-02 07:00:00+02:00,0 2022-10-02 07:30:00+02:00,0.048100000000000004 2022-10-02 08:00:00+02:00,0.31379999999999997 2022-10-02 08:30:00+02:00,0.8818999999999999 2022-10-02 09:00:00+02:00,1.6953 2022-10-02 09:30:00+02:00,2.6088 2022-10-02 10:00:00+02:00,3.5980999999999996 Some content from data_prod_price_forecast.csv 2022-10-01 20:00:00+02:00,1.0199 2022-10-01 21:00:00+02:00,0.9753 2022-10-01 22:00:00+02:00,1.0066 2022-10-01 23:00:00+02:00,0.998 2022-10-02 00:00:00+02:00,0.9714 Based on the comment # list of different tariff periods (only needed if load_cost_forecast_method='hp_hc_periods') after list_hp_periods this config option should not be needed. I’ve tried commenting that line and still I get the KeyError about list_hp_periods. I haven’t changed what’s in list_hp_periods, it’s still the same from the default config that came with the download of Emhass. Why is it throwing an error on this key and how can I fix that?
----------------------------------------

【182楼】 - davidusb
回复时间: 2022-10-01T19:37:33.760Z
----------------------------------------
Please open a new issue here: Issues · davidusb-geek/emhass · GitHub And provide some information about your setup. Are you using the add-on or the standalone docker install?
----------------------------------------

【183楼】 - RubberDucky
回复时间: 2022-10-02T08:10:43.935Z
----------------------------------------
RubberDucky: Based on the comment # list of different tariff periods (only needed if load_cost_forecast_method='hp_hc_periods') after list_hp_periods this config option should not be needed. I’ve tried commenting that line and still I get the KeyError about list_hp_periods. I haven’t changed what’s in list_hp_periods, it’s still the same from the default config that came with the download of Emhass. I’ve created an issue on Github: Error: KeyError: 'list_hp_periods' when running optimization with CSV option · Issue #24 · davidusb-geek/emhass · GitHub Emhass is running in a standalone docker container.
----------------------------------------

【184楼】 - mamutel
回复时间: 2022-10-02T20:46:47.175Z
----------------------------------------
Port ‘5000’ is already in use by something else on the host Could it be some other port 5000 is used by the electrical vehicle addon. Thank you
----------------------------------------

【185楼】 - davidusb
回复时间: 2022-10-02T21:00:41.215Z
----------------------------------------
Yes, this is somewhat painful. I’m struggling right now to implement ingress on the add-on and avoid this kind of issues. It is a work in progress but I’m stuck, help wanted here: Feature request: Access EMHASS web interface via ingress · Issue #22 · davidusb-geek/emhass · GitHub
----------------------------------------

【186楼】 - sladey
回复时间: 2022-10-03T07:37:18.404Z
----------------------------------------
Hi David, I hope this is an easy questions as I am just getting started with EMHASS. I am in the southern hemisphere so latitudes are negative. This seems to be causing issues with getting the weather forecast. [2022-10-03 18:29:08,050] ERROR in app: Exception on /action/dayahead-optim [POST] Traceback (most recent call last): File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 2525, in wsgi_app response = self.full_dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1822, in full_dispatch_request rv = self.handle_user_exception(e) File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1820, in full_dispatch_request rv = self.dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1796, in dispatch_request return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args) File "/usr/local/lib/python3.9/dist-packages/emhass/web_server.py", line 134, in action_call input_data_dict = set_input_data_dict(config_path, str(config_path.parent), costfun, File "/usr/local/lib/python3.9/dist-packages/emhass/command_line.py", line 76, in set_input_data_dict df_weather = fcst.get_weather_forecast(method=optim_conf['weather_forecast_method']) File "/usr/local/lib/python3.9/dist-packages/emhass/forecast.py", line 181, in get_weather_forecast raw_data.loc[count_row, col] = float(row.get_text()) ValueError: could not convert string to float: '-' Config is lat: -33.79843 lon: 151.224112 alt: 75
----------------------------------------

【187楼】 - davidusb
回复时间: 2022-10-03T08:29:27.351Z
----------------------------------------
Hi, are you using the add-on or the docker standalone mode? If using the add-on, the lat/lon values will retrieved directly from your core HA configuration. So check that. Otherwise I’ve just tested that clearoutside can accept negative latitudes with no problem. So the iussue is somewhere else. See: https://clearoutside.com/forecast/-33/151?desktop=true
----------------------------------------

【188楼】 - sladey
回复时间: 2022-10-03T11:34:10.509Z
----------------------------------------
I am using the add-on. I removed the lat and lon from the emhass config and picked it up from HA and I am seeing the same issue. When I put more specific lat/lon in I see the following data which has “-” in some of the table cells. I assume this is a case of incomplete data from clearoutside. Maybe I need to shift to Solcast. Screen Shot 2022-10-03 at 10.31.34 pm 1920×1247 184 KB
----------------------------------------

【189楼】 - markpurcell
回复时间: 2022-10-03T11:44:06.459Z
----------------------------------------
Odd, I’m southern hemisphere and the forecast module has not missed a beat, subscribers a little inaccurate so I have switch to solcast now.
----------------------------------------

【190楼】 - davidusb
回复时间: 2022-10-03T12:02:18.955Z
----------------------------------------
You don’t need to put or add any additional parameters from those readily available to modify on the add-on configuration pane. Please share your complete configuration file (change the sensible/private information) and the automation commands that you’re using to trigger the optimization task. I’m betting that this is the problem: I removed the lat and lon from the emhass config and picked it up from HA and I am seeing the same issue. You’re adding some parameters that don’t need to be there.
----------------------------------------

【191楼】 - sladey
回复时间: 2022-10-03T23:32:08.996Z
----------------------------------------
Hey David, it is working now. It looks like it was a temporary glitch in the data from Clear Outside v1.0 - International Weather Forecasts For Astronomers . In today’s data from there I see no “-” in any table cells. Thanks for your help.
----------------------------------------

【192楼】 - davidusb
回复时间: 2022-10-04T11:54:53.196Z
----------------------------------------
You can change the port here on the configuration pane: image 1065×282 8.66 KB
----------------------------------------

【193楼】 - smi
回复时间: 2022-10-04T12:16:16.285Z
----------------------------------------
Hi, after I changed the name of the load sensor without the deferable loads, EMHASS changed its time to 27.04.2022 and is no longer accepting dayahead forecast triggers: Log from Node-Red, which triggers the forecast: payload: 'HTTP/1.1 500 INTERNAL SERVER ERROR\r\n' + 'Content-Length: 265\r\n' + 'Content-Type: text/html; charset=utf-8\r\n' + 'Date: Tue, 04 Oct 2022 12:12:31 GMT\r\n' + 'Server: waitress\r\n' + '\r\n' + '&lt;!doctype html&gt;\n' + '&lt;html lang=en&gt;\n' + '&lt;title&gt;500 Internal Server Error&lt;/title&gt;\n' + '&lt;h1&gt;Internal Server Error&lt;/h1&gt;\n' + '&lt;p&gt;The server encountered an internal error and was unable to complete your request. Either the server is overloaded or there is an error in the application.&lt;/p&gt;\n', EMHASS: [2022-10-04 14:12:31,761] INFO in command_line: Setting up needed data [2022-10-04 14:12:31,867] INFO in forecast: Retrieving weather forecast data using method = scrapper [2022-10-04 14:12:34,419] INFO in forecast: Retrieving data from hass for load forecast using method = naive [2022-10-04 14:12:34,421] INFO in retrieve_hass: Retrieve hass get data method initiated... [2022-10-04 14:12:34,478] ERROR in retrieve_hass: The retrieved JSON is empty, check that correct day or variable names are passed [2022-10-04 14:12:34,479] ERROR in retrieve_hass: Either the names of the passed variables are not correct or days_to_retrieve is larger than the recorded history of your sensor (check your recorder settings) [2022-10-04 14:12:34,480] ERROR in app: Exception on /action/dayahead-optim [POST] Traceback (most recent call last): File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 2525, in wsgi_app response = self.full_dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1822, in full_dispatch_request rv = self.handle_user_exception(e) File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1820, in full_dispatch_request rv = self.dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1796, in dispatch_request return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args) File "/usr/local/lib/python3.9/dist-packages/emhass/web_server.py", line 134, in action_call input_data_dict = set_input_data_dict(config_path, str(config_path.parent), costfun, File "/usr/local/lib/python3.9/dist-packages/emhass/command_line.py", line 78, in set_input_data_dict P_load_forecast = fcst.get_load_forecast(method=optim_conf['load_forecast_method']) File "/usr/local/lib/python3.9/dist-packages/emhass/forecast.py", line 495, in get_load_forecast rh.get_data(days_list, var_list) File "/usr/local/lib/python3.9/dist-packages/emhass/retrieve_hass.py", line 130, in get_data self.df_final = pd.concat([self.df_final, df_day], axis=0) UnboundLocalError: local variable 'df_day' referenced before assignment That’s the function: { payload: `curl -i -H "Content-Type: application/json" -X POST -d '{"prod_price_forecast":[0.22381,0.22381,0.2252,0.2252,0.24414,0.24414,0.3288,0.3288,0.37426,0.37426,0.4733,0.4733,0.33011999999999997,0.33011999999999997,0.24231000000000003,0.24231000000000003,0.31518999999999997,0.31518999999999997,0.27918,0.27918,0.17394,0.17394,0.09236,0.09236,0.09134,0.09134,0.07735,0.07735,0.1325,0.1325,0.1852,0.1852,0.22561,0.22561,0.25519,0.25519,0.25218,0.25218,0.22204000000000002,0.22204000000000002,0.18003000000000002,0.18003000000000002,0.17619,0.17619,0.2028,0.2028,0.19917,0.19917]}' http://localhost:5000/action/dayahead-optim`, solcast_rooftop_id: '889c-2e66-aebc-99b8', solcast_api_key: 'SECRET', _msgid: 'SECRET' } Any idea why this happens? Thanks
----------------------------------------

【194楼】 - smi
回复时间: 2022-10-04T12:24:46.840Z
----------------------------------------
Ah ok sure, I have to wait till the new sensor is at least 2 days old. But is this also the reason for the completely wrong date?
----------------------------------------

【195楼】 - davidusb
回复时间: 2022-10-04T12:54:52.603Z
----------------------------------------
Yes, totally normal, those are just the dates of the initial test results that are used to show an initial glimpse of what an optimization result should look like. If you find that this is misleading or that this creates confusion then I can contemplate eliminating those initial results. What do you think?
----------------------------------------

【196楼】 - davidusb
回复时间: 2022-10-05T21:02:23.680Z
----------------------------------------
I’ve just released a new version of the core package v0.3.20 and a new version of the add-on v0.2.22: Release EMHASS add-on v0.2.22 · davidusb-geek/emhass-add-on · GitHub This is a new release with a bunch of improvements, most notably added direct support for the Solar.Forecast method to forecast PV power. Also: Added more detailed examples to the forecast module documentation. Improved handling of datatime indexes in DataFrames on forecast module. Added warning messages if passed list values contains non numeric items. Added missing unittests for forecast module with request.get dependencies using MagicMock. The Docker images to update the add-on should be available soon. Cheers!
----------------------------------------

【197楼】 - per.takman
回复时间: 2022-10-06T22:33:50.275Z
----------------------------------------
Hi David, I’m planning to use EMHASS in out future solar panel and energy storage installation in our house. I’ve been attempting to setup the planned installation in the configuration tab for your add-on, but I’m struggling a bit to say the least. Our planned installation has 3 roofs (~east, ~west, ~south) with a total of 51 panels from Solar-fabrik S3-N 375Wp ( Solar-fabrik S3-N 375Wp glas-teknik - Energiteknik i Kungälv AB ) I will use an Energyhub from Ferroamp. The roof facing east will have 27 panels, the one facing west 16 and the one facing south 8. The roof facing east will have two SSO’s (Solar String Optimizer) and the other two one each. Below is the configuration for EMHASS. I could not find the panels or the Energyhub. For the panels I believe I’ve found something that is close enough. For the inverter I’m bit lost on what to choose. hass_url: empty long_lived_token: empty costfun: profit optimization_time_step: 60 historic_days_to_retrieve: 2 method_ts_round: nearest set_total_pv_sell: false lp_solver: GLPK_CMD lp_solver_path: empty sensor_power_photovoltaics: sensor.power_production_address sensor_power_load_no_var_loads: sensor.power_address number_of_deferrable_loads: 1 list_nominal_power_of_deferrable_loads: - nominal_power_of_deferrable_loads: 3000 list_operating_hours_of_each_deferrable_load: - operating_hours_of_each_deferrable_load: 4 list_peak_hours_periods_start_hours: - peak_hours_periods_start_hours: "02:54" - peak_hours_periods_start_hours: "17:24" list_peak_hours_periods_end_hours: - peak_hours_periods_end_hours: "15:24" - peak_hours_periods_end_hours: "20:24" list_treat_deferrable_load_as_semi_cont: - treat_deferrable_load_as_semi_cont: true load_peak_hours_cost: 600 load_offpeak_hours_cost: 300 photovoltaic_production_sell_price: 300 maximum_power_from_grid: 13800 list_pv_module_model: - pv_module_model: LG_Electronics_Inc__LG375N2T_A4 - pv_module_model: LG_Electronics_Inc__LG375N2T_A4 - pv_module_model: LG_Electronics_Inc__LG375N2T_A4 list_pv_inverter_model: - pv_inverter_model: Fronius_International_GmbH__Fronius_Primo_15_0_1_208_240__208V_ - pv_inverter_model: Fronius_International_GmbH__Fronius_Primo_15_0_1_208_240__208V_ - pv_inverter_model: Fronius_International_GmbH__Fronius_Primo_15_0_1_208_240__208V_ list_surface_tilt: - surface_tilt: 23 - surface_tilt: 23 - surface_tilt: 27 list_surface_azimuth: - surface_azimuth: 109 - surface_azimuth: 289 - surface_azimuth: 199 list_modules_per_string: - modules_per_string: 27 - modules_per_string: 16 - modules_per_string: 8 list_strings_per_inverter: - strings_per_inverter: 1 - strings_per_inverter: 1 - strings_per_inverter: 1 set_use_battery: true battery_discharge_power_max: 8200 battery_charge_power_max: 6600 battery_discharge_efficiency: 0.96 battery_charge_efficiency: 0.96 battery_nominal_energy_capacity: 14200 battery_minimum_state_of_charge: 0.1 battery_maximum_state_of_charge: 0.9 battery_target_state_of_charge: 0.6 web_ui_url: 0.0.0.0 When I trigger a day-ahead optimization I see the following log traces: s6-rc: info: service s6rc-oneshot-runner: starting s6-rc: info: service s6rc-oneshot-runner successfully started s6-rc: info: service fix-attrs: starting s6-rc: info: service fix-attrs successfully started s6-rc: info: service legacy-cont-init: starting s6-rc: info: service legacy-cont-init successfully started s6-rc: info: service legacy-services: starting services-up: info: copying legacy longrun emhass (no readiness notification) s6-rc: info: service legacy-services successfully started [2022-10-07 00:21:11,486] INFO in web_server: Launching the emhass webserver at: http://0.0.0.0:5000 [2022-10-07 00:21:11,487] INFO in web_server: Home Assistant data fetch will be performed using url: http://supervisor/core/api [2022-10-07 00:21:11,487] INFO in web_server: The base path is: /usr/src [2022-10-07 00:21:11,491] INFO in web_server: Using core emhass version: 0.3.20 [2022-10-07 00:21:12,414] INFO in command_line: Setting up needed data [2022-10-07 00:21:12,499] WARNING in utils: There are non numeric values on the passed data, check for missing values (nans, null, etc) [2022-10-07 00:21:12,500] WARNING in utils: There are non numeric values on the passed data, check for missing values (nans, null, etc) [2022-10-07 00:21:12,506] INFO in forecast: Retrieving weather forecast data using method = scrapper [2022-10-07 00:21:15,448] INFO in forecast: Retrieving data from hass for load forecast using method = naive [2022-10-07 00:21:15,451] INFO in retrieve_hass: Retrieve hass get data method initiated... [2022-10-07 00:21:18,952] INFO in web_server: &gt;&gt; Performing dayahead optimization... [2022-10-07 00:21:18,952] INFO in command_line: Performing day-ahead forecast optimization [2022-10-07 00:21:18,977] INFO in optimization: Perform optimization for the day-ahead [2022-10-07 00:21:19,380] INFO in optimization: Status: Optimal [2022-10-07 00:21:19,381] INFO in optimization: Total value of the Cost function = 313.78 I see a warning that I don’t know what to do with: [2022-10-07 00:21:12,499] WARNING in utils: There are non numeric values on the passed data, check for missing values (nans, null, etc) [2022-10-07 00:21:12,500] WARNING in utils: There are non numeric values on the passed data, check for missing values (nans, null, etc) Have I configured EMHASS correctly or what is causing the warning? I’m also asking myself why I can’t see a difference in PV forecast when I change the azimuth angle for the panels? I’m hoping that you have the possibility to help out because I really wish to use this add-on to optimize usage of our future investment. Warmly, Per
----------------------------------------

【198楼】 - davidusb
回复时间: 2022-10-07T18:26:45.661Z
----------------------------------------
Just check the passed data for non numeric values. You are passing data that contains nan’s or null values. The nan’s are handled on the code and filled with valid data. So the optimization can run without problems. However you should just check your data integrity, hence the warning message. For the inverter model just pick one with the same nominal power as yours. That will be enough.
----------------------------------------

【199楼】 - per.takman
回复时间: 2022-10-16T22:29:53.346Z
----------------------------------------
Hi @davidusb ! I’m trying to create a difference in price between load_cost_forecast and prod_price_forecast to take into account for the costs associated with transportation of the electricity by our utility supplier Ellevio when I purchase and sell electricity. I want to add 0.75 SEK to load_cost_forecast and 0.631 SEK to prod_price_forecast. dayahead_optim: 'curl -i -H ''Content-Type: application/json'' -X POST -d ''{"load_cost_forecast":{{( (state_attr(''sensor.tibber_prices'', ''tomorrow'')|map(attribute=''total'')|list)[:24]) }},"prod_price_forecast":{{( (state_attr(''sensor.tibber_prices'', ''tomorrow'')|map(attribute=''total'')|list)[:24])}}}'' http://localhost:5000/action/dayahead-optim' Lists does not appear to handle just adding a float number. I’m struggling with the syntax and need some help. The sensor Tibber prices is defined as below: - platform: rest name: Tibber prices resource: https://api.tibber.com/v1-beta/gql method: POST scan_interval: 60 payload: '{ "query": "{ viewer { homes { currentSubscription { priceInfo { today { total startsAt } tomorrow { total startsAt }}}}}}" }' json_attributes_path: "$.data.viewer.homes[0].currentSubscription.priceInfo" json_attributes: - today - tomorrow value_template: Ok headers: Authorization: "personal_token" Content-Type: application/json User-Agent: REST Cheers, Per
----------------------------------------

【200楼】 - haraldov
回复时间: 2022-10-18T08:29:05.002Z
----------------------------------------
I trying to use emhass to start and stop the dishwasher which takes five hours to complete. I use this config for the dishwasher: nominal_power_of_deferrable_loads: 1500 operating_hours_of_each_deferrable_load: 5 In the documentation it says this parameter are the total number of hours that each deferrable load should operate. Emhass chart gives me these schedules which are less than 5 hours running time, which my dishwasher needs to be finished. How can I get a schedule which are 5 hours (or more) running time? image 932×711 17.3 KB
----------------------------------------

【201楼】 - markpurcell
回复时间: 2022-10-18T08:34:50.770Z
----------------------------------------
Have a look at the set_def_constant variable. If you set True it should schedule a continuous block of 5 hours for you. set_def_constant: Define if we should set each deferrable load as a constant fixed value variable with just one startup for each optimization task. For example: False
----------------------------------------

【202楼】 - haraldov
回复时间: 2022-10-18T08:58:15.123Z
----------------------------------------
Thank you for your help. I am using emhass addon and in the config I do not have “set_def_constant”. But I have already True for treat_deferrable_load_as_semi_cont. Maybe these two are the same? treat_deferrable_load_as_semi_cont: Define if we should treat each deferrable load as a semi-continuous variable. Semi-continuous variables are variables that can take either their nominal value or zero.
----------------------------------------

【203楼】 - davidusb
回复时间: 2022-10-18T09:05:16.721Z
----------------------------------------
The variable set_def_constant is available to be changed at runtime when executing the shell command. Like this: curl -i -H 'Content-Type:application/json' -X POST -d '{"set_def_constant":[True, False]}' http://localhost:5000/action/dayahead-optim You should be able to pass a bunch of other data and parameters if needed. See here: Intro / Quick start — emhass 0.3.20 documentation
----------------------------------------

【204楼】 - markpurcell
回复时间: 2022-10-18T09:06:47.296Z
----------------------------------------
Unfortunately not, semi continuous false allows the device power setting to be between 0 and the nominal value. I use that for charging my EV at different charging rates depending on my Solar production. Correction: the variable needs to be passed at runtime.
----------------------------------------

【205楼】 - davidusb
回复时间: 2022-10-18T09:25:04.270Z
----------------------------------------
It may be easy to create a custom template sensor for what you want to do. Here is an example where I add the value 100 to each element of my original list: {%- set power = state_attr('sensor.solcast_forecast_data', 'forecasts') | map(attribute='pv_estimate') | list %} {%- set values_all = namespace(all=[]) %} {% for i in range(power | length) %} {%- set v = (power[i] | float ) %} {%- set values_all.all = values_all.all + [ v + 100 ] %} {%- endfor %} {{ (values_all.all)[:5] }} The original list was: [1.4217, 1.8679, 2.2476, 2.59, 2.8162] The resulting list: [101.4217, 101.8679, 102.2476, 102.59, 102.8162]
----------------------------------------

【206楼】 - haraldov
回复时间: 2022-10-18T09:32:29.492Z
----------------------------------------
Thanks for help @markpurcell and @davidusb .
----------------------------------------

【207楼】 - haraldov
回复时间: 2022-10-18T13:30:47.345Z
----------------------------------------
davidusb: The variable set_def_constant is available to be changed at runtime when executing the shell command Is there any way I can see the current settings for ‘set_def_constant’? If this does not exist then it would be nice if we could have it. I get no feedback in the emhass log when I run the service shell_command “publish_def_true”. shell_command: publish_data: "curl -i -H 'Content-Type:application/json' -X POST -d '{}' http://localhost:5000/action/publish-data" publish_def_true: "curl -i -H 'Content-Type:application/json' -X POST -d '{'set_def_constant':True}' http://localhost:5000/action/dayahead-optim" Is it correct that ‘publish_def_true’ applies to all deferrable loads. What do you do if there is a need for a deferrable loads that you need ‘set_def_constant’:False? As an example, the water heater can heat up over several periods, instead of having a long continuous heating.
----------------------------------------

【208楼】 - davidusb
回复时间: 2022-10-18T14:16:51.457Z
----------------------------------------
It should be a list of boolean, exactly as in the example that I posted before. This is for two (2) deferrable loads: {"set_def_constant":[True, False]}
----------------------------------------

【209楼】 - haraldov
回复时间: 2022-10-18T16:38:06.609Z
----------------------------------------
I need som help with the shell_command. I have tried publishing the variable “set_def_constant” many times with the shell_command and the webserver says “400 Bad Request”. I tried with and without tickets (“curl -i …”). shell_command: publish_data: "curl -i -H 'Content-Type:application/json' -X POST -d '{}' http://localhost:5000/action/publish-data" publish_def_true: "curl -i -H 'Content-Type:application/json' -X POST -d '{\"set_def_constant\":[True, False]}' http://localhost:5000/action/dayahead-optim" 2022-10-18 18:33:23.804 DEBUG (MainThread) [homeassistant.components.shell_command] Stdout of command: `curl -i -H 'Content-Type:application/json' -X POST -d '{"set_def_constant":[True, False]}' http://localhost:5000/action/dayahead-optim`, return code: 0: b'HTTP/1.1 400 BAD REQUEST\r\nContent-Length: 167\r\nContent-Type: text/html; charset=utf-8\r\nDate: Tue, 18 Oct 2022 16:33:23 GMT\r\nServer: waitress\r\n\r\n&lt;!doctype html&gt;\n&lt;html lang=en&gt;\n&lt;title&gt;400 Bad Request&lt;/title&gt;\n&lt;h1&gt;Bad Request&lt;/h1&gt;\n&lt;p&gt;The browser (or proxy) sent a request that this server could not understand.&lt;/p&gt;\n' 2022-10-18 18:33:23.804 DEBUG (MainThread) [homeassistant.components.shell_command] Stderr of command: `curl -i -H 'Content-Type:application/json' -X POST -d '{"set_def_constant":[True, False]}' http://localhost:5000/action/dayahead-optim`, return code: 0: b' % Total % Received % Xferd Average Speed Time Time Time Current\n Dload Upload Total Spent Left Speed\n\r 0 0 0 0 0 0 0 0 --:--:-- --:--:-- --:--:-- 0\r100 201 100 167 100 34 28912 5886 --:--:-- --:--:-- --:--:-- 40200\n' shell_command: publish_data: "curl -i -H 'Content-Type:application/json' -X POST -d '{}' http://localhost:5000/action/publish-data" publish_def_true: curl -i -H 'Content-Type:application/json' -X POST -d '{"set_def_constant":[True, False]}' http://localhost:5000/action/dayahead-optim 2022-10-18 18:26:00.836 INFO (MainThread) [homeassistant.components.script.varmekabler_nystue_gmlstue_kjokken_og_gang_lav_temperatur] Varmekabler nystue, gmlstue, kjokken og gang: Lav temperatur: Repeat at step 1: Executing step delay 0:00:10 2022-10-18 18:26:01.018 DEBUG (MainThread) [homeassistant.components.shell_command] Stdout of command: `curl -i -H 'Content-Type:application/json' -X POST -d '{"set_def_constant":[True, False]}' http://localhost:5000/action/dayahead-optim`, return code: 0: b'HTTP/1.1 400 BAD REQUEST\r\nContent-Length: 167\r\nContent-Type: text/html; charset=utf-8\r\nDate: Tue, 18 Oct 2022 16:26:00 GMT\r\nServer: waitress\r\n\r\n&lt;!doctype html&gt;\n&lt;html lang=en&gt;\n&lt;title&gt;400 Bad Request&lt;/title&gt;\n&lt;h1&gt;Bad Request&lt;/h1&gt;\n&lt;p&gt;The browser (or proxy) sent a request that this server could not understand.&lt;/p&gt;\n' 2022-10-18 18:26:01.018 DEBUG (MainThread) [homeassistant.components.shell_command] Stderr of command: `curl -i -H 'Content-Type:application/json' -X POST -d '{"set_def_constant":[True, False]}' http://localhost:5000/action/dayahead-optim`, return code: 0: b' % Total % Received % Xferd Average Speed Time Time Time Current\n Dload Upload Total Spent Left Speed\n\r 0 0 0 0 0 0 0 0 --:--:-- --:--:-- --:--:-- 0\r100 201 100 167 100 34 23564 4797 --:--:-- --:--:-- --:--:-- 33500\n'
----------------------------------------

【210楼】 - per.takman
回复时间: 2022-10-18T17:52:05.081Z
----------------------------------------
Thank you @davidusb ! I actually figured it out using the example with the solcast forecast. It appears to work well for me as well. One thing I’ve been meaning to discuss with you and possible inject as a feature request is to differentiate the cost for production by discharging an energy storage solution from solar power production. My thinking is that it would make sense to be able to add the cost per kWh for wear of the batteries when using them. One way of handling this until my solar panels are installed would be to subtract the cost per kWh usage of the batteries from the production_price_forecast. However, this solution will not work when we install solar panels since it will always make sense to produce when the sun delivers. Do you think that adding a third price forecast or even better a fixed cost per kWh under the battery settings would add value to your project? I estimate that my energy storage solution costs around 1.03 SEK/kWh when I take capacity, efficiency and number of cycles into account. This means that I’d like to see price differences above 1.03 SEK + 0.119 SEK (difference in cost for transportation over the power grid) for it to make sense to discharge relative to when it was charged. Let me know what you think about the idea and whether your framework would allow for it! Warmly, Per
----------------------------------------

【211楼】 - davidusb
回复时间: 2022-10-18T19:26:59.791Z
----------------------------------------
Penalizing the battery usage is an option. But with the current code this is also possible by using the battery SOC min/max limitations. By using these you should be able to constraint the battery depth of discharge (DOD) which is a direct function of the total number of cycles of a battery in its lifetime. This is the way to go. Another option is to add a penalty on battery number of cycles, but this will just add more equations and more burden on the open source linear programming solvers that we rely on. So this a no go.
----------------------------------------

【212楼】 - per.takman
回复时间: 2022-10-18T20:01:28.272Z
----------------------------------------
Thank you for the quick reply! It sounds like I got my point across, but I don’t quite understand how to use SOC min/max limitations to determine when to charge/discharge taking cost for the battery into account. Can you elaborate on how to achieve this so that it corresponds to what I’m after? My understanding of the SOC that is published to HA is that I’m supposed to write automations that make sure that my SOC follows what EMHASS has found to be optimal. If the cost for usage is not taken into account when optimizing it seems hard to know when to refrain from discharging or am I missing something? I agree that adding a penalty to the number of cycles does not seem like the way to go. Forgive me for making a statement without knowing the complexity of your code, but to me it seems reasonable that different sources of energy can have different cost/profit principles that should govern how they are utilized. Let me know if you find this suggestion good enough to consider! If not I will attempt to figure out some logic that I can use in the automations that control discharge/charge from HA that prevent non-profitable discharge cycles. Warmly, Per Takman
----------------------------------------

【213楼】 - davidusb
回复时间: 2022-10-19T05:52:48.603Z
----------------------------------------
per.takman: It sounds like I got my point across, but I don’t quite understand how to use SOC min/max limitations to determine when to charge/discharge taking cost for the battery into account. Can you elaborate on how to achieve this so that it corresponds to what I’m after? My understanding of the SOC that is published to HA is that I’m supposed to write automations that make sure that my SOC follows what EMHASS has found to be optimal. If the cost for usage is not taken into account when optimizing it seems hard to know when to refrain from discharging or am I missing something? What I meant is that instead of applying a different cost for a battery discharge, you can directly use the available SOC limits to affect the battery ageing. As I said at the end the battery ageing is direct function of the DOD which in turn depends on SOC min/max limitations. So instead of applying a “cost” we can use these parameters to improve the battery ageing. For higher DOD’s the battery will provide less lifetime cycles. For lower DOD’s the battery will achieve higher lifetime number of cycles. Fixing SOC_min = 0 and SOC_max = 100 will give you the higher possible DOD. If you want to be more conservative and save your battery life then just change that to more constrained values, say SOC_min = 30 and SOC_max = 90 . So if you want to save your battery life then constraint the DOD. I understand your point and that’s why I said that penalizing the battery usage could be an option. But also as I said we should focus on solutions that will minimize the number of equations to solve. If we add a different cost for battery discharge the this will just add more equation to solve. Some user with more than two deferrable load are very close to the open source solver limits, so adding more equations is really not a viable option. This will be a very different story if we relied on commercial LP solvers like CPLEX or Gurobi, but the problem is that these are REALLY expensive. I agree that adding a penalty to the number of cycles does not seem like the way to go. Forgive me for making a statement without knowing the complexity of your code, but to me it seems reasonable that different sources of energy can have different cost/profit principles that should govern how they are utilized. Let me know if you find this suggestion good enough to consider! If not I will attempt to figure out some logic that I can use in the automations that control discharge/charge from HA that prevent non-profitable discharge cycles. This correct, you can and should use some simple rules to directly control your battery based on the provided optimized schedule. You can the apply some basic automations to further constraint your battery in order to slow its ageing.
----------------------------------------

【214楼】 - per.takman
回复时间: 2022-10-19T05:57:41.101Z
----------------------------------------
Thank you for elaborating! I will attempt to use SOC_min/max to dynamically adjust the behavior based on profitability. Possibly by looking at price delta during the day. I don’t have the domain knowledge required to understand the limits. But I appreciate that you’ve taken the time to make the world a better place by providing this add-on for HA. Cheers, Per
----------------------------------------

【215楼】 - haraldov
回复时间: 2022-10-19T17:07:33.969Z
----------------------------------------
haraldov: I need som help with the shell_command. I have tried publishing the variable “set_def_constant” many times with the shell_command and the webserver says “400 Bad Request”. I tried with and without tickets (“curl -i …”). The list of boolean values needs lowercase letters {“set_def_constant”:[true, false]}. The shell command: shell_command: publish_def_true: curl -i -X POST http://localhost:5000/action/dayahead-optim -H "Content-Type:application/json" -d '{"set_def_constant":[true,true]}'
----------------------------------------

【216楼】 - per.takman
回复时间: 2022-10-19T20:56:43.792Z
----------------------------------------
Hi again, I discovered a problem with my value_template that took some effort to debug. It turns out that the maximum number of characters is 255 for a list. If you pay attention to round off the numbers after adding/subtracting a float you sometimes exceed maximum length for the list. This cause the sensor to become unavailable. The code below takes care of that! electricity_production_price: friendly_name: "Electricity production price" value_template: &gt;- {%- set data = state_attr('sensor.tibber_prices', 'today') | map(attribute='total') | list %} {%- set values = namespace(all=[]) %} {% for i in range(data | length) %} {%- set v = ((data[i] | float + 0.63 - 1.03) |round(4)) %} {%- set values.all = values.all + [ v ] %} {%- endfor %} {{ (values.all)[:24] }} availability_template: &gt; {{states('sensor.tibber_prices') in ['Ok']}}
----------------------------------------

【217楼】 - mirecekd
回复时间: 2022-10-21T14:27:15.857Z
----------------------------------------
Hi David, with new forecast.solar in 0.3.20 there are some “approximation” of values which should be zeroed (solar forecast from dusk till dawn. Current situation: image 1390×661 35.9 KB Last “correct” value is for 17:00 than it goes up on linear trend till 8:00+ when forecast.solar prediction begins for my coordinates. Did i miss some new option to zero values in forecast.solar? set_zero_min is True. With the scrape method values are ok. Thanks Mirek
----------------------------------------

【218楼】 - davidusb
回复时间: 2022-10-21T18:48:03.285Z
----------------------------------------
Well this seems like a bug that needs to be solved. I didn’t see this behavior when I tested this. It will be solved on the next version. Switch to another method for now and thanks for reporting this.
----------------------------------------

【219楼】 - theailer
回复时间: 2022-11-03T15:56:41.977Z
----------------------------------------
Hi and thanks for EMHASS This might be a more of a general HASS question but is there a way to retain the data that have been generated from EMHASS ? When my system reboots after an update or whatever the data is lost and the way it is setup in my system I need to wait until 23:xx until I generate a new optimization. I guess it could be solved by a smarter list that takes the time into account but I’m not that good.
----------------------------------------

【220楼】 - davidusb
回复时间: 2022-11-03T19:03:20.661Z
----------------------------------------
Hi. This is a known problem. Another user posted about the same issue some time ago. I haven’t taken the time to put an automation that could solve this, it seems feasible. If anyone else can put this together it would be awesome. One solution is to trigger an automation after a system restart to reuse the forecast values stored as attributes in the sensors published by emhass. This can be done with templates. Another solution is to relaunch the optimization task after a system restart, this will regenerate the optimization results file used to publish the sensors data. There may be other possible solutions…
----------------------------------------

【221楼】 - davidusb
回复时间: 2022-11-04T15:06:25.794Z
----------------------------------------
Ok I have putted together two possible automation to contour this problem with the easiest (and laziest) way. A first option is just to relaunch the optimization task after a Home Assistant restart, like this: - alias: Relaunch EMHASS tasks after HASS restart (option1) trigger: - platform: homeassistant event: start action: - service: shell_command.dayahead_optim A second option is that I now use is fitted to my case as I have putted some automations to control my deferrable loads based on two modes on an input_select : “Auto” and “Optim” modes. In my case the “Auto” mode will just use a predefined manual schedule for my load. The “Optim” mode is using the results from EMHASS. So when Home Assistant restart I can fallback to the “manual” mode and sendd me a notification to alert me from this. Like this: - alias: Relaunch EMHASS tasks after HASS restart (option2) trigger: - platform: homeassistant event: start action: - service: input_select.select_option target: entity_id: input_select.water_heater_mode data: option: Auto - service: notify.sms_free data_template: title: Changed water_heater_mode to Auto message: Home assistant restarted and automatically changed water_heater_mode to Auto mode, launch EMHASS optimization and set back to Optim mode A more complete and neat solution can be to reuse the forecast values stored as attributes in the sensors published by emhass as I said before using templates.
----------------------------------------

【222楼】 - theailer
回复时间: 2022-11-04T18:09:10.955Z
----------------------------------------
Yeah the reuse of the forecast values or in my case with my provider: It lists all the values for the current and next day in two different attributes, so if it somehow possible to write a template that takes the two lists and subtracts the historical values for the current day so that the list starts with the current time. All that is however beyond my copy and pasting skills
----------------------------------------

【223楼】 - davidusb
回复时间: 2022-11-04T23:58:10.629Z
----------------------------------------
You should be able to test the forecast.solar method after the current version update &gt;&gt; v0.2.23. Please confirm that it is now working as expected.
----------------------------------------

【224楼】 - mirecekd
回复时间: 2022-11-05T10:42:38.153Z
----------------------------------------
Hi David, I am building my own docker container for synology from github sources. But with the last commit on github I have still the same results with forecast.solar: image 1328×656 27.3 KB And maybe one suggestion - solar.forecast api is rate-limited for 1 IP for &lt;10 gets per hour. Could you try to implement option for scraping data from forecast.solar HA integration to emhass - to avoid this rate limits (HA websocket {“type”:“energy/solar_forecast”} )?
----------------------------------------

【225楼】 - davidusb
回复时间: 2022-11-05T18:59:32.933Z
----------------------------------------
So for me this problem exists just when I upgrade the add-on, not when HASS restarts. So the automation that is useful for me is finally this: - alias: Relaunch EMHASS tasks after HASS restart trigger: - platform: state entity_id: update.emhass_update to: 'off' for: minutes: 10 action: - service: shell_command.dayahead_optim - service: notify.sms_free data_template: title: Updated EMHASS and relaunched optimization message: The EMHASS add-on was updated and the optimization task was relaunched
----------------------------------------

【226楼】 - davidusb
回复时间: 2022-11-05T19:04:17.211Z
----------------------------------------
Bummer! I will look for this on the specific case of the standalone docker container. I didn’t test it with the docker container presuming that my unittests were sufficient. As for the number of API calls the easiest way will be to treat yourself the forecast.solar integration and build the list of values with templates, then pass them to emhass inside the shell command with the pv_power_forecast key.
----------------------------------------

【227楼】 - sladey
回复时间: 2022-11-12T22:56:35.424Z
----------------------------------------
Hi David, thanks to help from you and Mark I have EMHASS running nicely. My pool is several months away from completion and my EV is in the shop for repair so I don’t have many deferrable loads at the moment. My question is about home load forecasting. I was wondering if you had considered more “exotic” ways of generating the forecast. For example a federated learning approach that could see all those who use EMHASS leveraging a shared model that is trained locally. Here is an example recent paper explaining this approach. arxiv.org 2201.11248.pdf 498.68 KB I would be happy to run the central server if there is interest. Bit of a left field question!
----------------------------------------

【228楼】 - davidusb
回复时间: 2022-11-13T18:06:06.656Z
----------------------------------------
Hi. Yes this is very interesting and one of the main tasks to further improve EMHASS. Today we are only using a very naive persistance model. I begun some months ago with this subject and trained some machine learning models to try to predict my own load at home. You can check the results in this very thread some posts ago. I left this on a side while waiting to save more historical data, because at the time I realized that my recorder was set to purge every 30 days. My goal is to propose this load forecast based on machine learning as a new add-on or directly integrate it to EMHASS, but I fear the the docker will become too big. I basically benchmarked all the models in the Darts Python module which include some advanced deep learning models: LTSM, N-BEATS, etc. Now the approach in the paper that you show is very interesting and useful to preserve data privacy. What I propose is to start trying to obtain some nice results based on the user own historical data, then we can try to improve the system with the federated approach proposed in the paper. But if you put together the server and the necessary architecture to deal with the federated approach then I will be more than happy to contribute to the project. As I said I think that we should start simple (with no so simple deep learning models) then scale up with the federated approach. What do you think?
----------------------------------------

【229楼】 - torstein
回复时间: 2022-11-13T20:32:26.208Z
----------------------------------------
anyone who have a guide on how to implement tibber prices?
----------------------------------------

【230楼】 - sladey
回复时间: 2022-11-13T20:52:10.941Z
----------------------------------------
I agree we should start with a model that is shipped in the add on, then perhaps support to train the model with local data. Then we can see if there is sufficient improvement to warrant the federated learning approach. I’ll do some further investigation into what the needs of the central server are.
----------------------------------------

【231楼】 - theailer
回复时间: 2022-11-13T21:05:28.539Z
----------------------------------------
Well, I’m using Nordpools prices instead but the principle is the same. First I made a template that take Nordpools prices for tomorrow and then adds the transmission fee(in my case 0.69kr) electricity_consumption_price: friendly_name: "Elkons.pris med avgift" value_template: &gt;- {%- set data = state_attr('sensor.nordpool', 'raw_tomorrow') | map(attribute='value') | list %} {%- set values = namespace(all=[]) %} {% for i in range(data | length) %} {%- set v = ((data[i] | float + 0.69) |round(4)) %} {%- set values.all = values.all + [ v ] %} {%- endfor %} {{ (values.all)[:24] }} Then I use it like this when optimizing the data: post_nordpool_forecast: "curl -i -H 'Content-Type: application/json' -X POST -d '{\"load_cost_forecast\":{{( (states('sensor.electricity_production_price'))) }},\"prod_price_forecast\":{{( (state_attr('sensor.nordpool', 'raw_tomorrow')|map(attribute='value')|list)[:24])}}}' http://localhost:5000/action/dayahead-optim" Do note that I’ve copy pasted from other’s in this thread so the work can not be credited to me
----------------------------------------

【232楼】 - torstein
回复时间: 2022-11-14T18:58:07.601Z
----------------------------------------
Thank you. Now got the prices in. They do not match the right time but gues that they will do when I optimize 23:57
----------------------------------------

【233楼】 - torstein
回复时间: 2022-11-14T19:03:06.981Z
----------------------------------------
Finaly got everything up and running. I want to make an automatin that charges my home battery from the grid if there is profitt to be made by doing so. Also I do not want it to be charging to much if there is a good way with solar production the next day or hours before solar kicks in. Any suggestions on how this can be configured? If there is no higher prices the next hours when battery charging have been done i do not want to Charge from the grid. Also my hot water heater can run when power is cheapest if not solar is present. But I gues this works right out of the box?
----------------------------------------

【234楼】 - markpurcell
回复时间: 2022-11-14T19:10:06.724Z
----------------------------------------
The optimised schedule should set the correct values in sensors for you to do this. You then need to have some automatics to turn on your hot water and charge your battery. Which battery do you have? Is it in Home Assistant? Do you have some comments to start charging. Here is my plan for today you can see when my devices including my battery are scheduled to be switched by Home Assistant. Screenshot_20221115-060941 864×1920 191 KB
----------------------------------------

【235楼】 - torstein
回复时间: 2022-11-15T04:41:30.040Z
----------------------------------------
I can send mqtt to the inverter to turn on off charging or change the minimum soc. What sensor to you look for when doing this?
----------------------------------------

【236楼】 - markpurcell
回复时间: 2022-11-15T04:54:05.600Z
----------------------------------------
You have a few choices. There is a battery SOC forecast sensor; Screenshot_20221115-154942 864×1920 163 KB And a potential automation Screenshot_20221115-155202 864×1920 144 KB Or a battery power forecast sensor; Screenshot_20221115-155101 864×1920 163 KB With potential automation: alias: p_batt automation description: "" trigger: - platform: numeric_state entity_id: sensor.p_batt_forecast below: -4500 - platform: numeric_state entity_id: sensor.p_batt_forecast above: -4500 below: 4000 - platform: numeric_state entity_id: sensor.p_batt_forecast above: 4000 condition: [] action: - choose: - conditions: - condition: numeric_state entity_id: sensor.p_batt_forecast below: -4500 sequence: - service: select.select_option data: option: Backup target: entity_id: select.home_energy_gateway_operation_mode - service: notify.mobile_app_pixel_6 data: title: p_batt alert {{states('sensor.p_batt_forecast')}} - mode:backup message: Price:{{states('sensor.amber_general_price')}} $/kWh - conditions: - condition: numeric_state entity_id: sensor.p_batt_forecast above: 4000 enabled: true sequence: - service: select.select_option data: option: Self-Powered target: entity_id: select.home_energy_gateway_operation_mode - service: notify.mobile_app_pixel_6 data: title: &gt;- p_batt alert {{states('sensor.p_batt_forecast')}} - consider mode:autonomous message: Price:{{states('sensor.amber_general_price')}} $/kWh default: - service: select.select_option data: option: Self-Powered target: entity_id: select.home_energy_gateway_operation_mode - service: notify.mobile_app_pixel_6 data: title: &gt;- p_batt alert {{states('sensor.p_batt_forecast')}} - mode:self_consumption message: Price:{{states('sensor.amber_general_price')}} $/kWh mode: single
----------------------------------------

【237楼】 - torstein
回复时间: 2022-11-29T17:50:35.902Z
----------------------------------------
Ok. Will analyze the data from a time forward and see if it work as expected. But when summer is coming then i do not need to charge battery from grid. Will this understand this and not charge from the grid if it is not profit to be made? Think i saw this earlier when there was nothing to save by charging battery from grid that in the forcast it still wanted to charge the battery from grid based on forcast of soc and usage. Also when forcast soc is 90 or 50 do you send soc 100 and soc 0 to be consumption from battery to the inverters? Kind of hard to know how all of this works without testing this hard.
----------------------------------------

【238楼】 - markpurcell
回复时间: 2022-11-29T20:12:54.560Z
----------------------------------------
My pricing doesn’t vary much today (normally I get about 40¢ variation) so there is no point in charging from the grid. The EMHASS plan doesn’t want to charge from the grid. It keeps my battery around 50% SOC until the evening peak and then discharges. Normally if the evening peak was large it would charge during the day. Screenshot_20221130-060930 864×1920 191 KB
----------------------------------------

【239楼】 - markpurcell
回复时间: 2022-11-29T20:18:04.317Z
----------------------------------------
torstein: Also when forcast soc is 90 or 50 do you send soc 100 and soc 0 to be consumption from battery to the inverters? It depends on which battery you have and what commands are available. With the Powerwall2 I can set Backup reserve, if I set 100% then it will charge from grid, if I set reserve to 0% it doesn’t export, just allows consumption. The Time Based Control automations will export from the battery to the grid during peak windows.
----------------------------------------

【240楼】 - torstein
回复时间: 2022-11-30T11:40:10.940Z
----------------------------------------
markpurcell: It depends on which battery you have and what commands are available. With the Powerwall2 I can set Backup reserve, if I set 100% then it will charge from grid, if I set reserve to 0% it doesn’t export, just allows consumption. The Time Based Control automations will export from the battery to the grid during peak windows. index P_PV P_Load P_deferrable0 P_grid_pos P_grid_neg P_grid P_batt SOC_opt unit_load_cost unit_prod_price cost_profit cost_fun_selfcons 2022-11-30 00:00:00+01:00 -1.500000 2301.460674 0.0 2461.9441 0.0 2461.9441 -158.98343 0.608631 3.896 2.773 -9.591734 -9.591734 2022-11-30 01:00:00+01:00 -1.500000 2108.367688 2000.0 4900.0000 0.0 4900.0000 -790.13231 0.651523 3.780 2.680 -18.522000 -18.522000 2022-11-30 02:00:00+01:00 -1.500000 1799.433428 2000.0 4900.0000 0.0 4900.0000 -1099.06660 0.711187 3.737 2.646 -18.311300 -18.311300 2022-11-30 03:00:00+01:00 -1.500000 1775.278409 2000.0 4900.0000 0.0 4900.0000 -1123.22160 0.772162 3.694 2.611 -18.100600 -18.100600 2022-11-30 04:00:00+01:00 -1.500000 1632.909348 2000.0 4900.0000 0.0 4900.0000 -1265.59070 0.840865 3.776 2.677 -18.502400 -18.502400 2022-11-30 05:00:00+01:00 -1.500000 1809.178771 2000.0 4900.0000 0.0 4900.0000 -1089.32120 0.900000 3.826 2.717 -18.747400 -18.747400 2022-11-30 06:00:00+01:00 -1.500000 3660.277620 0.0 3661.7776 0.0 3661.7776 0.00000 0.900000 4.060 2.824 -14.866817 -14.866817 2022-11-30 07:00:00+01:00 -1.500000 3952.965812 0.0 3954.4658 0.0 3954.4658 0.00000 0.900000 5.325 3.836 -21.057530 -21.057530 2022-11-30 08:00:00+01:00 -1.500000 2344.498567 0.0 2345.9986 0.0 2345.9986 0.00000 0.900000 5.373 3.874 -12.605050 -12.605050 2022-11-30 09:00:00+01:00 -1.500000 1928.548105 0.0 0.0000 0.0 0.0000 1930.04810 0.783907 6.331 4.641 -0.000000 -0.000000 2022-11-30 10:00:00+01:00 60.234411 1733.764706 0.0 0.0000 0.0 0.0000 1673.53030 0.683243 6.465 4.748 -0.000000 -0.000000 2022-11-30 11:00:00+01:00 210.359176 1757.254438 0.0 1546.8953 0.0 1546.8953 0.00000 0.683243 5.361 3.865 -8.292906 -8.292906 2022-11-30 12:00:00+01:00 370.751610 2598.750716 0.0 2227.9991 0.0 2227.9991 0.00000 0.683243 5.325 3.836 -11.864095 -11.864095 2022-11-30 13:00:00+01:00 359.764121 1845.220670 0.0 4360.8159 0.0 4360.8159 -2875.35930 0.839334 5.266 3.789 -22.964057 -22.964057 2022-11-30 14:00:00+01:00 163.852435 1720.623229 0.0 1556.7708 0.0 1556.7708 0.00000 0.839334 5.326 3.837 -8.291361 -8.291361 2022-11-30 15:00:00+01:00 15.988537 1647.753501 0.0 1631.7650 0.0 1631.7650 0.00000 0.839334 5.311 3.825 -8.666304 -8.666304 2022-11-30 16:00:00+01:00 -1.500000 2564.144886 0.0 0.0000 0.0 0.0000 2565.64490 0.685010 6.505 4.780 -0.000000 -0.000000 2022-11-30 17:00:00+01:00 -1.500000 2561.808140 0.0 0.0000 0.0 0.0000 2563.30810 0.530826 6.832 5.042 -0.000000 -0.000000 2022-11-30 18:00:00+01:00 -1.500000 2313.297753 0.0 0.0000 0.0 0.0000 2314.79780 0.391590 6.728 4.958 -0.000000 -0.000000 2022-11-30 19:00:00+01:00 -1.500000 1521.182609 0.0 0.0000 0.0 0.0000 1522.68260 0.300000 6.339 4.647 -0.000000 -0.000000 2022-11-30 20:00:00+01:00 -1.500000 2844.982659 0.0 4305.2288 0.0 4305.2288 -1458.74610 0.379189 5.255 3.780 -22.623977 -22.623977 2022-11-30 21:00:00+01:00 -1.500000 3418.428977 0.0 4900.0000 0.0 4900.0000 -1480.07100 0.459536 4.672 3.313 -22.892800 -22.892800 2022-11-30 22:00:00+01:00 -1.500000 3679.946779 0.0 4900.0000 0.0 4900.0000 -1218.55320 0.525686 4.359 3.063 -21.359100 -21.359100 2022-11-30 23:00:00+01:00 -1.500000 3529.554572 0.0 4900.0000 0.0 4900.0000 -1368.94540 0.600000 3.860 2.744 -18.914000 -18.914000 Not sure if I have configured it wrong then. If you se forcast soc is when not pv input. I do not understnad that.
----------------------------------------

【241楼】 - markpurcell
回复时间: 2022-11-30T12:40:17.817Z
----------------------------------------
torstein: Not sure if I have configured it wrong then. If you se forcast soc is when not pv input. I do not understnad that Your configuration and results looks good. Your maximum PV is 370W which is very small. What size is your solar system? Based off your inputs it is fully charging your battery to 90% SOC by 05:00, as your overnight grid charges are cheap 3.6. It has correctly calculated this as the cheapest time to charge as it correctly identifies using your PV later saves you buying from the grid at 5.3. Are you able to automate your battery charging at this time via home assistant? When your max PV generation (12:00) 370 W, your household load is 2598W your grid price is 5.3 so it doesn’t use battery and imports the balance 2227 W from grid. Saving the battery for later. You get greater savings using the PV immediately rather than storing in your battery at this time. At the evening price spike (17:00) your grid price is the maximum 6.8 so it maximises your battery consumption 2563W so you don’t need to import anything from grid. It is scheduling your 2000W load to run at the cheapest time of the day overnight. Those all look like the optimal schedule for your household. You would get maximum benefits if you were about to increase your solar production to over 2500W.
----------------------------------------

【242楼】 - torstein
回复时间: 2022-11-30T17:49:12.490Z
----------------------------------------
Yes. It is winter time now so not much production. Also lot of rain. 10kw setup. Mabey you want to share the dashboard? Yes I can automate everything against inverter and battery.
----------------------------------------

【243楼】 - RatMondeo
回复时间: 2022-12-03T23:00:52.185Z
----------------------------------------
Hi, Just looking for some clarification or explanation and maybe some examples of the different load types. What does the “- treat_deferrable_load_as_semi_cont:” do, and what does it expect the load behaviour to be? I thought semi-continuous might be like a washing machine, which has high and low power use phases during its usage cycle, but I feel like I might be wrong here . . . Also any help in providing example to classify the following loads would be appreciated: Reverse-Cycle Air-Conditioner - with variable loads during cycle Dishwasher - load varies during the cycle Washing Machine - load varies during the cycle Heat Pump Hot water - load does not vary (but tricky to turn on and off due to compressor) Resistive electric hot water - load does not vary Zappi EV car charger - load can be variable and can be controlled dynamically Any help appreciated.
----------------------------------------

【244楼】 - markpurcell
回复时间: 2022-12-04T03:11:47.335Z
----------------------------------------
treat_def_as_semi_cont: Define if we should treat each deferrable load as a semi-continuous variable. Semi-continuous variables are variables that must take a value between their minimum and maximum or zero. The semi continuous load is one that you can set a value for, from you list the best example would be the Zappi, where you can tell zappi exactly how much power to consume. The other examples where power consumption may change over an normal operating cycle would not be considered semi continuous as you have no control. However my air conditioner has a demand response input that can limit power to fixed values of maximum power consumption; 0%, 50%, 75% and 100%. So in that case I treat my air conditioner as semi continuous and I switch demand response modes to match the EMHASS forecast. Screenshot_20221204-141125 864×1920 135 KB
----------------------------------------

【245楼】 - RatMondeo
回复时间: 2022-12-04T03:30:35.622Z
----------------------------------------
Thanks Mark that clears the definition up for me. I have just implemented DRED on my MHI RCAC so are interested in how your logic works with this. I will have a play with semi-continuous setting and look at the output then may get back to you if I get stuck. Thanks again for your time and guidance. . .
----------------------------------------

【246楼】 - RatMondeo
回复时间: 2022-12-04T04:22:20.418Z
----------------------------------------
Okay, I think my confusion is coming from the setting: treat_deferrable_load_as_semi_cont: false Is it correct that I only see the variable figures in the output table if I set this to false? If I set it to true, it only populates the table if the the value is above the load Wattage with the loads setting ie. 2200W. But you are saying you set the load as semi-continuous (TRUE) and then get data like 768W 900W etc etc .in order to fire the RCAC at certain thresholds. Sorry for a long winded response, but I have been going around in circles with this and are finally seeing the data produces, but is opposite to what you had said. . . Also, if it is semi continuous, then what Wattage do you use for your DRED RCAC in the: nominal_power_of_deferrable_loads: Any help appreciated …
----------------------------------------

【247楼】 - markpurcell
回复时间: 2022-12-04T04:28:06.890Z
----------------------------------------
Set to false for those loads you want to have continuous, ie something between 0W - 1000W. Set to true for those loads you out want to be semi continuous ie 0W or 1000W. Set the nominal load to whatever 100% consumption either what you have been able to measure from your AC or the input power rating on your device.
----------------------------------------

【248楼】 - RatMondeo
回复时间: 2022-12-04T05:00:22.862Z
----------------------------------------
Hi Mark, So with the RCAC set as semi-continuous TRUE, then EMHASS is only publishing the load if it reaches the threshold of the set load for the RCAC at say 2200W. (There is no 960W or 1150W published). So how are you triggering the different DRED Wattage levels if you are only getting a trigger from EMHASS at the full Watts of the RCAC? Thanks again
----------------------------------------

【249楼】 - markpurcell
回复时间: 2022-12-04T05:20:33.935Z
----------------------------------------
For your AC set to false. (I.e. it is not semi-continuous) Have a look at the automation I posted earlier which switches on different thresholds. I find unless your values are very close it will go straight from 0- max anyway.
----------------------------------------

【250楼】 - RatMondeo
回复时间: 2022-12-04T05:24:00.401Z
----------------------------------------
markpurcell: However my air conditioner has a demand response input that can limit power to fixed values of maximum power consumption; 0%, 50%, 75% and 100%. So in that case I treat my air conditioner as semi continuous and I switch demand response modes to match the EMHASS forecast. Okay, I think this is where my confusion is coming from as you said: “However my air conditioner has a demand response input that can limit power to fixed values of maximum power consumption; 0%, 50%, 75% and 100%. So in that case I treat my air conditioner as semi continuous and I switch demand response modes to match the EMHASS forecast.” So for my own information and clarity, is the AC set to false continuous or semi-continuous? Sorry, I need all the help I can get. Thanks Again
----------------------------------------

【251楼】 - RatMondeo
回复时间: 2022-12-04T05:25:28.045Z
----------------------------------------
Okay, So AC to False then read the variable loads and trigger from there? Thanks Again for your patience. .
----------------------------------------

【252楼】 - markpurcell
回复时间: 2022-12-04T05:31:35.874Z
----------------------------------------
No worries, it is complex to setup but once it is working it is worth the effort. See my AC forecasts here (in red) how it tracks down towards as the solar production reduces this afternoon and the the red forecast tracks back up tomorrow morning when my solar production increases. Screenshot_20221204-162742 864×510 259 KB
----------------------------------------

【253楼】 - markpurcell
回复时间: 2022-12-04T05:35:08.253Z
----------------------------------------
RatMondeo: case I treat my air conditioner as semi continuous Sorry my mistake, the AC should be treated as not semi continuous so false as it can take any continuous value from 0W - max W.
----------------------------------------

【254楼】 - RatMondeo
回复时间: 2022-12-04T05:49:45.897Z
----------------------------------------
Ah Yes, I stole your Apex chart settings and have this interesting result. Deferrable0 will be my RCAC. I am set for self-consumption. So the big spike in load power forecast in blue tomorrow - is that a base load prediction based on data from the last couple of days? Also seeing the stepping of the RCAC tomorrow, as you noted. . . Thanks
----------------------------------------

【255楼】 - markpurcell
回复时间: 2022-12-04T06:05:16.058Z
----------------------------------------
Excellent, I can see you AC stepping down this afternoon and then stepping back up again tomorrow morning. I would recommend the use of notifications/ logging in your deferrable automation so you can understand in real time what it is doing. The spike in your blue line would be something you ran today (maybe your AC), so EMHASS just assumes you will run the same amount and time tomorrow. The smarts is there you can see your AC drop to zero for that 30 minutes because it is expecting something else to be consuming at that time. This naive model, just assuming base load will be the same pattern the following days is actually one of the limitations of Amber SmartShift (assume tomorrow will be the same pattern.) If your charge your EV one day because price is cheap that forecast load gets carried over to tomorrow. This gives reasonable results. EMHASS can do better, you should take your deferrable loads out of the sensor recording no_var_loads, so your AC load from today shouldn’t be appearing in the blue spike, so check if you need to remove it. So the blue line baseload should never reflect the deferrable loads from the day before. EMHASS also let’s you specify more that one days history so it can average out those spikes. Or you can also inject your own forecasts. I know @davidusb has also been working on an AI model for load forecasts.
----------------------------------------

【256楼】 - RatMondeo
回复时间: 2022-12-04T06:44:18.829Z
----------------------------------------
Got it!! I think the blue spike must have been the dryer, as that is no in my no_var_loads, whereas the aircon and dishwasher are. . … I am happy with where I have made it to with the base settings of EMHASS, next is to look at automations to use the data. I will also keep my eye on any AI or other predictive developments of the system. I was with Amber but could not keep up with the variability of the pricing in what is the most volatile time in our energy history, not that I disagree with a little volatility in these times of change. . . Thanks Again, I feel like I got somewhere today … . .
----------------------------------------

【257楼】 - davidusb
回复时间: 2022-12-04T09:22:51.865Z
----------------------------------------
I will hopefully resume my work on AI based load forecast very soon and then release a version of the add-on with smarter forecasts. Maybe before the end of this year
----------------------------------------

【258楼】 - RatMondeo
回复时间: 2022-12-12T00:20:05.629Z
----------------------------------------
Hi, Due to bad weather in Ballarat (it is supposed to be summer) I have seen an interesting plot today: I have noticed today that my p_deferrable1 (Dishwasher) (purple line) is split in two start times. This is set as 2000W for 1 Hour I think I am correct in reading my graph as two half hour allocations with a 2.5hr gap in-between. treat_deferrable_load_as_semi_cont: true How would I set this to be a single continuous time period required? Thanks Split Deferrable1 733×630 43.2 KB
----------------------------------------

【259楼】 - markpurcell
回复时间: 2022-12-12T01:03:32.559Z
----------------------------------------
Have a look at set_def_constant: set_def_constant: Define if we should set each deferrable load as a constant fixed value variable with just one startup for each optimization task. You can see from your graphic that splitting would be useful for something like a water heater that could start/ stop during the day. The set_def_constant is for something that should only startup once a day. Which would find the optimal 60 minute block to run your device. Of course your dishwasher is unlikely to utilise the full 2000W for the full 60 minutes. Mine has two power spikes during it’s cycle when it’s heater is operating. image 2271×716 17.5 KB
----------------------------------------

【260楼】 - RatMondeo
回复时间: 2022-12-12T02:42:22.668Z
----------------------------------------
Thanks Mark, Is there any value in having system/mechanism that could “record” the exact load profile of the dishwasher, as per your example. As I know mine does the same, likewise with the washing machine on a hot wash? I assume set_def_constant is only available from the command line. I am still working with the GUI at the moment. I will take a look . … Thanks Again
----------------------------------------

【261楼】 - markpurcell
回复时间: 2022-12-12T04:58:26.382Z
----------------------------------------
RatMondeo: Is there any value in having system/mechanism that could “record” the exact load profile of the dishwasher, as per your example. As I know mine does the same, likewise with the washing machine on a hot wash? I would think you would hit diminishing returns in trying to model it too finely. There are other variables like PV and your household baseload that will also vary, so I view EMHASS as always getting a pretty good, but not perfect optimisation. I assume set_def_constant is only available from the command line. I am still working with the GUI at the moment. I will take a look . … I haven’t actually used it, but you maybe able to set from the GUI if you edit in YAML mode?
----------------------------------------

【262楼】 - davidusb
回复时间: 2022-12-18T22:01:20.496Z
----------------------------------------
This variable set_def_constant cannot be set with the GUI but you can pass it inside your shell command. Look here: Intro / Quick start — emhass 0.3.21 documentation
----------------------------------------

【263楼】 - per.takman
回复时间: 2022-12-21T07:08:15.240Z
----------------------------------------
Hi Mark, I’m now up and running with my energy storage system. While preparing for it I discovered something that puzzled me that I hope you can shed some light on. When I started using EMHASS the config method_ts_round was set to nearest. This resulted in that publication of my forecast data into Home Assistant occurred every half hour (X:30) instead of at the top of the hour. In Sweden the price changes every hour sharp, which means that I want to adjust charge/discharge rates exactly then and not halfway into the hour. When I noticed this I tested both setting method_ts_round to last and first . I’ve been performing day ahead optimization 23:57 using next day data from Nordpool. What I found was the following: When method_ts_round = last I get a forecast starting right after midnight (as intended), but the published data into Home Assistant feed the forecast from next day already when the optimization is finished. This means that I would start the charge/discharge too early. When method_ts_round = first I get a forecast starting from 23:00 on the same day I ran the optimization (one hour early). This means that price data is shifted one hour as well so that won’t work. I’ve solved this by shifting starting my optimization 00:00:01. I also have to shift publishing new data some seconds forward to allow for the optimization to finish. My impression, from reading instructions and this forum, is that intended workflow is to perform optimization using future data a few minutes before midnight (or any other time for that matter) and that publishing data into Home Assistant should be triggered at the hour and not halfway into the hour. What I’m doing seems like a patch solution and I’d like to understand what I’m doing wrong. Could you let me know the best way to achieve the intended behavior that I can optimize ahead of time but get published forecast data into Home Assistant that is synchronized with my production schedule? Warmly, Per Takman
----------------------------------------

【264楼】 - per.takman
回复时间: 2022-12-21T23:57:04.615Z
----------------------------------------
I’ve done some further experimenting this evening and found a solution that seems more satisfying. I’ve reverted back to method_ts_round = nearest and send prices starting from the next hour when performing optimization. I’ve adjusted the automation for publishing into HA as below: alias: EMHASS publish data description: "" trigger: - platform: time_pattern minutes: "0" seconds: "0" condition: [] action: - service: shell_command.publish_data data: {} mode: single This seems to give me the data I want and there is no need to publish data until one hour later. I also simplified the automation for charge/discharge/idle. Below is an example for charge: alias: ESS battery - Charge description: "" trigger: - platform: state entity_id: - sensor.p_batt_forecast condition: - condition: numeric_state entity_id: sensor.p_batt_forecast below: 0 action: - service: ferroamp.charge data: target: 73b16e7f127cbe5b69e439fc15b0f9e4 power: "{{ -1*states('sensor.p_batt_forecast') |round(0) }}" mode: single I hope that by answering my own question helps somebody else eventually! Cheers, Per
----------------------------------------

【265楼】 - per.takman
回复时间: 2022-12-22T23:19:17.673Z
----------------------------------------
I’ve noticed that it is hard to follow the SOC forecast when charging the batteries of my Ferroamp ESS system. Has anybody found an elegant solution to compensating for slower actual charge rate as the batteries approach 100%? image 984×602 20.9 KB I’m considering trying out adding extra power during the charge cycle to get ahead of schedule slightly to make sure I reach full charge. Question: How does the charge/discharge efficiency configuration setting affect this? Any suggestions are welcome! Cheers, Per
----------------------------------------

【266楼】 - markpurcell
回复时间: 2022-12-23T01:30:54.945Z
----------------------------------------
Firstly, I think your battery following the SOC forecast closely is really good. I don’t have the fine controls on my powerwall to achieve that level of control. Before 0600 your SOC forecast is set at 100%, but your battery seems to stop at around 95% for at least a hour, so it might not be the slow charging at the top end, maybe something else stops at 95%. Are you able to charge to 100% in Home Assistant without EMHASS? Looking at your other multi hour steady state values there always seems to be around a 5% difference, maybe add 5% to your charging value? Anyway as I said your charge/ discharge cycle matching the forecast is very impressive.
----------------------------------------

【267楼】 - per.takman
回复时间: 2022-12-23T07:40:21.132Z
----------------------------------------
Thank you Mark for the feedback! The reason it never reached 100% was that the EMHASS forecast stopped charging the battery at 05:00. image 999×1257 43.3 KB It is possible to get 100% SOC if I control it from HA. I will increase by a percentage and see how it goes. Not sure yet whether this will be profitable or not, but the entertainment factor is very high. /Per
----------------------------------------

【269楼】 - per.takman
回复时间: 2022-12-24T07:38:54.296Z
----------------------------------------
My first experiment with increasing the charge power by 5% relative to the p_batt_forecast resulted in a charge state of 89%. I had also reduced the configuration variable battery_charge_power_max to 7600 W to more accurately reflect what seems to be achievable. image 978×1252 39.6 KB This morning I did an experiment where I set the charge power to 3000 W to see if the power would go down as it approaches 100% SOC. I did not see this up to 96% although the SOC change rate appears go down. I will experiment a bit further with increasing the charge power during the forecasted hours that we should be charging to see if this bring us closer to 100%. I guess another approach is to always charge as fast as possible when EMHASS suggest that charging is a good idea. Please let me know if what I’m trying to achieve is simply unrealistic. Cheers, Per
----------------------------------------

【270楼】 - per.takman
回复时间: 2022-12-25T08:08:32.492Z
----------------------------------------
New day… new data! Charging at the maximum rate took me to 98% SOC. I will try this out for a while now and see how well it works image 967×1240 35.9 KB Cheers, Per
----------------------------------------

【271楼】 - CommanderROR
回复时间: 2022-12-26T09:18:50.256Z
----------------------------------------
I installed Emhass a few days ago, but so far haven’t been able to really understand how it works. I hope I will be able to work out if this is the right project for me or not. My mid- to long-term plan is to use a dynamic energy tariff (like Tibber) and then try to optimise my useage as well as possible. For this I need the solar forecast, Tibber price forest, my PV battery “force charge from grid”, my (ordered but not yet delivered) heat pump “boost mode” for heating, cooling and hot water and of course my Tesla automated charging. This is a rather daunting project and I am still unsure whether this would best be handled with a set of Automations in HA, a separate management entity like EMHASS or possibly dedicated hardware.
----------------------------------------

【272楼】 - markpurcell
回复时间: 2022-12-26T12:13:06.440Z
----------------------------------------
Here is my setup, which looks similar to your own goals: Running Devices When Energy is Cheaper and Greener My advice is start simple with one device at a time and build up an understanding in Home Assistant. Once you have a base level of functionality working then move into the complexity of EMHASS.
----------------------------------------

【273楼】 - CommanderROR
回复时间: 2022-12-27T08:00:58.403Z
----------------------------------------
Thanks. I bookmarked your Thread and will take inspiration from there when I have made some progress on the basics. My current Challenge: I have an entity with the EPEX Prices for electricity for a 24h Timeframe. Sadly the Values are in a “list” (Hour 00-23) stuck in the “Attributes” section of that Entity. I am currently trying to find an elegant way of extracting that list, putting it in a “Min-Max-Med” helper and then using the “Min” as a trigger to grid-charge my PV Battery to SoC 100-“Solar Forecast Tomorrow”. The Grid-Charge and the SoC calculation seem to be functional, but the “extract and compute attributes” part is still a gordian knot.
----------------------------------------

【274楼】 - RT1080
回复时间: 2022-12-28T09:29:07.842Z
----------------------------------------
If you search the forum for entso-e and nordpool you will find many examples where the attributes are “manipulated” into boolean sensor (cheapest hours, cheapest consecutive hours etc). Not sure which api you use for your epex info but perhaps you can use this to reverse engineer something for your use case.
----------------------------------------

【275楼】 - CommanderROR
回复时间: 2022-12-28T20:19:33.281Z
----------------------------------------
Thanks. I have already made some progress with the Nordpool integration
----------------------------------------

【276楼】 - smi
回复时间: 2022-12-29T11:54:51.233Z
----------------------------------------
Hi everyone, I’m using EMHASS since several months and am optimizing the production of hot water in my heatpump which is working pretty good. I receive the prices per kwh which I receive for energy I put back into the grid each day at 02:00 p.m. for the following 24 hrs. Therefore, I’m running the day-ahead optimization at about 02:10 p.m. together with PV forecast data from solcast. While the published prices do not change, the PV forecast does and therefore it is not exact at the moment. How would I trigger the import of new PV forecast information without changing something on the prices? Unfortunately if I would import the prices for example at 04:00 p.m., the prices for the following day from 02:00 p.m. till 04:00 p.m. would be missing and therefore would mess up the optimzation. Then something different: I have several appliances which I could run using EMHASS: ACs, washing machine and so on. While the washing machine or the dryer are not needed every day and therefore I’m not yet ready to integrate them, I would like the ACs to start if some condititons are met: More PV energy produced then used while PV sales price is below X and there is a need to heat or cool the rooms (based on thermostats) Price for grid energy below Y while there is a need to hear or cool Price for grid energy below Z while more PV energy is produced then used and PV sales price is below Z and there is a need for heating / cooling and so on I could do most of those automations in node red but my question is if I could also do some of the optimization in EMHASS or at least on how it would not interfere with it (I guess I should add ACs to the sensor without variable loads then (as the water heatpump)) Thanks!
----------------------------------------

【277楼】 - sladey
回复时间: 2023-01-08T08:50:54.794Z
----------------------------------------
@davidusb was wondering how you are going with a more advanced approach to load forecasting? I have been looking at some similar projects and I came across GitHub - LBNL-ETA/DOPER: Distributed Optimal and Predictive Energy Resources . DOPER allows you to model EVs as batteries which means they support charging and discharging. This is a great forward looking feature given where we are going with Vehicle-to-home and Vehicle-to-grid. Would it be easy to add this capability to EMHASS. This involves: time series input representing the EV load (ie driving around) time series input representing when the EV is connected vs not connected. output that indicated when and EV should be charged and at what power Is this something that I can help add to EMHASS? I hope to get an EV (and charger) that supports V2G in the next 6 months or so.
----------------------------------------

【278楼】 - davidusb
回复时间: 2023-01-08T10:09:47.220Z
----------------------------------------
Hi advanced a little bit but didn’t had the time to put anything into the production code. What I did is to test the quality of results with a dataset containing even more data. What I found is that it may be a challenge to fit those PyTorch models on systems with no cuda support. So that’s a problem that I need to solve, I need to switch to more simple models and for decent results. That’s a very interesting module right there from LBNL. I think that you are right we should start looking to optimize V2G applications. I will take a deeper look at this and try to analyze how this may be integrated to EMHASS if this is a valuable option.
----------------------------------------

【279楼】 - torstein
回复时间: 2023-01-09T07:44:18.507Z
----------------------------------------
How are you optimizing the heat pump? On off periods or adjusting temperature?
----------------------------------------

【280楼】 - smi
回复时间: 2023-01-09T07:59:45.357Z
----------------------------------------
It is just running for a specified number of hours. It’s just to produce warm water, no air heating, therefore it works for that.
----------------------------------------

【281楼】 - smi
回复时间: 2023-01-11T11:07:23.104Z
----------------------------------------
I’m moving from Home Assistant OS (and therefore from the Add-On) to Docker on Synology. Therefore, also EMHASS will run in Docker in the future. Can I just take the current config file and put it in the mapped docker storage location or do I have to change anything? Thanks!
----------------------------------------

【282楼】 - davidusb
回复时间: 2023-01-11T12:43:15.359Z
----------------------------------------
Just on/off periods for now. What I will do in the near future is to add a simple model of a heat pump. I intend to use this article as the main reference: https://arxiv.org/pdf/2009.02349v2.pdf More information will need to be fetch from HA, notably the outdoor temperature and the technical specifications of the heat pump and the household thermal isolation. Is in the to do list…
----------------------------------------

【283楼】 - davidusb
回复时间: 2023-01-11T12:46:28.689Z
----------------------------------------
Take the example configuration file config_emhass.yaml from the github repository ( GitHub - davidusb-geek/emhass: emhass: Energy Management for Home Assistant, is a Python module designed to optimize your home energy interfacing with Home Assistant. ) and paste the variables that you configured on the add-on configuration pane. It is no sufficient to just use the add-on configuration in yaml format because there are other variables that are not accessible in the add-on version but are in the standalone docker container version. Other than that it should be straighforward, just follow the instructions on the documentation.
----------------------------------------

【284楼】 - torstein
回复时间: 2023-01-11T17:21:00.268Z
----------------------------------------
What about coral tpu?
----------------------------------------

【285楼】 - davidusb
回复时间: 2023-01-11T19:45:13.504Z
----------------------------------------
What do you mean? Tpu can be interesting IF you have a tpu capable device which will be 0.001% of Home Assistant users, so not a viable option.
----------------------------------------

【286楼】 - markpurcell
回复时间: 2023-01-11T20:43:08.467Z
----------------------------------------
I look forward to the heat pump modelling. Currently summer here so I see great correlation between solar PV production, low cost of electricity, high temperature and demand for cooling. The sunniest times of the day are also the hottest with the highest demand for cooling and the cheapest energy. Inside EMHASS I calculate def_total_hrs_hvac as the time the external temperature is above a comfort threshold. Screenshot_20230112-061842 864×1920 159 KB EMHASS then schedules my HVAC for cooling for times that are close to optimal from a comfort perspective. Screenshot_20230112-061817 864×1920 185 KB This method of scheduling doesn’t work for heating in the winter as the the correlation isn’t there. So for the winter case I take my heating out of deferrable load scheduling and let the thermostat control the call for heat and report the power consumption in EMHASS as power_load_no_var_loads.
----------------------------------------

【287楼】 - CommanderROR
回复时间: 2023-01-11T22:04:58.765Z
----------------------------------------
EMHASS always looks so cool…then I try to set it up myself and can’t even get past initial Setup… I could not find any way to link Emhass to my dynamic energy price entity…and that’s definitely basic information it needs to do it’s thing. But one of these days I will figure it out…perhaps…
----------------------------------------

【288楼】 - smi
回复时间: 2023-01-12T23:12:12.886Z
----------------------------------------
Thanks for you reply. Unfortunately I can not get it to run. I’m using a Synology NAS and its docker package. This does not seem to allow make and so on. Therefore, I changed the config_emhass.yaml and secrets_emhass.yaml on Ubuntu and then ran “make”. Then I took the resulting tar-file, uploaded it to the NAS and added it as an image in the Docker GUI. When I now try to run it (also via the GUI, setting the paths, timezone and LOCAL_COSTFUN), it does not work and docker log only shows some docker logos and a story. Any idea how I could get this to run on Synology? Thanks
----------------------------------------

【289楼】 - jensrohloff
回复时间: 2023-01-13T18:03:05.746Z
----------------------------------------
Hi Per, I’m trying your query with emhass by I’m getting an error as your list has 24 Entries and emhass seems to expect 24. may I ask how you are added the tibber data?
----------------------------------------

【290楼】 - per.takman
回复时间: 2023-01-13T18:19:29.959Z
----------------------------------------
Hi Jens, I’m sorry, but I don’t understand your question. I add 24 entries like you said and that is what EMHASS expects. Can you explain in more detail what problem you have? Cheers, Per
----------------------------------------

【291楼】 - jensrohloff
回复时间: 2023-01-13T18:26:43.634Z
----------------------------------------
Sure, I added your shell command which indeed returns the correct values in a list of 24. post_tibber_forecast: "curl -i -H \"Content-Type: application/json\" -X POST -d '{ \"prod_price_forecast\":[0.1998, 0.1812, 0.1717, 0.1634, 0.1641, 0.191, 0.2261, 0.2655, 0.287, 0.2807, 0.2738, 0.262, 0.252, 0.2445, 0.2485, 0.256, 0.2625, 0.2763, 0.2763, 0.2751, 0.262, 0.2524, 0.252, 0.2422], \"load_cost_forecast\":[0.1915, 0.2021, 0.2141, 0.21, 0.2094, 0.2094, 0.2146, 0.2242, 0.2232, 0.2254, 0.221, 0.2264, 0.2192, 0.191, 0.1769, 0.1717, 0.1717, 0.1741, 0.1772, 0.1691, 0.1717, 0.1717, 0.168, 0.1671] }' http://localhost:5000/action/dayahead-optim" But I get following error from emhass as it seems to expect 48. ERROR in utils: ERROR: The passed data is either not a list or the length is not correct, length should be 48 [2023-01-13 19:12:43,303] ERROR in utils: Passed type is &lt;class 'list'&gt; and length is 48
----------------------------------------

【292楼】 - per.takman
回复时间: 2023-01-13T19:13:21.444Z
----------------------------------------
I might be wrong, but I suspect that you need to adjust one of the configuration parameters in in EMHASS called optimization_time_step to 60. The default is 30 minutes, which is why EMHASS expect 48 values. I actually no longer use data from Tibber since I’ve found their integration too unstable to rely on it for EMHASS. I use data directly from Nordpool using GitHub - custom-components/nordpool: This component allows you to pull in the energy prices into Home-Assistant. . I add the following under sensor: in my sensors.yaml file that I include in my configuration.yaml file. # Nordpool - platform: nordpool VAT: True price_in_cents: false region: "SE3" precision: 3 additional_costs: "{{0.0|float}}" I use the data from Nordpool to create two template sensors that reflect the total price for consumption and production including network charges for transport over the grid. Note that these sensors will offer the next 24 forecast values starting from the next hour and that it combines todays prices with next day forecast. This allows me to optimize production at 21.57 every evening. I’ve found this to be more powerful than to simply send tomorrows 24 forecast right before midnight. I’ve also changed my configuration with EMHASS so that my energy storage aim for being depleted (0.15) instead of 0.60 for each cycle. With the price variations we typically see over a 24 h period I find this to be more rational, but you can also choose to optimize right before midnight if you find that it works better for you. - name: "Electricity consumption price 24h forecast" unique_id: electricity_consumption_price_24h_forecast state: &gt;- {% set data = state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'raw_today') | map(attribute='value') | list %} {% set values = namespace(all=[]) %} {% for i in range(now().hour+1,data | length) %} {% set v = ((data[i] | float(0) + 1.25*0.0875 + 0.75) | round(4)) %} {% set values.all = values.all + [ v ] %} {% endfor %} {% set data = state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'raw_tomorrow') | map(attribute='value') | list %} {% for i in range(data | length) %} {% set v = ((data[i] | float(0) + 1.25*0.0875 + 0.75) | round(4)) %} {% set values.all = values.all + [ v ] %} {% endfor %} {{ (values.all)[:24] }} availability: &gt; {{states('sensor.nordpool_kwh_se3_sek_3_10_025') not in ['unknown','unavailable']}} - name: "Electricity production price 24h forecast" unique_id: electricity_production_price_24h_forecast state: &gt;- {% set data = state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'raw_today') | map(attribute='value') | list %} {% set values = namespace(all=[]) %} {% for i in range(now().hour+1,data | length) %} {% set v = ((data[i] | float(0)/1.25 + 0.0725 + 0.6*0.555) | round(4)) %} {% set values.all = values.all + [ v ] %} {% endfor %} {% set data = state_attr('sensor.nordpool_kwh_se3_sek_3_10_025', 'raw_tomorrow') | map(attribute='value') | list %} {% for i in range(data | length) %} {% set v = ((data[i] | float(0)/1.25 + 0.0725 + 0.6*0.555) | round(4)) %} {% set values.all = values.all + [ v ] %} {% endfor %} {{ (values.all)[:24] }} availability: &gt; {{states('sensor.nordpool_kwh_se3_sek_3_10_025') not in ['unknown','unavailable']}} My shell_commands.yaml file included using shell_command: !include shell_commands.yaml in the configuration.yaml file has an entry as below: 24h_ahead_optim: 'curl -i -H ''Content-Type: application/json'' -X POST -d ''{"load_cost_forecast":{{( states.sensor.electricity_consumption_price_24h_forecast.state) }},"prod_price_forecast":{{( states.sensor.electricity_production_price_24h_forecast.state)}}}'' http://localhost:5000/action/dayahead-optim' I optimize using an automation as below: alias: EMHASS 24h-ahead optimization description: "" trigger: - platform: time at: "21:57:00" condition: [] action: - service: shell_command.24h_ahead_optim data: {} mode: single and publish using: alias: EMHASS publish data description: "" trigger: - platform: time_pattern minutes: "0" seconds: "0" condition: [] action: - service: shell_command.publish_data data: {} mode: single I hope this sorts out your problem! Cheers, Per
----------------------------------------

【293楼】 - davidusb
回复时间: 2023-01-13T20:38:40.311Z
----------------------------------------
I don’t have a Synology so I don’t know. If I understand well is a special Linux distro so thing may be different. What is your system architecture? Otherwise to avoid the need of the make command you can directly build your image with the commands inside the mk file and try if that works. Are you able to run any other docker images on that system. Do a first try with hello world
----------------------------------------

【294楼】 - smi
回复时间: 2023-01-13T20:54:27.878Z
----------------------------------------
It is a NAS and it runs Synology DSM, which is some linux kernel OS but from what I know there is not a lot known about it publicly. I can without problems run any containers which can be found under docker hub and I can also add other repositories via URL: image 893×682 34.9 KB After an image is downloaded, I can run it via the GUI and while doing so define things like port, TZ and so on. Doing anything like “make” can only either be done via ssh or on a different machine, then putting the generated container (don’t even know how I would call this, guess the resulting tar is what needs to be uploaded) into the NAS and then run it from there. Would it be possible to add EMHASS repository, pull the standard image and afterwards add the edited config files? Currently I have Node-Red, ESPHome, Home Assistant and zwavejs running as containers. Thanks
----------------------------------------

【295楼】 - markpurcell
回复时间: 2023-01-14T00:17:59.528Z
----------------------------------------
I’m really happy with this plan today from EMHASS. Screenshot_20230114-101250 864×1920 178 KB Screenshot_20230114-101303 864×1920 140 KB Unusually today I have very little variation between maximum and minimum prices during the day, so EMHASS isn’t trying to madly charge my battery to 100% and a nice balance of charging my EV (green) and running my air-conditioning (red).
----------------------------------------

【296楼】 - tpbradley
回复时间: 2023-01-14T16:07:55.699Z
----------------------------------------
Hi @davidusb , Firstly, many thanks for making this addon! I’m eager to get involved but I’m having a little difficulty and could do with some assistance. I’m running the latest version of Home Assistant and EMHASS on a raspberry pi 4. Home Assistant 2023.1.4 Supervisor 2022.12.1 Operating System 9.4 Frontend 20230110.0 - latest EMHASS: 0.2.23 EMHASS is configured like so hass_url: http://10.0.0.15:8123 long_lived_token: [redacted] costfun: profit optimization_time_step: 30 historic_days_to_retrieve: 2 method_ts_round: nearest set_total_pv_sell: false lp_solver: COIN_CMD lp_solver_path: /usr/bin/cbc sensor_power_photovoltaics: sensor.pv_power_w sensor_power_load_no_var_loads: sensor.power_load_no_var_loads In Home Assistant, I have created the pv_power_w and power_load_no_var_loads sensors and verified they have valid data. I can also retrieve this data via a call to the API like this http://10.0.0.15:8123/api/history/period/2023-01-14?filter_entity_id=sensor.power_load_no_var_loads&amp;minimal_response&amp;significant_changes_only The EMHASS web server is up and running and I can see the default data that comes with EMHASS. However, when running either optimisations I receive the following error. [2023-01-14 15:46:52,268] INFO in web_server: EMHASS server online, serving index.html... [2023-01-14 15:47:08,683] INFO in command_line: Setting up needed data [2023-01-14 15:47:08,762] INFO in retrieve_hass: Retrieve hass get data method initiated... [2023-01-14 15:47:08,766] ERROR in app: Exception on /action/perfect-optim [POST] Traceback (most recent call last): File "/usr/local/lib/python3.9/dist-packages/pandas/core/indexes/base.py", line 3803, in get_loc return self._engine.get_loc(casted_key) File "pandas/_libs/index.pyx", line 138, in pandas._libs.index.IndexEngine.get_loc File "pandas/_libs/index.pyx", line 165, in pandas._libs.index.IndexEngine.get_loc File "pandas/_libs/hashtable_class_helper.pxi", line 5745, in pandas._libs.hashtable.PyObjectHashTable.get_item File "pandas/_libs/hashtable_class_helper.pxi", line 5753, in pandas._libs.hashtable.PyObjectHashTable.get_item KeyError: 'sensor.power_load_no_var_loads' The above exception was the direct cause of the following exception: Traceback (most recent call last): File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 2525, in wsgi_app response = self.full_dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1822, in full_dispatch_request rv = self.handle_user_exception(e) File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1820, in full_dispatch_request rv = self.dispatch_request() File "/usr/local/lib/python3.9/dist-packages/flask/app.py", line 1796, in dispatch_request return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args) File "/usr/local/lib/python3.9/dist-packages/emhass/web_server.py", line 134, in action_call input_data_dict = set_input_data_dict(config_path, str(config_path.parent), costfun, File "/usr/local/lib/python3.9/dist-packages/emhass/command_line.py", line 68, in set_input_data_dict rh.prepare_data(retrieve_hass_conf['var_load'], load_negative = retrieve_hass_conf['load_negative'], File "/usr/local/lib/python3.9/dist-packages/emhass/retrieve_hass.py", line 177, in prepare_data self.df_final[var_load+'_positive'] = self.df_final[var_load] File "/usr/local/lib/python3.9/dist-packages/pandas/core/frame.py", line 3804, in __getitem__ indexer = self.columns.get_loc(key) File "/usr/local/lib/python3.9/dist-packages/pandas/core/indexes/base.py", line 3805, in get_loc raise KeyError(key) from err KeyError: 'sensor.power_load_no_var_loads' Any thoughts on where I could be going wrong? Cheers
----------------------------------------

【297楼】 - davidusb
回复时间: 2023-01-14T16:35:24.162Z
----------------------------------------
Hi, Everything seems ok to me. What may happen sometimes is that you just need to wait for the history recorder to record enough data for the power_load_no_var_loads sensor. So try again when you have at least 48h of data on that sensor.
----------------------------------------

【298楼】 - theailer
回复时间: 2023-01-14T16:47:14.383Z
----------------------------------------
That was the exact issue that I stumbled into as well in the beginning Pulled my hair for a bit before realising.
----------------------------------------

【299楼】 - tpbradley
回复时间: 2023-01-14T17:25:30.306Z
----------------------------------------
Thanks guys, I did see comments about this so waited a while for the data to come in. However, I’m still getting the same error with 9 days worth of data in the sensor now.
----------------------------------------

【300楼】 - torstein
回复时间: 2023-01-14T17:27:37.218Z
----------------------------------------
Why cant we publish prices the same way as the no load vars and pv2 sensor with date and time into emhass instead of the eai its done today? Kind of irritating when experimenting that all the values comes in the wrong place when they do not includes date and time?
----------------------------------------

【301楼】 - smi
回复时间: 2023-01-18T06:42:52.750Z
----------------------------------------
Hi @davidusb do you have any idea about this? I once more tried loading the tar file and runnning the container, both via CLI and GUI. Unfortunately both variants are not working. Would it be possible to get a compiled tar file of EMHASS? Maybe the make part is the issue on my side. Thank you very much!
----------------------------------------

【302楼】 - davidusb
回复时间: 2023-01-18T07:42:11.450Z
----------------------------------------
Hi Tom. Are you able to get a history plot of those 9 days for sensor.power_load_no_var_loads ?
----------------------------------------

【303楼】 - davidusb
回复时间: 2023-01-18T07:55:37.872Z
----------------------------------------
Hi. Ok just forget about the tar file. If you have docker installed and already running some containers then the docker build command should work just fine. This will build your image and then just can just docker run that image. So ssh into your system and then go to the emhass repository and do something like this: docker build -t emhass/core:v0.3.21 -f Dockerfile . Then run this image as: docker run -it --restart always -p 5000:5000 -e "LOCAL_COSTFUN=profit" -v $(pwd)/config_emhass.yaml:/app/config_emhass.yaml -v $(pwd)/secrets_emhass.yaml:/app/secrets_emhass.yaml --name DockerEMHASS emhass/core:v0.3.21 I that doesn’t work then what are the error messages? As a last resort I can push a builded image to dockerhub but it will be architecture dependent, so it is not the best option.
----------------------------------------
